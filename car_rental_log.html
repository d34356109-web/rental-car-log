<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç§Ÿè»Šäº¤è»Šç´€éŒ„ç³»çµ±</title>
    <!-- è¼‰å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ä½¿ç”¨ Inter å­—é«” */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }
        /* è‡ªå®šç¾©æ»¾å‹•æ¢æ¨£å¼ï¼Œè®“è¡¨æ ¼æ›´å¥½çœ‹ */
        /* åœ¨è¡Œå‹•è£ç½®ä¸Šï¼Œæˆ‘å€‘ä¸»è¦ä½¿ç”¨å¡ç‰‡ä½ˆå±€ï¼Œé¿å…æ°´å¹³æ»¾å‹• */
        .log-container::-webkit-scrollbar {
            height: 8px;
        }
        .log-container::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }
        .log-container::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
        /* äº¤è»Šå’Œæ”¶è»Šçš„é¡è‰²æ¨™è¨˜ */
        .delivery-color { background-color: #e0f2f1; color: #0f766e; } /* æ·ºé’ç¶  */
        .collection-color { background-color: #fef3c7; color: #a16207; } /* æ·ºé‡‘é»ƒ */
    </style>
</head>
<body class="p-4 md:p-8">

    <!-- ä¸»å®¹å™¨ -->
    <div class="max-w-7xl mx-auto">
        <header class="mb-8 p-4 bg-white shadow-lg rounded-xl">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">ç§Ÿè»Šäº¤è»Šç´€éŒ„æ§ç®¡ä¸­å¿ƒ</h1>
            <p class="text-gray-500">ä½¿ç”¨ Firestore å„²å­˜ç´€éŒ„ï¼Œè³‡æ–™å³æ™‚åŒæ­¥ã€‚ç•¶å‰ä½¿ç”¨è€… ID: <span id="user-id-display" class="font-mono text-xs bg-gray-100 p-1 rounded">è¼‰å…¥ä¸­...</span></p>
        </header>

        <!-- è¨Šæ¯/è¼‰å…¥æŒ‡ç¤ºå™¨ -->
        <div id="message-box" class="mb-6 p-3 rounded-lg text-sm transition-all duration-300 hidden"></div>

        <!-- æ–°å¢ç´€éŒ„è¡¨å–® (è¡Œå‹•è£ç½®ä¸Šç‚ºå–®æ¬„ï¼Œå¹³æ¿ä»¥ä¸Šç‚ºä¸‰æ¬„) -->
        <div class="bg-white p-6 shadow-xl rounded-xl mb-10">
            <h2 class="text-xl font-semibold text-gray-700 mb-4 border-b pb-2">æ–°å¢äº¤è»Š/æ”¶è»Šç´€éŒ„</h2>
            <form id="record-form" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                
                <!-- æ—¥æœŸèˆ‡æ™‚é–“ -->
                <div>
                    <label for="record-date" class="block text-sm font-medium text-gray-700">æ—¥æœŸ</label>
                    <input type="date" id="record-date" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border focus:border-indigo-500 focus:ring-indigo-500">
                </div>
                <div>
                    <label for="record-time" class="block text-sm font-medium text-gray-700">æ™‚é–“</label>
                    <input type="time" id="record-time" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border focus:border-indigo-500 focus:ring-indigo-500">
                </div>

                <!-- å‹•ä½œ (äº¤è»Š/æ”¶è»Š) -->
                <div>
                    <label for="record-action" class="block text-sm font-medium text-gray-700">å‹•ä½œ</label>
                    <select id="record-action" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border focus:border-indigo-500 focus:ring-indigo-500">
                        <option value="äº¤è»Š">äº¤è»Š (Delivery)</option>
                        <option value="æ”¶è»Š">æ”¶è»Š (Collection)</option>
                    </select>
                </div>

                <!-- åœ°é»èˆ‡è»Šç‰Œ -->
                <div class="md:col-span-2">
                    <label for="record-location" class="block text-sm font-medium text-gray-700">åœ°é»</label>
                    <input type="text" id="record-location" placeholder="ä¾‹å¦‚: æˆç”°æ©Ÿå ´(BR198) T1" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border focus:border-indigo-500 focus:ring-indigo-500">
                </div>
                <div>
                    <label for="record-plate" class="block text-sm font-medium text-gray-700">è»Šç‰Œ</label>
                    <input type="text" id="record-plate" placeholder="ä¾‹å¦‚: 3333" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border focus:border-indigo-500 focus:ring-indigo-500">
                </div>
                
                <!-- éœ€æ±‚/å‚™è¨» -->
                <div class="md:col-span-3">
                    <label for="record-notes" class="block text-sm font-medium text-gray-700">éœ€æ±‚ / å‚™è¨» (åŒ…å«å…’ç«¥åº§æ¤…ã€è»Šå‹ç­‰)</label>
                    <textarea id="record-notes" rows="2" placeholder="ä¾‹å¦‚: å…©å¼µå…’ç«¥åº§æ¤…(2æ­²è·Ÿ5æ­²)ï¼›è»Šå‹: Toyota 40ç³»" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border focus:border-indigo-500 focus:ring-indigo-500"></textarea>
                </div>

                <!-- æäº¤æŒ‰éˆ• -->
                <div class="md:col-span-3 flex justify-end">
                    <button type="submit" id="submit-button" class="mt-4 px-6 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition duration-150 disabled:bg-indigo-400">
                        å„²å­˜ç´€éŒ„
                    </button>
                </div>
            </form>
        </div>

        <!-- ç´€éŒ„åˆ—è¡¨èˆ‡æŸ¥è©¢ -->
        <div class="bg-white p-6 shadow-xl rounded-xl">
            <h2 class="text-xl font-semibold text-gray-700 mb-4 border-b pb-2">æ‰€æœ‰ç´€éŒ„</h2>
            
            <!-- æŸ¥è©¢/æ’åºæ§åˆ¶é … -->
            <div class="flex flex-col sm:flex-row gap-4 mb-4">
                <input type="text" id="search-input" placeholder="æŸ¥è©¢ï¼šè¼¸å…¥åœ°é»ã€è»Šç‰Œã€å‚™è¨»é—œéµå­—" class="flex-grow p-2 border rounded-lg focus:border-indigo-500">
                <button id="sort-button" class="p-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition duration-150 flex-shrink-0">
                    <span id="sort-icon">ğŸ“…</span> æ’åº: ç”±æ–°åˆ°èˆŠ
                </button>
            </div>

            <!-- ç´€éŒ„è¡¨æ ¼å®¹å™¨ -->
            <div class="log-container overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <!-- åœ¨å°è¢å¹•ä¸Šéš±è—è¡¨æ ¼æ¨™é ­ï¼Œæ”¹ç”¨å¡ç‰‡ä½ˆå±€ -->
                    <thead class="bg-gray-50 sticky top-0 hidden sm:table-header-group">
                        <tr>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">æ—¥æœŸ/æ™‚é–“</th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">å‹•ä½œ</th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">åœ°é»</th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">è»Šç‰Œ</th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">éœ€æ±‚ / å‚™è¨»</th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="records-table-body" class="bg-white divide-y divide-gray-200">
                        <!-- ç´€éŒ„å°‡æœƒå‹•æ…‹è¼‰å…¥æ­¤è™• -->
                    </tbody>
                </table>
                <p id="no-records-message" class="text-center py-10 text-gray-500 hidden">ç›®å‰æ²’æœ‰ä»»ä½•ç´€éŒ„ã€‚</p>
            </div>
        </div>

    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, deleteDoc, doc, setLogLevel, Timestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // è¨­å®š Firebase Debug Log
        setLogLevel('Debug');

        // =================================================================
        // *** æ‚¨çš„ Firebase å°ˆæ¡ˆé…ç½®å·²æˆåŠŸè¼‰å…¥ï¼ ***
        // =================================================================
        const firebaseConfig = {
            apiKey: "AIzaSyAqksNR1a1Tf4OgL8X2ezT8u5rlFygNHPc",
            authDomain: "rentalcarlog-app.firebaseapp.com",
            projectId: "rentalcarlog-app",
            storageBucket: "rentalcarlog-app.firebasestorage.app",
            messagingSenderId: "68461236293",
            appId: "1:68461236293:web:2ab0179cc52585ab74932c",
            measurementId: "G-C7LWGH36JY"
        };
        const YOUR_PROJECT_ID = "rentalcarlog-app"; 
        // =================================================================

        let app;
        let db;
        let auth;
        let userId = null;
        let isAuthReady = false;
        let allRecords = []; // å„²å­˜å¾ Firestore ç²å–çš„æ‰€æœ‰ç´€éŒ„
        let sortDirection = 'desc'; // 'desc' (æ–°åˆ°èˆŠ) æˆ– 'asc' (èˆŠåˆ°æ–°)

        const messageBox = document.getElementById('message-box');
        const recordsTableBody = document.getElementById('records-table-body');
        const noRecordsMessage = document.getElementById('no-records-message');
        const userIdDisplay = document.getElementById('user-id-display');
        const sortButton = document.getElementById('sort-button');
        const sortIcon = document.getElementById('sort-icon');

        /** é¡¯ç¤ºæ‡‰ç”¨ç¨‹å¼è¨Šæ¯ */
        function displayMessage(text, type = 'info') {
            messageBox.textContent = text;
            messageBox.className = 'mb-6 p-3 rounded-lg text-sm transition-all duration-300';
            messageBox.classList.remove('hidden');

            switch (type) {
                case 'success':
                    messageBox.classList.add('bg-green-100', 'text-green-800');
                    break;
                case 'error':
                    messageBox.classList.add('bg-red-100', 'text-red-800');
                    break;
                case 'info':
                default:
                    messageBox.classList.add('bg-blue-100', 'text-blue-800');
                    break;
            }

            setTimeout(() => {
                messageBox.classList.add('hidden');
            }, 5000);
        }

        // --- Firebase åˆå§‹åŒ–å’Œèªè­‰ ---
        function initFirebase() {
            const submitButton = document.getElementById('submit-button'); // å–å¾—æŒ‰éˆ•å…ƒç´ 
            
            try {
                // é€™è£¡ä¸å†éœ€è¦æª¢æŸ¥ placeholderï¼Œå› ç‚ºè¨­å®šå·²ç¶“å¯«æ­»
                
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                // èªè­‰ç‹€æ…‹è®Šæ›´ç›£è½
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        userIdDisplay.textContent = userId;
                        isAuthReady = true;
                        submitButton.disabled = false; // èªè­‰æˆåŠŸï¼Œå•Ÿç”¨æŒ‰éˆ•
                        console.log("Firebase èªè­‰å®Œæˆï¼ŒUser ID:", userId);
                        fetchRecords(); // èªè­‰å®Œæˆå¾Œé–‹å§‹ç›£è½ç´€éŒ„
                    } else {
                        // é‹è¡Œåœ¨æœ¬åœ°ç’°å¢ƒï¼Œæˆ‘å€‘ä½¿ç”¨æ¨™æº–çš„åŒ¿åç™»å…¥
                        try {
                             await signInAnonymously(auth);
                        } catch (error) {
                            console.error("èªè­‰å¤±æ•—:", error);
                            displayMessage("èªè­‰å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ– Firebase å°ˆæ¡ˆè¨­å®šã€‚", 'error');
                            submitButton.disabled = true; // èªè­‰å¤±æ•—ï¼Œç¦ç”¨æŒ‰éˆ•
                            userIdDisplay.textContent = 'èªè­‰å¤±æ•— (é€£ç·šç•°å¸¸)'; 
                            isAuthReady = true; 
                        }
                    }
                });

            } catch (e) {
                console.error("Firebase åˆå§‹åŒ–å¤±æ•—:", e);
                displayMessage(`Firebase åˆå§‹åŒ–å¤±æ•—ã€‚éŒ¯èª¤è¨Šæ¯: ${e.message}ã€‚ç„¡æ³•å„²å­˜ç´€éŒ„ã€‚`, 'error'); 
                submitButton.disabled = true; // ç¦ç”¨æŒ‰éˆ•
                userIdDisplay.textContent = 'åˆå§‹åŒ–éŒ¯èª¤'; 
                isAuthReady = true;
            }
        }

        /** ç²å– Firestore Collection Path */
        function getCollectionPath() {
            // ç•¶åœ¨æœ¬åœ°é‹è¡Œæ™‚ï¼Œæˆ‘å€‘ä½¿ç”¨ä¸€å€‹å›ºå®šçš„ App ID ä¾†å„²å­˜æ‚¨çš„ç§äººè³‡æ–™ã€‚
            const localAppId = 'local-rental-app-private'; 
            // è·¯å¾‘æ ¼å¼: /artifacts/local-rental-app-private/users/{userId}/rental_records
            return `artifacts/${localAppId}/users/${userId}/rental_records`;
        }


        // --- è³‡æ–™æ“ä½œ (CRUD) ---

        /** æ–°å¢ç´€éŒ„åˆ° Firestore */
        async function addRecord(event) {
            event.preventDefault();
            // æª¢æŸ¥ Firebase æ˜¯å¦æˆåŠŸåˆå§‹åŒ– (dbå­˜åœ¨) ä¸”ç”¨æˆ¶å·²èªè­‰
            if (!db || !userId) {
                // è¨Šæ¯å„ªåŒ–: é»å‡ºé€£ç·š/èªè­‰å•é¡Œ
                displayMessage("è³‡æ–™åº«é€£ç·šæˆ–ç”¨æˆ¶èªè­‰å¤±æ•—ï¼Œç„¡æ³•å„²å­˜ç´€éŒ„ã€‚è«‹æª¢æŸ¥è¨­å®šæˆ–é‡æ–°è¼‰å…¥ã€‚", 'error');
                return;
            }

            document.getElementById('submit-button').disabled = true;

            const date = document.getElementById('record-date').value;
            const time = document.getElementById('record-time').value;
            const action = document.getElementById('record-action').value;
            const location = document.getElementById('record-location').value;
            const plate = document.getElementById('record-plate').value;
            const notes = document.getElementById('record-notes').value || '';

            // å°‡æ—¥æœŸå’Œæ™‚é–“åˆä½µç‚ºä¸€å€‹å®Œæ•´çš„ ISO å­—ä¸²ï¼Œä¸¦è½‰æ›ç‚º Firestore Timestamp
            const dateTimeString = `${date}T${time}:00`;
            const recordTime = new Date(dateTimeString);
            
            if (isNaN(recordTime)) {
                displayMessage("æ—¥æœŸæˆ–æ™‚é–“æ ¼å¼ç„¡æ•ˆã€‚", 'error');
                document.getElementById('submit-button').disabled = false;
                return;
            }

            const newRecord = {
                date: date, // å„²å­˜åŸå§‹æ—¥æœŸå­—ä¸²
                time: time, // å„²å­˜åŸå§‹æ™‚é–“å­—ä¸²
                action: action,
                location: location,
                plate: plate,
                notes: notes,
                timestamp: Timestamp.fromDate(recordTime) // å„²å­˜æ™‚é–“æˆ³è¨˜ç”¨æ–¼æ’åº
            };

            try {
                const collectionRef = collection(db, getCollectionPath());
                await addDoc(collectionRef, newRecord);
                displayMessage("ç´€éŒ„å„²å­˜æˆåŠŸï¼", 'success');
                document.getElementById('record-form').reset();
            } catch (e) {
                console.error("æ–°å¢æ–‡ä»¶æ™‚ç™¼ç”ŸéŒ¯èª¤:", e);
                displayMessage(`å„²å­˜å¤±æ•—: ${e.message}`, 'error');
            } finally {
                document.getElementById('submit-button').disabled = false;
            }
        }

        /** åˆªé™¤ç´€éŒ„ */
        async function deleteLogRecord(id) {
            // æª¢æŸ¥ Firebase æ˜¯å¦æˆåŠŸåˆå§‹åŒ– (dbå­˜åœ¨) ä¸”ç”¨æˆ¶å·²èªè­‰
            if (!db || !userId) {
                // è¨Šæ¯å„ªåŒ–: é»å‡ºé€£ç·š/èªè­‰å•é¡Œï¼Œä¸¦ä½¿ç”¨ 'error' é¡å‹
                displayMessage("æ‡‰ç”¨ç¨‹å¼åˆå§‹åŒ–å¤±æ•—æˆ–èªè­‰æœªå®Œæˆï¼Œç„¡æ³•åŸ·è¡Œåˆªé™¤æ“ä½œã€‚", 'error');
                return;
            }
            
            // ä½¿ç”¨è‡ªå®šç¾©æ¨¡æ…‹æ¡†å–ä»£ alert/confirm
            const confirmation = confirm(`ç¢ºå®šè¦åˆªé™¤é€™ç­† ID ç‚º ${id.substring(0, 8)}... çš„ç´€éŒ„å—ï¼Ÿ`);
            if (!confirmation) return;

            try {
                const docRef = doc(db, getCollectionPath(), id);
                await deleteDoc(docRef);
                displayMessage("ç´€éŒ„å·²åˆªé™¤ã€‚", 'success');
            } catch (e) {
                console.error("åˆªé™¤æ–‡ä»¶æ™‚ç™¼ç”ŸéŒ¯èª¤:", e);
                displayMessage(`åˆªé™¤å¤±æ•—: ${e.message}`, 'error');
            }
        }
        
        // --- è³‡æ–™é¡¯ç¤ºèˆ‡ç›£è½ ---

        /** æ¸²æŸ“ç´€éŒ„åˆ—è¡¨ */
        function renderRecords(records) {
            recordsTableBody.innerHTML = '';
            
            if (records.length === 0) {
                noRecordsMessage.classList.remove('hidden');
                return;
            }

            noRecordsMessage.classList.add('hidden');

            // æ ¹æ“š sortDirection æ’åº
            const sortedRecords = [...records].sort((a, b) => {
                const timeA = a.timestamp.toDate().getTime();
                const timeB = b.timestamp.toDate().getTime();
                
                if (sortDirection === 'desc') {
                    return timeB - timeA; // æ–°åˆ°èˆŠ
                } else {
                    return timeA - timeB; // èˆŠåˆ°æ–°
                }
            });

            // åŸ·è¡ŒæŸ¥è©¢éæ¿¾
            const searchTerm = document.getElementById('search-input').value.toLowerCase().trim();
            const filteredRecords = sortedRecords.filter(record => {
                if (!searchTerm) return true;
                return (
                    record.location.toLowerCase().includes(searchTerm) ||
                    record.plate.toLowerCase().includes(searchTerm) ||
                    record.notes.toLowerCase().includes(searchTerm) ||
                    record.action.toLowerCase().includes(searchTerm)
                );
            });


            filteredRecords.forEach(record => {
                const actionClass = record.action === 'äº¤è»Š' ? 'delivery-color' : 'collection-color';
                
                // é‡å°æ‰‹æ©Ÿç•«é¢ (sm: ä»¥ä¸‹) èª¿æ•´ä½ˆå±€ç‚ºå¡ç‰‡å¼
                const row = document.createElement('tr');
                // åœ¨æ‰‹æ©Ÿä¸Šæ˜¯ block/cardï¼Œå¹³æ¿ä»¥ä¸Šæ˜¯ table-row
                row.className = "mb-4 sm:mb-0 block sm:table-row border border-gray-200 sm:border-0 rounded-lg shadow-md sm:shadow-none p-3 sm:p-0 transition duration-200 hover:shadow-lg sm:hover:shadow-none";
                
                // åœ¨æ‰‹æ©Ÿä¸Šæ¯å€‹ TD éƒ½è®Šæˆ blockï¼Œä¸¦åŠ ä¸Šæ¨™ç±¤ (sm:hidden)
                row.innerHTML = `
                    <td class="px-3 py-1 sm:py-3 whitespace-nowrap text-sm text-gray-900 block sm:table-cell border-b sm:border-0">
                        <span class="sm:hidden font-medium text-gray-500 mr-2">æ—¥æœŸ/æ™‚é–“:</span>
                        <span class="font-bold">${record.date}</span><br>
                        <span class="text-xs text-gray-500">${record.time}</span>
                    </td>
                    <td class="px-3 py-1 sm:py-3 whitespace-nowrap text-sm font-semibold block sm:table-cell border-b sm:border-0">
                        <span class="sm:hidden font-medium text-gray-500 mr-2">å‹•ä½œ:</span>
                        <span class="px-2 py-1 rounded-full text-xs ${actionClass}">${record.action}</span>
                    </td>
                    <td class="px-3 py-1 sm:py-3 text-sm text-gray-700 max-w-xs block sm:table-cell border-b sm:border-0">
                        <span class="sm:hidden font-medium text-gray-500 mr-2">åœ°é»:</span>
                        ${record.location}
                    </td>
                    <td class="px-3 py-1 sm:py-3 whitespace-nowrap text-sm font-mono text-gray-900 block sm:table-cell border-b sm:border-0">
                        <span class="sm:hidden font-medium text-gray-500 mr-2">è»Šç‰Œ:</span>
                        ${record.plate}
                    </td>
                    <td class="px-3 py-1 sm:py-3 text-sm text-gray-500 max-w-md block sm:table-cell border-b sm:border-0">
                        <span class="sm:hidden font-medium text-gray-500 mr-2">å‚™è¨»:</span>
                        ${record.notes}
                    </td>
                    <td class="px-3 py-1 sm:py-3 whitespace-nowrap text-sm font-medium block sm:table-cell text-right sm:text-left">
                        <button onclick="window.deleteLogRecord('${record.id}')" class="text-red-600 hover:text-red-900 transition duration-150">åˆªé™¤</button>
                    </td>
                `;
                recordsTableBody.appendChild(row);
            });

            if (filteredRecords.length === 0 && searchTerm) {
                noRecordsMessage.textContent = 'æ‰¾ä¸åˆ°ç¬¦åˆæŸ¥è©¢æ¢ä»¶çš„ç´€éŒ„ã€‚';
                noRecordsMessage.classList.remove('hidden');
            } else if (filteredRecords.length === 0) {
                noRecordsMessage.textContent = 'ç›®å‰æ²’æœ‰ä»»ä½•ç´€éŒ„ã€‚';
                noRecordsMessage.classList.remove('hidden');
            }
        }

        /** å¾ Firestore ç›£è½ç´€éŒ„çš„å¯¦æ™‚æ›´æ–° */
        function fetchRecords() {
            if (!db || !userId) return;

            const collectionRef = collection(db, getCollectionPath());
            
            // ä½¿ç”¨ onSnapshot å¯¦æ™‚ç›£è½
            onSnapshot(collectionRef, (snapshot) => {
                const records = [];
                snapshot.forEach((doc) => {
                    records.push({ id: doc.id, ...doc.data() });
                });
                allRecords = records; // æ›´æ–°å…¨å±€ç´€éŒ„åˆ—è¡¨
                renderRecords(allRecords);
                console.log("è³‡æ–™å·²æ›´æ–°:", records.length, "ç­†ç´€éŒ„");
            }, (error) => {
                console.error("ç›£è½ç´€éŒ„æ™‚ç™¼ç”ŸéŒ¯èª¤:", error);
                displayMessage("è¼‰å…¥ç´€éŒ„å¤±æ•—ï¼Œè«‹æª¢æŸ¥æ¬Šé™ã€‚", 'error');
            });
        }
        
        // --- äº‹ä»¶ç›£è½å™¨ ---

        document.addEventListener('DOMContentLoaded', () => {
            initFirebase();
            document.getElementById('record-form').addEventListener('submit', addRecord);
            
            // å°‡ JS å‡½æ•¸æš´éœ²çµ¦ HTMLï¼Œä»¥ä¾¿åœ¨è¡Œå…§äº‹ä»¶ä¸­ä½¿ç”¨ (å¦‚åˆªé™¤æŒ‰éˆ•)
            window.deleteLogRecord = deleteLogRecord; 
            
            // æŸ¥è©¢è¼¸å…¥ç›£è½ï¼Œå¯¦æ™‚éæ¿¾
            document.getElementById('search-input').addEventListener('input', () => renderRecords(allRecords));

            // æ’åºæŒ‰éˆ•åˆ‡æ›
            sortButton.addEventListener('click', () => {
                sortDirection = sortDirection === 'desc' ? 'asc' : 'desc';
                sortIcon.textContent = sortDirection === 'desc' ? 'ğŸ“…' : 'ğŸ“†';
                sortButton.innerHTML = `<span id="sort-icon">${sortIcon.textContent}</span> æ’åº: ç”±${sortDirection === 'desc' ? 'æ–°åˆ°èˆŠ' : 'èˆŠåˆ°æ–°'}`;
                renderRecords(allRecords); // é‡æ–°æ¸²æŸ“ä»¥æ‡‰ç”¨æ–°çš„æ’åº
            });

            // åˆå§‹åŒ–æ—¥æœŸè¼¸å…¥æ¡†ç‚ºä»Šå¤©
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('record-date').value = today;
        });

    </script>
</body>
</html>
