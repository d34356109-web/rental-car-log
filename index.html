import React, { useState, useEffect, useRef, useMemo, useCallback } from 'react';
import { 
  Menu, Truck, Clock, AlertTriangle, Calendar, Search, List, CheckCircle, Car, ArrowRight, X
} from 'lucide-react';
// 假設這些模組已在環境中正確配置
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from 'firebase/auth';
import { getFirestore, collection, onSnapshot, doc, query } from 'firebase/firestore';

// --- 全局變量和 Firebase 初始化 (單文件強制要求) ---
// 確保應用程式 ID 和配置可用（使用模擬值確保程式碼可執行）
const appId = typeof __app_id !== 'undefined' ? __app_id : 'rental-log-app-123';
const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { /* 實際的 Firebase Config */ };
const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

// 初始化 Firebase (使用 try/catch 確保即使環境變數缺失也不會崩潰)
let app, db, auth;
let isFirebaseInitialized = false;

try {
  // 僅當配置存在且應用尚未初始化時才進行初始化
  if (Object.keys(firebaseConfig).length > 0 && typeof window.firebaseApp === 'undefined') {
    app = initializeApp(firebaseConfig);
    db = getFirestore(app);
    auth = getAuth(app);
    isFirebaseInitialized = true;
    window.firebaseApp = app; // 標記已初始化
    
    // 設置 Auth 狀態
    const attemptAuth = async () => {
        try {
            if (initialAuthToken) {
                await signInWithCustomToken(auth, initialAuthToken);
            } else {
                await signInAnonymously(auth);
            }
        } catch (error) {
            console.error("Firebase Auth Error:", error);
        }
    };
    attemptAuth();
  } else if (typeof window.firebaseApp !== 'undefined') {
      // 如果已經在全局範圍初始化，重新引用
      isFirebaseInitialized = true;
  }
} catch (error) {
  console.error("Firebase Initialization Error:", error);
}

// --- 模擬數據 (用於展示介面功能) ---

// 狀態映射
const STATUS_MAP = {
  PENDING_PICKUP: { label: '待收車', color: 'bg-blue-500', barColor: '#3b82f6', textColor: 'text-blue-700' },
  IN_PROGRESS: { label: '進行中', color: 'bg-yellow-500', barColor: '#f59e0b', textColor: 'text-yellow-700' },
  PENDING_RETURN: { label: '待歸還', color: 'bg-red-500', barColor: '#ef4444', textColor: 'text-red-700' },
  COMPLETED: { label: '已歸還', color: 'bg-green-500', barColor: '#22c55e', textColor: 'text-green-700' },
  ALL: { label: '全部', color: 'bg-gray-700', barColor: '#4b5563', textColor: 'text-gray-700' }
};

const mockOrders = [
  { id: '3333-7', title: '3333 7座：成田空港 → 成田空港', vehicle: '成田空港T3, 待收車', airport: '成田空港', status: 'PENDING_PICKUP', start: new Date(new Date().setDate(new Date().getDate() - 2)), end: new Date(new Date().setDate(new Date().getDate() + 1)) },
  { id: '8888-40', title: '8888 40系：成田空港', vehicle: '成田空港T2, 進行中', airport: '成田空港', status: 'IN_PROGRESS', start: new Date(new Date().setDate(new Date().getDate() - 1)), end: new Date(new Date().setDate(new Date().getDate() + 5)) },
  { id: '7777-P', title: '7777 總統座：仙台', vehicle: '仙台 Dormy, 待收車', airport: '仙台', status: 'PENDING_RETURN', start: new Date(new Date().setDate(new Date().getDate() + 3)), end: new Date(new Date().setDate(new Date().getDate() + 8)) },
];

const mockReminders = [
    { type: 'pickup', date: '今天', time: '09:30', title: '3333 7座：成田空港', orderId: '3333-7' },
    { type: 'return', date: '明天', time: '08:00', title: '8888 40系：成田空港', orderId: '8888-40' },
];

const mockRecords = [
    { title: '3333 7座：成田空港', status: 'PENDING_PICKUP' },
    { title: '8888 40系：成田空港', status: 'IN_PROGRESS' },
    { title: '7777 總統座：仙台', status: 'PENDING_RETURN' },
];

const mockInventory = [
    { id: '3333-7-i', title: '3333 7座：成田空港 → 成田空港', status: 'PENDING_PICKUP', details: '交車: 2025-10-28 22:00:00 · 收車: 2025-10-31 10:00:00 · 羽田空港T3' },
    { id: '8888-40-i', title: '8888 40系：成田空港', status: 'IN_PROGRESS', details: '交車: 2025-10-29 08:00:00 · 收車: 2025-11-03 17:00:00 · 成田空港T2' },
    { id: '7777-P-i', title: '7777 總統座：仙台', status: 'PENDING_RETURN', details: '交車: 2025-10-19 00:00:00 · 收車: 2025-10-25 23:59:59 · 仙台 Dormy' },
];


// --- 核心組件：Canvas 行程時間軸 ---

/**
 * RentalTimelineCanvas 組件
 * 使用 HTML Canvas 繪製租賃訂單的時間條，並處理基本互動。
 */
const RentalTimelineCanvas = ({ orders, width = 1000, height = 300 }) => {
  const canvasRef = useRef(null);
  const containerRef = useRef(null);
  const [currentWidth, setCurrentWidth] = useState(width);
  const [drawnElements, setDrawnElements] = useState([]);
  
  // 計算時間軸的起始日期：今天前 3 天
  const today = useMemo(() => {
    const d = new Date();
    d.setHours(0, 0, 0, 0);
    return d;
  }, []);
  
  const viewDurationDays = 15; // 顯示 15 天的範圍
  const startDate = useMemo(() => {
    const d = new Date(today);
    d.setDate(today.getDate() - 3); // 從今天前 3 天開始
    return d;
  }, [today]);

  const endDate = useMemo(() => {
    const d = new Date(startDate);
    d.setDate(startDate.getDate() + viewDurationDays); // 總共 15 天
    return d;
  }, [startDate]);

  const timeRangeMs = endDate.getTime() - startDate.getTime(); 

  // 1. 設置響應式寬度 (讓 Canvas 寬度適應容器)
  useEffect(() => {
    let currentCanvasWidth = 0;
    const observer = new ResizeObserver(entries => {
      const newWidth = entries[0].contentRect.width - 32; // 減去容器 padding
      if (Math.abs(newWidth - currentCanvasWidth) > 1) {
        currentCanvasWidth = newWidth;
        // 限制最大寬度
        setCurrentWidth(Math.min(currentCanvasWidth, 1200));
      }
    });

    if (containerRef.current) {
      observer.observe(containerRef.current);
    }

    return () => {
      if (containerRef.current) {
        observer.unobserve(containerRef.current);
      }
    };
  }, []);


  // 2. 繪製邏輯
  useEffect(() => {
    const canvas = canvasRef.current;
    if (!canvas || currentWidth === 0) return;

    const ctx = canvas.getContext('2d');
    if (!ctx) return;

    // 設置 Canvas 尺寸，避免模糊
    canvas.width = currentWidth;
    canvas.height = height;

    ctx.clearRect(0, 0, currentWidth, height);
    
    // --- 繪圖常量 ---
    const timelineY = 40; // 時間軸 Y 座標 (日期線下方)
    const barHeight = 20; // 每個訂單時間條的高度
    const barSpacing = 8; // 訂單條之間的垂直間距
    const rowHeight = barHeight + barSpacing;
    const maxRows = Math.floor((height - timelineY) / rowHeight);
    
    // 儲存每個水平日期索引被佔用的行數
    const occupiedLines = new Array(viewDurationDays).fill(0);

    // --- 繪製時間軸刻度 (頂部日期) ---
    ctx.fillStyle = '#6b7280'; // 灰色
    ctx.font = '10px Inter, Arial';
    ctx.textBaseline = 'middle';
    ctx.textAlign = 'center';
    
    // 繪製日期和垂直分隔線
    for (let d = 0; d <= viewDurationDays; d++) {
      const date = new Date(startDate);
      date.setDate(startDate.getDate() + d);
      
      const x = (d / viewDurationDays) * currentWidth; // X 座標
      const dateStr = `${date.getMonth() + 1}/${date.getDate()}`;
      const isWeekend = date.getDay() === 0 || date.getDay() === 6; // 0=日, 6=六
      
      // 垂直日分隔線
      ctx.strokeStyle = isWeekend ? '#e0f2f7' : '#e5e7eb';
      ctx.lineWidth = isWeekend ? 2 : 0.5;
      ctx.beginPath();
      ctx.moveTo(x, timelineY);
      ctx.lineTo(x, height);
      ctx.stroke();

      // 日期文字
      ctx.fillStyle = isWeekend ? '#1e40af' : '#6b7280'; 
      ctx.fillText(dateStr, x + (currentWidth / viewDurationDays) / 2, 20);
    }
    
    // --- 繪製訂單時間條 ---
    const newElements = [];
    
    // 預先計算訂單的 X 座標和寬度
    const ordersWithCoords = orders.map(order => {
        const startMs = order.start.getTime();
        const endMs = order.end.getTime();

        const startRatio = (startMs - startDate.getTime()) / timeRangeMs;
        const endRatio = (endMs - startDate.getTime()) / timeRangeMs;
        
        const xStart = Math.max(0, startRatio) * currentWidth;
        const xEnd = Math.min(currentWidth, endRatio * currentWidth);
        const barWidth = xEnd - xStart;

        // 計算該時間條佔用的日期索引範圍
        const startDayIndex = Math.floor(Math.max(0, startRatio * viewDurationDays));
        const endDayIndex = Math.floor(Math.min(viewDurationDays - 1, endRatio * viewDurationDays));
        
        return {
            ...order,
            xStart,
            barWidth,
            startDayIndex,
            endDayIndex,
        };
    }).filter(order => order.barWidth > 0);
    
    // 堆疊算法：找到最小可用的垂直行 (row)
    const activeRows = []; // 儲存 { endX: number, row: number }
    
    ordersWithCoords.forEach((order) => {
        let selectedRow = -1;
        
        // 尋找可以放置訂單的最小可用行
        for (let row = 0; row < maxRows; row++) {
            const collision = activeRows.find(ar => 
                ar.row === row && ar.endX > order.xStart
            );
            if (!collision) {
                selectedRow = row;
                break;
            }
        }
        
        if (selectedRow === -1) return; // 超出最大行數
        
        // 記錄新的訂單佔用
        activeRows.push({ endX: order.xStart + order.barWidth, row: selectedRow });

        const y = timelineY + 5 + selectedRow * rowHeight;
        
        const status = STATUS_MAP[order.status] || STATUS_MAP.IN_PROGRESS;
        
        // 繪製時間條 (帶圓角)
        ctx.fillStyle = status.barColor;
        ctx.beginPath();
        // 嘗試使用 roundRect
        if (typeof ctx.roundRect === 'function') {
            ctx.roundRect(order.xStart, y, order.barWidth, barHeight, 5);
        } else {
            ctx.fillRect(order.xStart, y, order.barWidth, barHeight);
        }
        ctx.fill();

        // 繪製文字 (訂單標題和 ID)
        ctx.fillStyle = '#fff';
        ctx.font = 'bold 10px Inter, Arial';
        ctx.textAlign = 'left';
        
        const text = `${order.title.split('：')[0]} - ${status.label}`;
        const textX = order.xStart + 5;
        const textY = y + barHeight / 2 + 3; // 居中微調
        
        if (ctx.measureText(text).width < order.barWidth - 10) {
            ctx.fillText(text, textX, textY);
        }
        
        // 儲存這個元素的邊界信息
        newElements.push({
            id: order.id,
            bounds: { x: order.xStart, y, width: order.barWidth, height: barHeight },
            data: order,
        });
        
        // 移除過期的行佔用 (當前時間條結束後)
        activeRows.sort((a, b) => a.endX - b.endX);
        for(let i = activeRows.length - 1; i >= 0; i--) {
            if (activeRows[i].endX < order.xStart) {
                activeRows.splice(i, 1);
            }
        }
    });
    
    setDrawnElements(newElements);
    
    // --- 繪製「今日」線 ---
    const todayRatio = (today.getTime() - startDate.getTime()) / timeRangeMs;
    const todayX = todayRatio * currentWidth;
    
    ctx.strokeStyle = '#ef4444'; // 紅色
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.moveTo(todayX, timelineY);
    ctx.lineTo(todayX, height);
    ctx.stroke();
    
    ctx.fillStyle = '#ef4444';
    ctx.font = 'bold 10px Inter, Arial';
    ctx.textAlign = 'left';
    ctx.fillText('今日', todayX + 5, timelineY + 10);

  }, [orders, currentWidth, height, today, startDate, endDate, timeRangeMs]);


  // 3. 點擊事件處理
  const handleCanvasClick = useCallback((event) => {
    const canvas = canvasRef.current;
    if (!canvas) return;
    
    // 獲取滑鼠在 Canvas 上的相對座標
    const rect = canvas.getBoundingClientRect();
    const x = event.clientX - rect.left;
    const y = event.clientY - rect.top;

    // 檢查點擊是否落在任何一個訂單條上
    const clickedElement = drawnElements.find(el => {
        const { bounds } = el;
        // 增加一點點容錯空間
        return (
            x >= bounds.x - 5 &&
            x <= bounds.x + bounds.width + 5 &&
            y >= bounds.y - 5 &&
            y <= bounds.y + bounds.height + 5
        );
    });

    if (clickedElement) {
        // 實際應用中應觸發一個 React Modal
        console.log('點擊了訂單:', clickedElement.data.title, '觸發詳細資訊彈窗');
        // 為了 UI 響應，我們可以在這裡設置一個狀態來彈出 Modal (略)
    }
  }, [drawnElements]);

  // 4. 返回 Canvas 元素
  return (
    <div ref={containerRef} className="w-full h-full min-h-64">
        <canvas 
          ref={canvasRef} 
          width={currentWidth} 
          height={height} 
          onClick={handleCanvasClick}
          className="bg-white rounded-lg cursor-pointer"
        />
    </div>
  );
};


// --- 主應用程式結構 ---

const App = () => {
  const [activeTab, setActiveTab] = useState('ALL'); // 快速篩選狀態
  const [userId, setUserId] = useState(null); // Firebase 用戶 ID

  // 1. Firebase Auth 狀態監聽
  useEffect(() => {
    if (isFirebaseInitialized && auth) {
      const unsubscribe = onAuthStateChanged(auth, (user) => {
        if (user) {
          setUserId(user.uid);
          // console.log("Authenticated User ID:", user.uid);
        } else {
          setUserId('anonymous');
          // console.log("Signed in anonymously.");
        }
      });
      return () => unsubscribe();
    }
  }, []);

  // 2. 篩選任務列表
  const filteredOrders = useMemo(() => {
      let filtered = mockOrders;
      if (activeTab !== 'ALL') {
          filtered = mockOrders.filter(order => order.status === activeTab);
      }
      return filtered.sort((a, b) => a.start.getTime() - b.start.getTime());
  }, [activeTab]);

  // 3. UI 輔助組件

  const TaskCard = ({ order, onEdit }) => {
    const statusInfo = STATUS_MAP[order.status];
    return (
      <div className="flex justify-between items-center p-3 mb-2 bg-gray-50 hover:bg-white rounded-xl shadow-sm transition duration-150 border border-gray-100">
        <div>
          <p className="font-semibold text-sm flex items-center">
            <Car className="w-4 h-4 mr-2 text-indigo-500"/>
            {order.title}
          </p>
          <p className="text-xs text-gray-500 ml-6">{order.vehicle}</p>
        </div>
        <button 
          className={`py-1 px-3 text-xs font-medium rounded-full text-indigo-600 border border-indigo-200 hover:bg-indigo-50 transition`}
          onClick={() => onEdit(order.id)}
        >
          編輯
        </button>
      </div>
    );
  };

  const ReminderItem = ({ reminder }) => (
    <div className="p-3 mb-2 bg-white rounded-xl shadow-sm border border-l-4 border-yellow-500 hover:shadow-md transition">
      <p className="text-xs font-medium text-gray-500 flex items-center">
        <Clock className="w-3 h-3 mr-1" />
        {reminder.date} {reminder.time} -
        <span className="ml-1 font-semibold text-gray-800">{reminder.title}</span>
      </p>
      <p className="text-xs mt-1 text-gray-500 ml-4">
        {reminder.type === 'pickup' ? '交車提醒' : '收車提醒'}
      </p>
    </div>
  );

  const StatusButton = ({ status, currentActive, onClick }) => {
    const statusInfo = STATUS_MAP[status];
    const isActive = currentActive === status;
    const count = mockOrders.filter(o => o.status === status).length;
    
    return (
      <button
        onClick={() => onClick(status)}
        className={`px-3 py-1.5 text-sm font-medium rounded-full transition whitespace-nowrap ${
          isActive
            ? `${statusInfo.color} text-white shadow-md`
            : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
        }`}
      >
        {statusInfo.label}
        {count > 0 && <span className="ml-1 font-bold">({count})</span>}
      </button>
    );
  };
  
  const InventoryItem = ({ item }) => {
      const statusInfo = STATUS_MAP[item.status];
      return (
          <div className="flex items-start justify-between p-4 bg-white rounded-xl shadow mb-4 border border-gray-100">
              <div className="flex-grow">
                  <p className="font-bold text-gray-800 mb-1">{item.title.split('：')[0]}：</p>
                  <p className="text-sm text-gray-600 mb-2 flex items-center">
                      <Clock className='w-3 h-3 mr-1 text-gray-400' />
                      {item.details}
                  </p>
              </div>
              <div className="flex space-x-2 text-xs font-semibold whitespace-nowrap ml-4">
                  <button className="text-blue-600 hover:text-blue-800 py-1 px-3 rounded-full border border-blue-200 hover:bg-blue-50 transition">編輯</button>
                  <button className="text-yellow-600 hover:text-yellow-800 py-1 px-3 rounded-full border border-yellow-200 hover:bg-yellow-50 transition">登錄狀態</button>
                  <button className="text-red-600 hover:text-red-800 py-1 px-3 rounded-full border border-red-200 hover:bg-red-50 transition">刪除</button>
              </div>
          </div>
      );
  }


  // --- 主介面渲染 ---

  return (
    <div className="min-h-screen bg-gray-100 p-4 md:p-8 font-sans">
      <style>{`
        /* 自定義滾動條樣式 */
        ::-webkit-scrollbar {
          width: 8px;
        }
        ::-webkit-scrollbar-thumb {
          background: #d1d5db; /* 淺灰色 */
          border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
          background: #9ca3af; /* 深灰色 */
        }
        /* 確保 Canvas 繪圖的文字使用 Inter 字體 */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
      `}</style>

      {/* 標題與日期 */}
      <div className="flex justify-between items-center mb-6 bg-white p-4 rounded-xl shadow-lg md:shadow-none md:bg-gray-100">
        <h1 className="text-2xl font-bold text-gray-800 flex items-center">
          <Menu className="w-6 h-6 mr-3 text-indigo-500 hidden sm:block" />
          訂單管理儀表板
        </h1>
        <div className="flex items-center space-x-3">
          <button className="flex items-center py-2 px-4 bg-indigo-600 text-white rounded-full hover:bg-indigo-700 transition shadow-md text-sm font-semibold">
            <Truck className="w-4 h-4 mr-2" />
            快速派單/登錄
          </button>
          <button className="py-2 px-3 bg-white text-gray-700 rounded-full border border-gray-300 hover:bg-gray-100 transition shadow-sm">
            <Calendar className="w-5 h-5" />
          </button>
        </div>
      </div>

      <div className="grid grid-cols-1 lg:grid-cols-12 gap-6">
        
        {/* 左側邊欄/任務與篩選 (佔 3 欄) */}
        <div className="lg:col-span-3 space-y-6">
          
          {/* 今日任務 */}
          <div className="bg-white p-5 rounded-xl shadow-lg">
            <h2 className="text-lg font-semibold text-gray-800 mb-4 border-b pb-2 flex justify-between items-center">
              今日任務
              <button 
                className="text-sm text-indigo-600 hover:text-indigo-800 transition font-medium"
                onClick={() => console.log('新增任務')}
              >
                新增任務
              </button>
            </h2>
            <div className="space-y-3">
              {mockOrders.slice(0, 3).map(order => (
                <TaskCard key={order.id} order={order} onEdit={() => console.log(`編輯 ${order.id}`)}/>
              ))}
            </div>
          </div>

          {/* 搜尋與篩選區 */}
          <div className="bg-white p-5 rounded-xl shadow-lg space-y-4">
            <div className="relative">
              <Search className="w-4 h-4 text-gray-400 absolute left-3 top-1/2 transform -translate-y-1/2" />
              <input
                type="text"
                placeholder="搜尋/篩選：車牌、地點"
                className="w-full py-2 pl-10 pr-4 border border-gray-300 rounded-full focus:ring-indigo-500 focus:border-indigo-500 text-sm shadow-sm"
              />
            </div>
            
            <div className="flex items-center justify-between text-sm text-gray-700">
              <label htmlFor="status-select" className="font-medium">車隊/歸還地點</label>
              <select 
                id="status-select" 
                className="py-1 px-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 text-sm shadow-sm"
              >
                <option>全部地點</option>
                <option>成田空港</option>
                <option>仙台</option>
              </select>
            </div>

            {/* 快速操作 */}
            <div className="pt-2 space-y-2 border-t mt-4">
              <p className="font-medium text-sm text-gray-700">快速操作</p>
              <button className="w-full py-2 bg-gray-100 text-gray-700 rounded-lg text-sm hover:bg-gray-200 transition font-semibold">
                匯出 CSV
              </button>
              <button className="w-full py-2 bg-gray-100 text-gray-700 rounded-lg text-sm hover:bg-gray-200 transition font-semibold">
                日曆設定
              </button>
            </div>
          </div>
        </div>

        {/* 右側主內容區 (佔 9 欄) */}
        <div className="lg:col-span-9 space-y-6">

          {/* 行程日曆 - Canvas 區域 */}
          <div className="bg-white p-5 rounded-xl shadow-lg">
            <h2 className="text-lg font-semibold text-gray-800 mb-4 pb-2 border-b">
              行程日曆
              <span className="text-sm font-normal text-gray-500 ml-3">點擊事件可快速編輯或登錄重程</span>
            </h2>
            <div className="flex justify-between items-center mb-4">
                <p className="text-sm font-medium text-gray-600">
                    {/* 顯示 Canvas 的動態日期範圍 */}
                    {new Date().toLocaleDateString('zh-TW', { month: '2-digit', day: '2-digit' })}
                    至 
                    {new Date(new Date().setDate(new Date().getDate() + 12)).toLocaleDateString('zh-TW', { month: '2-digit', day: '2-digit' })} (未來 15 天視圖)
                </p>
                <div className="flex space-x-2">
                    <button className="text-sm py-1 px-3 bg-indigo-500 text-white rounded-full hover:bg-indigo-600 transition font-semibold shadow-sm">今天</button>
                    <button className="text-sm py-1 px-3 bg-white text-gray-700 rounded-full border border-gray-300 hover:bg-gray-100 transition font-semibold">切換視圖</button>
                </div>
            </div>
            
            {/* Canvas 容器 */}
            <RentalTimelineCanvas orders={mockOrders} height={200} />
            
          </div>
          
          {/* 右側欄 - 今日提醒與快速篩選 (在寬螢幕上並排) */}
          <div className="grid grid-cols-1 md:grid-cols-3 gap-6">

            {/* 今日提醒 (佔 2 欄) */}
            <div className="md:col-span-2 bg-white p-5 rounded-xl shadow-lg">
              <h2 className="text-lg font-semibold text-gray-800 mb-4 border-b pb-2 flex items-center">
                <AlertTriangle className="w-5 h-5 mr-2 text-yellow-500"/>
                今日提醒
              </h2>
              <div className="space-y-2">
                {mockReminders.map((r, index) => <ReminderItem key={index} reminder={r} />)}
              </div>
            </div>

            {/* 快速篩選 (佔 1 欄) */}
            <div className="bg-white p-5 rounded-xl shadow-lg">
                <h2 className="text-lg font-semibold text-gray-800 mb-4 border-b pb-2 flex items-center">
                    <List className="w-5 h-5 mr-2 text-indigo-500"/>
                    快速篩選
                </h2>
                <div className="flex flex-wrap gap-2">
                    {Object.keys(STATUS_MAP).filter(k => k !== 'COMPLETED').map(status => (
                        <StatusButton 
                            key={status} 
                            status={status} 
                            currentActive={activeTab} 
                            onClick={setActiveTab} 
                        />
                    ))}
                    <StatusButton 
                        status={'ALL'} 
                        currentActive={activeTab} 
                        onClick={setActiveTab} 
                    />
                </div>
                
                <h3 className="text-base font-semibold text-gray-800 mt-6 mb-3 border-t pt-3">最近記錄</h3>
                <div className="space-y-2 text-sm">
                    {mockRecords.map((r, index) => (
                        <p key={index} className="text-gray-600 flex items-center justify-between">
                            {r.title.split('：')[0]}
                            <span className={`text-xs font-medium py-0.5 px-2 rounded-full ${STATUS_MAP[r.status]?.color} ${STATUS_MAP[r.status]?.textColor} bg-opacity-10`}>
                                {STATUS_MAP[r.status]?.label || '未知'}
                            </span>
                        </p>
                    ))}
                </div>
            </div>
          </div>
          
          {/* 所有租賃/逾期記錄 (詳細列表) */}
          <div className="bg-white p-5 rounded-xl shadow-lg">
            <h2 className="text-lg font-semibold text-gray-800 mb-4 border-b pb-2 flex justify-between items-center">
              所有租賃與逾期記錄
              <span className="text-sm font-normal text-gray-500 ml-3">顯示 {filteredOrders.length} 筆紀錄</span>
            </h2>
            <div>
              {filteredOrders.map(item => (
                  <InventoryItem key={item.id} item={item} />
              ))}
            </div>
          </div>

        </div>
      </div>
      
      {/* 用戶 ID 顯示 (用於測試 Firebase 規則) */}
      <div className="mt-8 p-3 bg-white text-xs text-gray-600 rounded-xl shadow-md">
          <span className='font-semibold text-indigo-600'>環境狀態：</span>
          Firebase App ID: <span className="font-mono">{appId}</span> | 
          User ID: <span className="font-mono">{userId || 'Loading...'}</span>
      </div>

    </div>
  );
};

export default App;
