<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ËªäËºõË®ÇÂñÆÁÆ°ÁêÜÁ≥ªÁµ±</title>
    
    <!-- Tailwind CSS (Ê®£ÂºèÂ∫´) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Ëß£Ê±∫ React Âú®ÁÄèË¶ΩÂô®Áõ¥Êé•ÈÅãË°åÁöÑÁõ∏‰æùÊÄßÂïèÈ°å -->
    <script type="importmap">
      {
        "imports": {
          "react": "https://esm.sh/react@18.2.0",
          "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
          "lucide-react": "https://esm.sh/lucide-react@0.292.0",
          "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
          "firebase/auth": "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js",
          "firebase/firestore": "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"
        }
      }
    </script>
    
    <!-- Babel (ËÆìÁÄèË¶ΩÂô®ÁúãÊáÇ JSX) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body { font-family: 'Inter', system-ui, -apple-system, sans-serif; background-color: #f8fafc; }
        /* Èö±ËóèÊú™ËºâÂÖ•ÊôÇÁöÑÈñÉÁàç */
        #root:empty { display: none; }
        .transition-max-height { transition: max-height 0.3s ease-in-out; }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- ‰∏ªÁ®ãÂºèÈÇèËºØ -->
    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
            Calendar, Car, Users, CreditCard, Snowflake, Sun,
            Plus, Search, Edit3, Trash2, Clock, Save, X, 
            LogOut, ShieldCheck, Database, CheckCircle, ArrowRight, AlertCircle,
            ChevronDown, ChevronUp, BellRing, AlertTriangle, MapPin
        } from 'lucide-react';

        // --- Firebase SDK ---
        import { initializeApp } from 'firebase/app';
        import { getAuth, signInAnonymously, onAuthStateChanged } from 'firebase/auth';
        import { 
            getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, 
            serverTimestamp 
        } from 'firebase/firestore';

        // üî¥ Ë´ãÂú®ÈÄôË£°Â°´ÂÖ•ÊÇ®ÁöÑ Firebase Ë®≠ÂÆö (‰øùÁïôÂºïËôü) üî¥
        const firebaseConfig = {
            apiKey: "AIzaSyDq65URVL5sppv-2yXBh8DQuEwaXm5u5k0",
            authDomain: "myrentalcarsystem-a88fb.firebaseapp.com",
            projectId: "myrentalcarsystem-a88fb",
            storageBucket: "myrentalcarsystem-a88fb.firebasestorage.app",
            messagingSenderId: "1076727464488",
            appId: "1:1076727464488:web:9599c788414f5211896b1d"
        };

        // ÂàùÂßãÂåñ Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- È†êË®≠Ë≥áÊñô (Â∑≤Ê†πÊìöÂúñÁâá image_6c7a5e.png Êõ¥Êñ∞) ---
        const INITIAL_VEHICLES_SEED = [
            { location: 'ÊàêÁî∞', plate: 'ÊàêÁî∞330„Çè888', brand: 'Toyota', model: 'Vellfire', feature: 'HEV 4WD', seats: 8, etc: '8001 6161 4861 3901 001', tire: 'ÂÜ¨Ê∏à' },
            { location: 'ÊàêÁî∞', plate: 'ÂíåÊ≥â330„Çè2222', brand: 'Toyota', model: 'Alphard', feature: '', seats: 8, etc: '8001 6161 4860 7900 000', tire: 'ÂÜ¨Ê∏à' },
            { location: 'ÊàêÁî∞', plate: '„Å™„Å´„Çè334„Çè8888', brand: 'Toyota', model: 'Alphard', feature: '40Á≥ª Captain', seats: 7, etc: '7804 2150 2134 9280', tire: 'ÂÜ¨Ê∏à' },
            { location: 'ÊàêÁî∞', plate: 'ÂíåÊ≥â333„Çè1111', brand: 'Toyota', model: 'Vellfire', feature: '', seats: 7, etc: '8001 6161 4861 9900 000', tire: 'ÂÜ¨Ê∏à' },
            { location: 'ÊàêÁî∞', plate: '„Å™„Å´„Çè335„Çè8888', brand: 'Toyota', model: 'Alphard', feature: 'HEV 4WD', seats: 8, etc: '8001 6161 4860 6901 000', tire: 'ÂÜ¨Ê∏à' },
            { location: 'ÊàêÁî∞', plate: 'ÂìÅÂ∑ù302„Çè2282', brand: 'Toyota', model: 'Alphard', feature: '', seats: 7, etc: '8026 8702 5853 4820 000', tire: 'ÂÜ¨Ê∏à' },
            { location: 'ÊàêÁî∞', plate: 'ÂìÅÂ∑ù302„Çè6466', brand: 'Toyota', model: 'Alphard', feature: 'HEV', seats: 7, etc: '7070 3000 2295 9138', tire: 'Â§èÊ∏à' },
            { location: 'ÊàêÁî∞', plate: 'Êüè300„Çè2258', brand: 'Toyota', model: 'Alphard', feature: '', seats: 7, etc: '8001 6161 4861 4901 000', tire: 'ÂÜ¨Ê∏à' },
            // Êñ∞Â¢ûÂÖ©Âè∞Ëªä
            { location: 'ÊàêÁî∞', plate: 'Êüè300„Çè2588', brand: 'Toyota', model: 'Alphard', feature: '', seats: 7, etc: '8001 6161 4860 9901 007', tire: 'ÂÜ¨Ê∏à' },
            { location: 'ÊàêÁî∞', plate: 'Êüè300„Çè2599', brand: 'Toyota', model: 'Alphard', feature: '4WD', seats: 7, etc: '8001 6161 4860 0901 006', tire: 'ÂÜ¨Ê∏à' },
        ];

        // Â∏∏Áî®Âú∞ÈªûÈÅ∏È†Ö
        const PRESET_LOCATIONS = ["ÊàêÁî∞‰∫åËà™", "ÊàêÁî∞‰∏ÄËà™", "ÁæΩÁî∞"];

        // --- React Component ---
        function VehicleOrderSystem() {
            const [user, setUser] = useState(null);
            const [activeTab, setActiveTab] = useState('dashboard');
            const [vehicles, setVehicles] = useState([]);
            const [orders, setOrders] = useState([]);
            const [isLoading, setIsLoading] = useState(true);
            
            // UI State for Expanded Cards
            const [expandedCards, setExpandedCards] = useState({});

            const [isOrderModalOpen, setIsOrderModalOpen] = useState(false);
            const [editingOrder, setEditingOrder] = useState(null);
            const [isVehicleModalOpen, setIsVehicleModalOpen] = useState(false);
            const [editingVehicle, setEditingVehicle] = useState(null);
            
            const [searchTerm, setSearchTerm] = useState('');
            const [filterDate, setFilterDate] = useState(new Date().toISOString().split('T')[0]);

            const [orderFormData, setOrderFormData] = useState({
                customer: '', start: '', end: '', vehicleId: '', note: '', status: 'confirmed',
                pickupLocation: '', returnLocation: ''
            });
            const [vehicleFormData, setVehicleFormData] = useState({
                location: 'ÊàêÁî∞', plate: '', brand: 'Toyota', model: 'Alphard', feature: '', seats: 7, etc: '', tire: 'ÂÜ¨Ê∏à'
            });
            const [newEtcNumber, setNewEtcNumber] = useState('');

            // Auth & Sync
            useEffect(() => {
                signInAnonymously(auth).catch(console.error);
                const unsubscribe = onAuthStateChanged(auth, (currentUser) => {
                    setUser(currentUser);
                    if (currentUser) {
                        const unsubVehicles = onSnapshot(collection(db, 'vehicles'), (snap) => {
                            setVehicles(snap.docs.map(d => ({ id: d.id, ...d.data() })));
                            setIsLoading(false);
                        });
                        const unsubOrders = onSnapshot(collection(db, 'orders'), (snap) => {
                            setOrders(snap.docs.map(d => ({ id: d.id, ...d.data() })));
                        });
                        return () => { unsubVehicles(); unsubOrders(); };
                    } else {
                        setIsLoading(false);
                    }
                });
                return () => unsubscribe();
            }, []);

            // Toggle Expand
            const toggleExpand = (id) => {
                setExpandedCards(prev => ({
                    ...prev,
                    [id]: !prev[id]
                }));
            };

            // Helpers
            const formatDateTime = (iso) => {
                if (!iso) return '';
                const d = new Date(iso);
                return `${d.getFullYear()}/${(d.getMonth()+1).toString().padStart(2,'0')}/${d.getDate().toString().padStart(2,'0')} ${d.getHours().toString().padStart(2,'0')}:${d.getMinutes().toString().padStart(2,'0')}`;
            };
            
            const formatTimeOnly = (iso) => {
                if (!iso) return '';
                const d = new Date(iso);
                return `${d.getHours().toString().padStart(2,'0')}:${d.getMinutes().toString().padStart(2,'0')}`;
            };

            // ÂèñÂæóÁï∂Êó•Ë®ÇÂñÆ (Áî®ÊñºË®àÁÆóÁãÄÊÖã)
            const getDayOrders = (vid, dateStr) => {
                const startOfDay = new Date(`${dateStr}T00:00:00`);
                const endOfDay = new Date(`${dateStr}T23:59:59`);
                return orders
                    .filter(o => o.vehicleId === vid && o.status !== 'cancelled' && new Date(o.start) < endOfDay && new Date(o.end) > startOfDay)
                    .sort((a, b) => new Date(a.start) - new Date(b.start));
            };

            // ÂèñÂæóÂÆåÊï¥ÊéíÁ®ã (Áï∂Êó• + Êú™‰æÜÔºåÁî®ÊñºÂ±ïÈñãÂàóË°®)
            const getVehicleSchedule = (vid, dateStr) => {
                const startOfDay = new Date(`${dateStr}T00:00:00`);
                return orders
                    .filter(o => o.vehicleId === vid && o.status !== 'cancelled' && new Date(o.end) > startOfDay)
                    .sort((a, b) => new Date(a.start) - new Date(b.start));
            };

            const isVehicleAvailable = (vid, start, end, excludeId) => {
                const s = new Date(start);
                const e = new Date(end);
                return !orders.some(o => o.vehicleId === vid && o.id !== excludeId && o.status !== 'cancelled' && s < new Date(o.end) && e > new Date(o.start));
            };

            const isOrderActiveNow = (order) => {
                const now = new Date();
                const start = new Date(order.start);
                const end = new Date(order.end);
                return now >= start && now <= end;
            };

            // Sorting Logic for Dashboard
            const sortedVehicles = useMemo(() => {
                const vehiclesWithStatus = vehicles.map(v => {
                    const dayOrders = getDayOrders(v.id, filterDate);
                    const activeOrder = dayOrders.find(o => isOrderActiveNow(o));
                    const now = new Date();
                    const futureOrders = dayOrders.filter(o => !isOrderActiveNow(o) && new Date(o.start) > now);
                    
                    // Ê±∫ÂÆöÊéíÂ∫èÊ¨äÈáç (Ë∂äÂ∞èË∂äÂâçÈù¢)
                    let sortWeight = 999; 
                    let sortTime = 0; 

                    if (activeOrder) {
                        // Á¨¨‰∏ÄÂÑ™ÂÖàÔºöÊ≠£Âú®Âá∫Áßü (ÁúãË™∞ÂÖàÈÇÑËªä)
                        sortWeight = 1;
                        sortTime = new Date(activeOrder.end).getTime();
                    } else if (futureOrders.length > 0) {
                        // Á¨¨‰∫åÂÑ™ÂÖàÔºöÂç≥Â∞áÊúâÈ†êÁ¥Ñ (ÁúãË™∞ÂÖà‰∫§Ëªä)
                        sortWeight = 2;
                        sortTime = new Date(futureOrders[0].start).getTime();
                    } else {
                        // Á¨¨‰∏âÔºöÁ©∫Ëªä
                        sortWeight = 3;
                    }

                    return { ...v, dayOrders, activeOrder, futureOrders, sortWeight, sortTime };
                });

                return vehiclesWithStatus.sort((a, b) => {
                    if (a.sortWeight !== b.sortWeight) return a.sortWeight - b.sortWeight;
                    return a.sortTime - b.sortTime;
                });
            }, [vehicles, orders, filterDate]);

            // ‰∏ÄÈÄ±ÂÖßË°åÁ®ãÊèêÈÜíÈÇèËºØ (Â∑≤ÊéíÈô§ÈÅéÂéªÊôÇÈñì)
            const weeklyReminders = useMemo(() => {
                const now = new Date(); // ÂèñÂæóÁï∂‰∏ãÊôÇÈñì
                const startWindow = new Date(`${filterDate}T00:00:00`);
                const endWindow = new Date(startWindow);
                endWindow.setDate(endWindow.getDate() + 7);

                const events = [];
                orders.forEach(o => {
                    if (o.status === 'cancelled') return;
                    
                    const startDate = new Date(o.start);
                    const endDate = new Date(o.end);
                    const vehicle = vehicles.find(v => v.id === o.vehicleId);
                    
                    if (!vehicle) return;

                    // Ê™¢Êü•‰∫§Ëªä (Pickup) - ÈúÄÂú®ÊêúÂ∞ãÂçÄÈñìÂÖß ‰∏î ÊôöÊñºÁèæÂú®ÊôÇÈñì
                    if (startDate >= startWindow && startDate <= endWindow && startDate > now) {
                        events.push({
                            id: `start-${o.id}`,
                            type: 'pickup',
                            time: startDate,
                            order: o,
                            vehicle: vehicle
                        });
                    }

                    // Ê™¢Êü•ÈÇÑËªä (Return) - ÈúÄÂú®ÊêúÂ∞ãÂçÄÈñìÂÖß ‰∏î ÊôöÊñºÁèæÂú®ÊôÇÈñì
                    if (endDate >= startWindow && endDate <= endWindow && endDate > now) {
                        events.push({
                            id: `end-${o.id}`,
                            type: 'return',
                            time: endDate,
                            order: o,
                            vehicle: vehicle
                        });
                    }
                });

                return events.sort((a, b) => a.time - b.time);
            }, [orders, vehicles, filterDate]);


            // Actions
            const handleSaveOrder = async (e) => {
                e.preventDefault();
                if (!orderFormData.customer || !orderFormData.start || !orderFormData.end || !orderFormData.vehicleId) return alert("Ë´ãÂ°´ÂØ´ÂøÖÂ°´Ê¨Ñ‰Ωç");
                if (new Date(orderFormData.start) >= new Date(orderFormData.end)) return alert("ÊôÇÈñìÈåØË™§");
                if (!isVehicleAvailable(orderFormData.vehicleId, orderFormData.start, orderFormData.end, editingOrder?.id)) return alert("Ë©≤ÊôÇÊÆµËªäËºõÂ∑≤Ë¢´È†êÁ¥Ñ");

                try {
                    const data = { ...orderFormData, updatedAt: serverTimestamp() };
                    if (editingOrder) await updateDoc(doc(db, 'orders', editingOrder.id), data);
                    else await addDoc(collection(db, 'orders'), { ...data, createdAt: serverTimestamp() });
                    setIsOrderModalOpen(false);
                } catch (err) { alert("ÂÑ≤Â≠òÂ§±Êïó: " + err.message); }
            };

            const handleDeleteOrder = async (id) => {
                if(window.confirm("Á¢∫ÂÆöÂà™Èô§?")) await deleteDoc(doc(db, 'orders', id));
            };

            const handleSaveVehicle = async (e) => {
                e.preventDefault();
                try {
                    const data = { ...vehicleFormData, updatedAt: serverTimestamp() };
                    if (editingVehicle) await updateDoc(doc(db, 'vehicles', editingVehicle.id), data);
                    else await addDoc(collection(db, 'vehicles'), { ...data, createdAt: serverTimestamp() });
                    setIsVehicleModalOpen(false);
                } catch (err) { alert("ÂÑ≤Â≠òÂ§±Êïó"); }
            };

            const handleDeleteVehicle = async (id) => {
                if(window.confirm("Á¢∫ÂÆöÂà™Èô§?")) await deleteDoc(doc(db, 'vehicles', id));
            };

            const handleSeedData = async () => {
                if(!window.confirm(`Á¢∫ÂÆöÂåØÂÖ• ${INITIAL_VEHICLES_SEED.length} Âè∞ËªäËºõ?`)) return;
                try {
                    const existingPlates = vehicles.map(v => v.plate);
                    const newVehicles = INITIAL_VEHICLES_SEED.filter(v => !existingPlates.includes(v.plate));
                    if (newVehicles.length === 0) return alert("È†êË®≠ËªäËºõÂ∑≤Â≠òÂú®ÔºåÁÑ°ÈúÄÂåØÂÖ•");
                    await Promise.all(newVehicles.map(v => addDoc(collection(db, 'vehicles'), { ...v, createdAt: serverTimestamp() })));
                    alert(`ÊàêÂäüÂåØÂÖ• ${newVehicles.length} Âè∞Êñ∞ËªäËºõÔºÅ`);
                } catch (e) { alert("Â§±Êïó: " + e.message); }
            };

            if (isLoading) return <div className="min-h-screen flex items-center justify-center text-slate-500">ËºâÂÖ•Ë≥áÊñô‰∏≠...</div>;

            return (
                <div className="pb-20 md:pb-0">
                    <nav className="bg-slate-900 text-white p-4 sticky top-0 z-20 flex justify-between items-center shadow">
                        <div className="flex items-center gap-2 font-bold"><Car className="text-blue-400"/> Ë™øÂ∫¶Á≥ªÁµ±</div>
                        <div className="text-xs text-gray-400 flex items-center gap-1">
                            {user ? <span className="text-green-400">‚óè Á∑ö‰∏ä</span> : <span>ÈÄ£Á∑ö‰∏≠...</span>}
                        </div>
                    </nav>

                    <main className="p-4 max-w-5xl mx-auto">
                        {vehicles.length < 10 && !isLoading && (
                            <div className="mb-4 p-4 bg-blue-50 border border-blue-200 rounded-lg flex justify-between items-center">
                                <span className="text-sm text-blue-800">Âø´ÈÄüÈñãÂßãÔºöË≥áÊñôÂ∫´‰ºº‰πéÁº∫Â∞ëÈÉ®ÂàÜÈ†êË®≠ËªäËºõÔºåÊòØÂê¶Ë£úÈΩäÔºü</span>
                                <button onClick={handleSeedData} className="px-3 py-1 bg-blue-600 text-white text-xs rounded">‰∏ÄÈçµË£úÈΩäË≥áÊñô</button>
                            </div>
                        )}

                        {activeTab === 'dashboard' && (
                            <div className="space-y-4">
                                <div className="flex justify-between items-center bg-white p-3 rounded shadow-sm">
                                    <h2 className="font-bold flex items-center gap-2"><BellRing size={18} className="text-blue-600"/> ËªäËºõË™øÂ∫¶ÁúãÊùø</h2>
                                    <input type="date" value={filterDate} onChange={e=>setFilterDate(e.target.value)} className="border rounded p-1 font-medium text-slate-700" />
                                </div>

                                {/* Êú™‰æÜ‰∏ÄÈÄ±ÊèêÈÜíÂçÄÂ°ä */}
                                <div className="bg-slate-50 border border-slate-200 rounded-lg overflow-hidden">
                                    <div className="bg-slate-100 px-3 py-2 text-xs font-bold text-slate-600 flex justify-between items-center border-b border-slate-200">
                                        <span>Êú™‰æÜ 7 Êó•Ë°åÁ®ãÊèêÈÜí ({weeklyReminders.length})</span>
                                        <span className="text-[10px] text-slate-400">‰æùÊôÇÈñìÊéíÂ∫è (Â∑≤Èö±ËóèÈÅéÊúü)</span>
                                    </div>
                                    <div className="max-h-40 overflow-y-auto divide-y divide-slate-100">
                                        {weeklyReminders.length === 0 ? (
                                            <div className="p-4 text-center text-xs text-slate-400 italic">Êú™‰æÜ‰∏ÄÈÄ±ÁÑ°ÂæÖËæ¶Ë°åÁ®ã</div>
                                        ) : (
                                            weeklyReminders.map(evt => (
                                                <div key={evt.id} className="p-2 flex items-center gap-3 hover:bg-white text-sm">
                                                    <div className={`text-[10px] font-bold px-1.5 py-0.5 rounded whitespace-nowrap w-12 text-center ${evt.type === 'pickup' ? 'bg-yellow-100 text-yellow-700' : 'bg-red-100 text-red-700'}`}>
                                                        {evt.type === 'pickup' ? 'üü° ‰∫§Ëªä' : 'üî¥ ÈÇÑËªä'}
                                                    </div>
                                                    <div className="flex-1">
                                                        <div className="flex justify-between">
                                                            <div className="flex items-center gap-2">
                                                                <span className="font-bold text-slate-700">{formatDateTime(evt.time)}</span>
                                                                {/* È°ØÁ§∫Âú∞Èªû */}
                                                                <span className="text-xs text-slate-500 bg-slate-100 px-1 rounded border border-slate-200 flex items-center gap-0.5">
                                                                    <MapPin size={10}/>
                                                                    {evt.type === 'pickup' ? (evt.order.pickupLocation || 'Êú™ÊåáÂÆö') : (evt.order.returnLocation || 'Êú™ÊåáÂÆö')}
                                                                </span>
                                                            </div>
                                                            <span className="text-xs text-slate-500 font-medium">{evt.vehicle.plate}</span>
                                                        </div>
                                                        <div className="text-xs text-slate-500 truncate">
                                                            {evt.order.customer} 
                                                            <span className="text-slate-300 mx-1">|</span> 
                                                            {evt.vehicle.model}
                                                        </div>
                                                    </div>
                                                </div>
                                            ))
                                        )}
                                    </div>
                                </div>

                                <div className="text-xs text-gray-500 px-2 flex justify-between pt-2">
                                    <span>ÊéíÂ∫èÔºöüî¥ÈÇÑËªäÂÑ™ÂÖà -> üü°‰∫§ËªäÂÑ™ÂÖà -> üü¢Á©∫Ëªä</span>
                                </div>
                                <div className="space-y-3">
                                    {sortedVehicles.map(v => {
                                        const dayOrders = v.dayOrders; // Áï∂Êó•Ë°åÁ®ã (Áî®ÊñºÁãÄÊÖãÊ®ôÁ±§)
                                        const scheduleOrders = getVehicleSchedule(v.id, filterDate); // ÂÆåÊï¥ÊéíÁ®ã (Áî®ÊñºÂ±ïÈñãÂàóË°®)
                                        
                                        const activeOrder = v.activeOrder;
                                        const futureOrders = v.futureOrders;
                                        const isRentedNow = !!activeOrder;
                                        const isExpanded = !!expandedCards[v.id];

                                        return (
                                            <div 
                                                key={v.id} 
                                                className={`bg-white rounded shadow-sm border-l-4 transition-all duration-200 cursor-pointer hover:shadow-md
                                                    ${isRentedNow ? 'border-l-red-500' : (futureOrders.length > 0 ? 'border-l-yellow-400' : 'border-l-green-500')}
                                                `}
                                                onClick={() => toggleExpand(v.id)}
                                            >
                                                {/* Card Header */}
                                                <div className="p-4">
                                                    <div className="flex justify-between items-start mb-2">
                                                        <div>
                                                            <div className="font-bold text-lg text-slate-800">{v.plate}</div>
                                                            <div className="text-sm text-gray-500">
                                                                {v.model} {v.feature ? ` / ${v.feature}` : ''} {v.tire ? ` (${v.tire})` : ''} {v.seats ? ` / ${v.seats} Â∫ß` : ''}
                                                            </div>
                                                        </div>
                                                        
                                                        {/* Status Badges (Stacked) */}
                                                        <div className="flex flex-col items-end gap-1">
                                                            {dayOrders.length === 0 && (
                                                                <span className="text-xs px-2 py-1 rounded bg-green-100 text-green-700 font-bold">Á©∫Ëªä</span>
                                                            )}
                                                            {isRentedNow && (
                                                                <span className="text-xs px-2 py-1 rounded bg-red-100 text-red-700 font-bold animate-pulse flex items-center gap-1">
                                                                    <Clock size={12}/> Âá∫Áßü‰∏≠
                                                                </span>
                                                            )}
                                                            {/* Âè™Ë¶ÅË°åÁ®ãË°®Ë£°ÊúâÊú™‰æÜÁöÑË®ÇÂñÆÔºåÂ∞±È°ØÁ§∫È†êÁ¥ÑË®ÇÂñÆÊ®ôÁ±§ */}
                                                            {scheduleOrders.some(o => new Date(o.start) > new Date()) && (
                                                                <span className="text-xs px-2 py-1 rounded bg-yellow-100 text-yellow-700 font-bold flex items-center gap-1">
                                                                    <AlertCircle size={12}/> È†êÁ¥ÑË®ÇÂñÆ
                                                                </span>
                                                            )}
                                                            <div className="mt-1 text-gray-400">
                                                                {isExpanded ? <ChevronUp size={16} /> : <ChevronDown size={16} />}
                                                            </div>
                                                        </div>
                                                    </div>

                                                    {/* Key Time Reminder (Always Visible) */}
                                                    {!isExpanded && (
                                                        <div className="mt-2 pt-2 border-t border-dashed border-gray-100">
                                                            {activeOrder ? (
                                                                <div className="flex items-center gap-2 text-sm">
                                                                    <span className="px-1.5 py-0.5 rounded bg-red-100 text-red-700 text-xs font-bold whitespace-nowrap">ÈÇÑËªä</span>
                                                                    <span className="font-medium text-slate-800">{formatDateTime(activeOrder.end)}</span>
                                                                    <span className="text-xs text-slate-500 bg-slate-100 px-1 rounded flex items-center">
                                                                        <MapPin size={10} className="mr-0.5"/> {activeOrder.returnLocation || 'Êú™ÊåáÂÆö'}
                                                                    </span>
                                                                    <span className="text-gray-500 text-xs ml-auto">({activeOrder.customer})</span>
                                                                </div>
                                                            ) : futureOrders.length > 0 ? (
                                                                <div className="flex items-center gap-2 text-sm">
                                                                    <span className="px-1.5 py-0.5 rounded bg-yellow-100 text-yellow-700 text-xs font-bold whitespace-nowrap">‰∫§Ëªä</span>
                                                                    <span className="font-medium text-slate-800">{formatDateTime(futureOrders[0].start)}</span>
                                                                    <span className="text-xs text-slate-500 bg-slate-100 px-1 rounded flex items-center">
                                                                        <MapPin size={10} className="mr-0.5"/> {futureOrders[0].pickupLocation || 'Êú™ÊåáÂÆö'}
                                                                    </span>
                                                                    <span className="text-gray-500 text-xs ml-auto">({futureOrders[0].customer})</span>
                                                                </div>
                                                            ) : (
                                                                <div className="text-xs text-gray-400 italic">ÁõÆÂâçÁÑ°ÊéíÁ®ãÔºåÂèØÈö®ÊôÇÊ¥æÂñÆ</div>
                                                            )}
                                                        </div>
                                                    )}
                                                </div>

                                                {/* Expanded Details - Schedule List */}
                                                {isExpanded && (
                                                    <div className="px-4 pb-4 border-t bg-slate-50 rounded-b" onClick={(e) => e.stopPropagation()}>
                                                        <div className="space-y-3 pt-3">
                                                            <div className="text-xs font-bold text-gray-500 uppercase tracking-wide mb-2">Ë©≥Á¥∞Ë°åÁ®ãË°® (Âê´Êú™‰æÜÈ†êÁ¥Ñ)</div>
                                                            
                                                            {scheduleOrders.map((order, idx) => {
                                                                const active = isOrderActiveNow(order);
                                                                const isFuture = new Date(order.start) > new Date();
                                                                
                                                                let statusColor = "bg-white border-gray-200";
                                                                let textColor = "text-gray-600";
                                                                let label = "Â∑≤ÁµêÊùü";
                                                                let labelClass = "bg-gray-100 text-gray-500";
                                                                
                                                                if (active) {
                                                                    statusColor = "bg-red-50 border-red-200 shadow-sm";
                                                                    textColor = "text-red-700";
                                                                    label = "ÈÄ≤Ë°å‰∏≠";
                                                                    labelClass = "bg-red-100 text-red-700 font-bold";
                                                                } else if (isFuture) {
                                                                    statusColor = "bg-yellow-50 border-yellow-200";
                                                                    textColor = "text-yellow-700";
                                                                    label = "È†êÁ¥Ñ";
                                                                    labelClass = "bg-yellow-100 text-yellow-700 font-bold";
                                                                }

                                                                return (
                                                                    <div key={order.id} className={`text-sm p-3 rounded border flex justify-between items-start ${statusColor}`}>
                                                                        <div className="flex-1">
                                                                            <div className="flex justify-between items-center mb-1">
                                                                                <div className={`font-medium flex items-center gap-2 ${textColor} text-base`}>
                                                                                    {order.customer}
                                                                                    <span className={`text-[10px] px-2 py-0.5 rounded border ${labelClass}`}>
                                                                                        {label}
                                                                                    </span>
                                                                                </div>
                                                                            </div>
                                                                            <div className="text-sm text-slate-700 mt-1 space-y-1">
                                                                                <div className="flex items-center gap-2">
                                                                                    <span className="text-green-600 font-medium text-xs w-8">ÂèñËªä</span>
                                                                                    {formatDateTime(order.start)}
                                                                                    <span className="text-xs text-slate-500 bg-slate-50 px-1 rounded border">@{order.pickupLocation || 'Êú™ÊåáÂÆö'}</span>
                                                                                </div>
                                                                                <div className="flex items-center gap-2">
                                                                                    <span className="text-red-600 font-medium text-xs w-8">ÈÇÑËªä</span>
                                                                                    {formatDateTime(order.end)}
                                                                                    <span className="text-xs text-slate-500 bg-slate-50 px-1 rounded border">@{order.returnLocation || 'Êú™ÊåáÂÆö'}</span>
                                                                                </div>
                                                                                {order.note && <div className="text-xs text-gray-400 mt-1 pl-10 border-l-2 border-gray-200 ml-1">{order.note}</div>}
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                );
                                                            })}

                                                            <button onClick={()=>{
                                                                setEditingOrder(null);
                                                                let defaultStart = `${filterDate}T10:00`;
                                                                if (dayOrders.length > 0) {
                                                                    const lastEnd = new Date(dayOrders[dayOrders.length-1].end);
                                                                    lastEnd.setHours(lastEnd.getHours() + 1);
                                                                    const y = lastEnd.getFullYear();
                                                                    const m = String(lastEnd.getMonth() + 1).padStart(2, '0');
                                                                    const d = String(lastEnd.getDate()).padStart(2, '0');
                                                                    const h = String(lastEnd.getHours()).padStart(2, '0');
                                                                    const min = String(lastEnd.getMinutes()).padStart(2, '0');
                                                                    defaultStart = `${y}-${m}-${d}T${h}:${min}`;
                                                                }
                                                                setOrderFormData({
                                                                    customer:'', 
                                                                    start: defaultStart, 
                                                                    end: '',
                                                                    vehicleId: v.id, 
                                                                    note:'', 
                                                                    status:'confirmed',
                                                                    pickupLocation: 'ÊàêÁî∞‰∫åËà™',
                                                                    returnLocation: 'ÊàêÁî∞‰∫åËà™'
                                                                });
                                                                setIsOrderModalOpen(true);
                                                            }} className="mt-4 w-full py-2.5 text-sm font-medium border border-dashed border-blue-400 text-blue-600 rounded bg-white hover:bg-blue-50 flex items-center justify-center gap-2 transition-colors shadow-sm">
                                                                <Plus size={16}/> Ê¥æÂñÆ
                                                            </button>
                                                        </div>
                                                    </div>
                                                )}
                                            </div>
                                        )
                                    })}
                                </div>
                            </div>
                        )}

                        {activeTab === 'vehicles' && (
                            <div className="space-y-4">
                                <button onClick={()=>{setEditingVehicle(null); setVehicleFormData({location: 'ÊàêÁî∞', plate: '', brand: 'Toyota', model: 'Alphard', feature: '', seats: 7, etc: '', tire: 'ÂÜ¨Ê∏à'}); setIsVehicleModalOpen(true)}} className="w-full py-3 bg-blue-600 text-white rounded shadow font-bold flex justify-center gap-2"><Plus/> Êñ∞Â¢ûËªäËºõ</button>
                                {vehicles.map(v => (
                                    <div key={v.id} className="bg-white p-4 rounded shadow-sm flex justify-between items-center">
                                        <div>
                                            <div className="font-bold">{v.plate} <span className="text-xs text-gray-500">({v.location})</span></div>
                                            <div className="text-sm text-gray-500">
                                                {v.model} 
                                                {v.feature ? ` / ${v.feature}` : ''}
                                                {v.tire ? ` (${v.tire})` : ''}
                                                {v.seats ? ` / ${v.seats} Â∫ß` : ''}
                                            </div>
                                            <div className="text-xs bg-gray-100 inline-block px-1 rounded mt-1">ETC: {v.etc||'ÁÑ°'}</div>
                                        </div>
                                        <div className="flex gap-2">
                                            <button onClick={()=>{setEditingVehicle(v); setVehicleFormData(v); setIsVehicleModalOpen(true)}} className="p-2 text-gray-400 hover:text-blue-600"><Edit3 size={18}/></button>
                                            <button onClick={()=>handleDeleteVehicle(v.id)} className="p-2 text-gray-400 hover:text-red-600"><Trash2 size={18}/></button>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}

                        {activeTab === 'orders' && (
                            <div className="space-y-4">
                                <button onClick={()=>{setEditingOrder(null); setOrderFormData({customer:'', start:'', end:'', vehicleId:'', note:'', status:'confirmed', pickupLocation: 'ÊàêÁî∞‰∫åËà™', returnLocation: 'ÊàêÁî∞‰∫åËà™'}); setIsOrderModalOpen(true)}} className="w-full py-3 bg-blue-600 text-white rounded shadow font-bold flex justify-center gap-2"><Plus/> Êñ∞Â¢ûË®ÇÂñÆ</button>
                                {orders.sort((a,b)=>new Date(b.start)-new Date(a.start)).map(o => {
                                    const v = vehicles.find(x=>x.id===o.vehicleId);
                                    return (
                                        <div key={o.id} className="bg-white p-4 rounded shadow-sm">
                                            <div className="flex justify-between mb-1">
                                                <span className="font-bold">{o.customer}</span>
                                                <span className="text-xs bg-blue-50 text-blue-600 px-2 py-1 rounded">{o.status}</span>
                                            </div>
                                            <div className="text-sm text-gray-800 mb-1">
                                                {v?.plate || 'ËªäËºõÂ∑≤Âà™Èô§'}
                                                {v?.feature ? ` (${v.feature})` : ''}
                                            </div>
                                            <div className="text-xs text-gray-500 mb-1 flex items-center gap-1">
                                                <span>{formatDateTime(o.start)}</span>
                                                <ArrowRight size={10} />
                                                <span>{formatDateTime(o.end)}</span>
                                            </div>
                                            <div className="text-xs text-slate-500 flex gap-2 mb-3">
                                                <span className="bg-slate-50 px-1 rounded border">Âèñ: {o.pickupLocation}</span>
                                                <span className="bg-slate-50 px-1 rounded border">ÈÇÑ: {o.returnLocation}</span>
                                            </div>
                                            <div className="flex justify-end gap-3 border-t pt-2">
                                                <button onClick={()=>{setEditingOrder(o); setOrderFormData(o); setIsOrderModalOpen(true)}} className="text-sm text-blue-600">Á∑®ËºØ</button>
                                                <button onClick={()=>handleDeleteOrder(o.id)} className="text-sm text-red-600">Âà™Èô§</button>
                                            </div>
                                        </div>
                                    )
                                })}
                            </div>
                        )}
                    </main>

                    <div className="fixed bottom-0 left-0 right-0 bg-white border-t flex justify-around p-3 z-20 text-xs">
                        <button onClick={()=>setActiveTab('dashboard')} className={`flex flex-col items-center ${activeTab==='dashboard'?'text-blue-600':'text-gray-400'}`}><Calendar size={20}/><span>ÁúãÊùø</span></button>
                        <button onClick={()=>setActiveTab('vehicles')} className={`flex flex-col items-center ${activeTab==='vehicles'?'text-blue-600':'text-gray-400'}`}><Car size={20}/><span>ËªäËºõ</span></button>
                        <button onClick={()=>setActiveTab('orders')} className={`flex flex-col items-center ${activeTab==='orders'?'text-blue-600':'text-gray-400'}`}><Users size={20}/><span>Ë®ÇÂñÆ</span></button>
                    </div>

                    {isOrderModalOpen && (
                        <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
                            <div className="bg-white w-full max-w-md rounded-lg p-5 max-h-[90vh] overflow-y-auto">
                                <h3 className="font-bold text-lg mb-4">{editingOrder?'Á∑®ËºØ':'Êñ∞Â¢û'}Ë®ÇÂñÆ</h3>
                                <form onSubmit={handleSaveOrder} className="space-y-3">
                                    <input placeholder="ÂÆ¢Êà∂ÂßìÂêç" className="w-full border p-2 rounded" value={orderFormData.customer} onChange={e=>setOrderFormData({...orderFormData, customer:e.target.value})} required/>
                                    
                                    <div className="grid grid-cols-2 gap-2">
                                        <div>
                                            <label className="text-xs block mb-1">ÂèñËªä</label>
                                            <input type="datetime-local" className="w-full border p-2 rounded text-sm" value={orderFormData.start} onChange={e=>setOrderFormData({...orderFormData, start:e.target.value})} required/>
                                        </div>
                                        <div>
                                            <label className="text-xs block mb-1">ÈÇÑËªä</label>
                                            <input type="datetime-local" className="w-full border p-2 rounded text-sm" value={orderFormData.end} onChange={e=>setOrderFormData({...orderFormData, end:e.target.value})} required/>
                                        </div>
                                    </div>

                                    {/* Âú∞ÈªûÈÅ∏Êìá */}
                                    <datalist id="location-options">
                                        {PRESET_LOCATIONS.map(loc => <option key={loc} value={loc} />)}
                                    </datalist>
                                    <div className="grid grid-cols-2 gap-2">
                                        <div>
                                            <label className="text-xs block mb-1">‰∫§ËªäÂú∞Èªû</label>
                                            <input 
                                                list="location-options"
                                                className="w-full border p-2 rounded text-sm" 
                                                placeholder="ÈÅ∏ÊìáÊàñËº∏ÂÖ•"
                                                value={orderFormData.pickupLocation} 
                                                onChange={e=>setOrderFormData({...orderFormData, pickupLocation:e.target.value})} 
                                            />
                                        </div>
                                        <div>
                                            <label className="text-xs block mb-1">ÈÇÑËªäÂú∞Èªû</label>
                                            <input 
                                                list="location-options"
                                                className="w-full border p-2 rounded text-sm" 
                                                placeholder="ÈÅ∏ÊìáÊàñËº∏ÂÖ•"
                                                value={orderFormData.returnLocation} 
                                                onChange={e=>setOrderFormData({...orderFormData, returnLocation:e.target.value})} 
                                            />
                                        </div>
                                    </div>

                                    <div className="space-y-2 max-h-60 overflow-y-auto pr-1 border-t pt-2">
                                        <div className="text-xs text-gray-500 mb-1">ÈÅ∏ÊìáËªäËºõ:</div>
                                        {vehicles.map(v=>{
                                            const available = isVehicleAvailable(v.id, orderFormData.start, orderFormData.end, editingOrder?.id);
                                            // ‰øÆÊ≠£ÔºöÁßªÈô§ Number() ËΩâÂûãÔºåÂõ†ÁÇ∫ Firestore ID ÊòØÂ≠ó‰∏≤
                                            const isSelected = orderFormData.vehicleId === v.id;
                                            return (
                                                <label 
                                                    key={v.id} 
                                                    className={`
                                                        relative flex items-center justify-between p-3 border rounded-lg cursor-pointer transition-all
                                                        ${isSelected ? 'border-blue-500 bg-blue-50 ring-1 ring-blue-500' : 'border-gray-200 hover:bg-gray-50'}
                                                        ${!available ? 'opacity-50 bg-gray-100 cursor-not-allowed' : ''}
                                                    `}
                                                >
                                                    <div className="flex items-center gap-3">
                                                        {/* ÈÅ∏ÂèñÁãÄÊÖãÔºöÊîπÁî® CheckCircle ÂúñÁ§∫ */}
                                                        {isSelected ? (
                                                            <CheckCircle className="w-5 h-5 text-blue-600" />
                                                        ) : (
                                                            <div className="w-5 h-5 rounded-full border border-gray-400" />
                                                        )}
                                                        
                                                        <div className="flex flex-col">
                                                            <div className="font-bold text-slate-800 text-sm">
                                                                {v.plate} 
                                                            </div>
                                                            <div className="text-xs text-gray-500 flex flex-wrap gap-1 items-center">
                                                                <span>{v.model}</span>
                                                                {v.feature && (
                                                                    <>
                                                                        <span className="text-gray-300">|</span>
                                                                        <span className="font-medium text-blue-600">{v.feature}</span>
                                                                    </>
                                                                )}
                                                                {v.tire && (
                                                                    <>
                                                                        <span className="text-gray-300">|</span>
                                                                        <span>{v.tire}</span>
                                                                    </>
                                                                )}
                                                                {v.seats && (
                                                                    <>
                                                                        <span className="text-gray-300">|</span>
                                                                        <span>{v.seats} Â∫ß</span>
                                                                    </>
                                                                )}
                                                            </div>
                                                        </div>
                                                    </div>
                                                    
                                                    {!available && <span className="text-xs text-red-500 font-bold px-2 py-1 bg-red-100 rounded">Â∑≤ÁßüÂÄü</span>}
                                                    
                                                    {/* Èö±ËóèÁöÑÂéüÁîü Radio */}
                                                    <input 
                                                        type="radio" 
                                                        name="vid" 
                                                        className="hidden" 
                                                        checked={isSelected} 
                                                        onChange={()=> available && setOrderFormData({...orderFormData, vehicleId:v.id})} 
                                                        disabled={!available} 
                                                    />
                                                </label>
                                            );
                                        })}
                                    </div>
                                    <div className="flex gap-2 justify-end pt-2 border-t mt-2">
                                        <button type="button" onClick={()=>setIsOrderModalOpen(false)} className="px-4 py-2 border rounded">ÂèñÊ∂à</button>
                                        <button type="submit" className="px-4 py-2 bg-blue-600 text-white rounded">ÂÑ≤Â≠ò</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}

                    {isVehicleModalOpen && (
                        <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
                            <div className="bg-white w-full max-w-md rounded-lg p-5">
                                <h3 className="font-bold text-lg mb-4">{editingVehicle?'Á∑®ËºØ':'Êñ∞Â¢û'}ËªäËºõ</h3>
                                <form onSubmit={handleSaveVehicle} className="space-y-3">
                                    <input placeholder="ËªäÁâå" className="w-full border p-2 rounded" value={vehicleFormData.plate} onChange={e=>setVehicleFormData({...vehicleFormData, plate:e.target.value})} required/>
                                    <div className="flex gap-2">
                                        <input placeholder="ËªäÂûã" className="w-full border p-2 rounded" value={vehicleFormData.model} onChange={e=>setVehicleFormData({...vehicleFormData, model:e.target.value})} required/>
                                        <input placeholder="ÁâπÂæµ (Â¶Ç: HEV 4WD)" className="w-full border p-2 rounded" value={vehicleFormData.feature} onChange={e=>setVehicleFormData({...vehicleFormData, feature:e.target.value})} />
                                    </div>
                                    <div className="flex gap-2">
                                        <input type="number" placeholder="Â∫ß‰ΩçÊï∏" className="w-1/3 border p-2 rounded" value={vehicleFormData.seats} onChange={e=>setVehicleFormData({...vehicleFormData, seats:e.target.value})} />
                                        <select className="w-2/3 border p-2 rounded" value={vehicleFormData.tire} onChange={e=>setVehicleFormData({...vehicleFormData, tire:e.target.value})}>
                                            <option value="ÂÜ¨Ê∏à">ÂÜ¨ËÉé</option><option value="Â§èÊ∏à">Â§èËÉé</option>
                                        </select>
                                    </div>
                                    <div className="space-y-2">
                                        <select className="w-full border p-2 rounded" value={vehicleFormData.etc} onChange={e=>setVehicleFormData({...vehicleFormData, etc:e.target.value})}>
                                                <option value="">-- ETC ÈÖçÁΩÆ --</option>
                                                {Array.from(new Set(vehicles.map(v=>v.etc).filter(Boolean))).concat(newEtcNumber ? [newEtcNumber] : []).map(etc => (
                                                    <option key={etc} value={etc}>{etc}</option>
                                                ))}
                                        </select>
                                        <div className="flex gap-2">
                                            <input placeholder="Êñ∞Âç°Ëôü" className="w-full border p-2 rounded text-sm" value={newEtcNumber} onChange={e=>setNewEtcNumber(e.target.value)}/>
                                            <button type="button" onClick={()=>newEtcNumber && (setVehicleFormData({...vehicleFormData, etc:newEtcNumber}), setNewEtcNumber(''))} className="px-3 py-1 bg-green-500 text-white rounded text-xs whitespace-nowrap">Êñ∞Â¢û</button>
                                        </div>
                                    </div>
                                    <div className="flex gap-2 justify-end pt-2">
                                        <button type="button" onClick={()=>setIsVehicleModalOpen(false)} className="px-4 py-2 border rounded">ÂèñÊ∂à</button>
                                        <button type="submit" className="px-4 py-2 bg-blue-600 text-white rounded">ÂÑ≤Â≠ò</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<VehicleOrderSystem />);
    </script>
</body>
</html>
