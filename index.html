<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç§Ÿè»Šäº¤è»Šç´€éŒ„ç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ä½¿ç”¨ Inter å­—é«” */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }
        /* è‡ªå®šç¾©æ»¾å‹•æ¢æ¨£å¼ */
        .log-container::-webkit-scrollbar {
            height: 8px;
        }
        .log-container::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }
        .log-container::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
        /* æ¨¡æ…‹è¦–çª—èƒŒæ™¯ */
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.5);
        }
        /* ç¢ºä¿å¡ç‰‡å…§éƒ¨æ»¾å‹• */
        .modal-content-scroll {
            max-height: calc(90vh - 100px); /* 90vh minus header/footer padding */
            overflow-y: auto;
        }
        /* é‡å°æ—¥æ–‡è»Šç‰Œçš„æ›è¡Œå•é¡Œé€²è¡Œä¿®æ­£ */
        .plate-fix {
            word-break: break-all;
            /* å…è¨±é•·å­—ä¸²åœ¨ä¸ç ´å£ä½ˆå±€çš„æƒ…æ³ä¸‹æ›è¡Œ */
        }
        /* æ—¥æ›†æ ¼å­æ¨£å¼ */
        .calendar-day {
            min-height: 80px;
            padding-top: 24px; /* ç•™çµ¦æ—¥æœŸæ•¸å­—çš„ç©ºé–“ */
            cursor: default; /* å–æ¶ˆæ»‘é¼ æŒ‡æ¨™è®ŠåŒ–ï¼Œé¿å…èª¤è§¸ */
            transition: background-color 0.15s;
            position: relative;
        }
        .calendar-day:hover {
            background-color: #f3f4f6;
        }
        /* æ—¥æœŸæ•¸å­—çš„çµ•å°å®šä½ */
        .day-number {
            position: absolute;
            top: 4px;
            left: 4px;
            font-size: 0.875rem; /* text-sm */
            font-weight: 600; /* semi-bold */
        }
        /* ------------------------------------------- */
        /* æ–°å¢ï¼šæ—¥æ›†æ’ç¨‹é•·æ¢æ¨£å¼ */
        /* ------------------------------------------- */
        .calendar-grid-container {
            position: relative;
        }
        .event-bar {
            position: absolute;
            height: 20px; /* é•·æ¢é«˜åº¦ */
            border-radius: 4px;
            padding: 0 4px;
            color: white;
            font-size: 0.75rem; /* text-xs */
            font-weight: 500;
            cursor: pointer;
            z-index: 10;
            overflow: hidden;
            white-space: nowrap;
            transition: transform 0.1s;
            pointer-events: auto; /* ç¢ºä¿å¯ä»¥é»æ“Š */
            margin: 2px 0; /* å‚ç›´é–“è· */
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            line-height: 20px; /* ç¢ºä¿æ–‡å­—å‚ç›´å±…ä¸­ */
        }
        .event-bar:hover {
            transform: scale(1.01);
            box-shadow: 0 3px 6px rgba(0,0,0,0.2);
        }
        /* ä¿®æ­£æ—¥æ›† Grid å®¹å™¨ä»¥å®¹ç´é•·æ¢ */
        /* é€™è£¡çš„è¨­å®šä¸éœ€è¦ï¼Œå› ç‚ºæˆ‘å€‘ç”¨ JS èª¿æ•´äº† min-height */
        /* #calendar-events-overlay, #calendar-grid {
             grid-auto-rows: minmax(80px, auto); 
        } */
        
    </style>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#4f46e5">
    <link rel="manifest" href="manifest.webmanifest">
</head>
<body class="p-4 md:p-8">
    <div class="max-w-7xl mx-auto">
        <header class="mb-8 p-4 bg-white shadow-lg rounded-xl">
            <h1 class="3xl font-bold text-gray-800 mb-2">ç§Ÿè»Šäº¤è»Šç´€éŒ„æ§ç®¡ä¸­å¿ƒ</h1>
            <p class="text-gray-500">ä½¿ç”¨ Firestore å„²å­˜ç´€éŒ„ï¼Œè³‡æ–™å³æ™‚åŒæ­¥ã€‚ç•¶å‰ä½¿ç”¨è€… ID: <span id="user-id-display" class="font-mono text-xs bg-gray-100 p-1 rounded">è¼‰å…¥ä¸­...</span></p>
        </header>
        
        <button id="toggle-calendar" class="mb-4 px-4 py-2 bg-indigo-500 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-600 transition duration-150 w-full md:w-auto flex items-center justify-center">
            ğŸ“… æŸ¥çœ‹æ’ç¨‹æ—¥æ›†
        </button>
        <div id="calendar-container" class="bg-white p-4 rounded-xl shadow-xl mb-6 hidden">
            <div class="flex justify-between items-center mb-4">
                <button id="prev-month" class="p-2 bg-gray-200 rounded-full hover:bg-gray-300">
                    <svg class="w-6 h-6 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                </button>
                <h3 id="current-month-year" class="text-xl font-bold text-gray-800"></h3>
                <button id="next-month" class="p-2 bg-gray-200 rounded-full hover:bg-gray-300">
                    <svg class="w-6 h-6 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                </button>
            </div>
            <div class="grid grid-cols-7 gap-1 text-center font-semibold text-sm text-gray-600 border-b pb-2">
                <div>æ—¥</div>
                <div>ä¸€</div>
                <div>äºŒ</div>
                <div>ä¸‰</div>
                <div>å››</div>
                <div>äº”</div>
                <div>å…­</div>
            </div>
            <div id="calendar-grid-container" class="calendar-grid-container">
                 <div id="calendar-grid" class="grid grid-cols-7 gap-1">
                    </div>
                 <div id="calendar-events-overlay" class="absolute inset-0 grid grid-cols-7 gap-1 pointer-events-none">
                    </div>
            </div>
        </div>
        <div class="mb-4 p-4 bg-indigo-50 border-l-4 border-indigo-600 rounded-lg shadow-md">
            <p class="text-sm font-semibold text-indigo-700">ğŸ“† ä»Šæ—¥æ—¥æœŸ: <span id="current-date-display" class="font-mono"></span></p>
            <p class="text-lg font-bold text-red-700 mt-1">ğŸ’¡ è¡Œç¨‹æç¤º:</p>
            <div id="schedule-tip" class="space-y-1">è¼‰å…¥ä¸­...</div>
        </div>
        <div id="message-box" class="mb-6 p-3 rounded-lg text-sm transition-all duration-300 hidden"></div>
        <div class="bg-white p-6 shadow-xl rounded-xl mb-10">
            <h2 class="text-xl font-semibold text-gray-700 mb-4 border-b pb-2">æ–°å¢ã€Œäº¤è»Šã€ç´€éŒ„ (é–‹å•Ÿæ–°ç§Ÿè³ƒé€±æœŸ)</h2>
            <form id="record-form" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                
                <input type="hidden" id="record-action" value="äº¤è»Š">
                <div>
                    <label for="record-date" class="block text-sm font-medium text-gray-700">äº¤è»Šæ—¥æœŸ</label>
                    <input type="date" id="record-date" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border focus:border-indigo-500 focus:ring-indigo-500">
                </div>
                <div>
                    <label for="record-time" class="block text-sm font-medium text-gray-700">äº¤è»Šæ™‚é–“</label>
                    <input type="time" id="record-time" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border focus:border-indigo-500 focus:ring-indigo-500">
                </div>
                <div>
                    <label for="record-location" class="block text-sm font-medium text-gray-700">äº¤è»Šåœ°é»</label>
                    <input type="text" id="record-location" list="location-list" placeholder="è«‹é¸æ“‡æˆ–è¼¸å…¥äº¤è»Šåœ°é»" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border focus:border-indigo-500 focus:ring-indigo-500">
                </div>
                
                <div>
                    <label for="record-plate" class="block text-sm font-medium text-gray-700">è»Šç‰Œ (ETC å¡è™Ÿ)</label>
                    <select id="record-plate" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border focus:border-indigo-500 focus:ring-indigo-500">
                        <option value="" disabled selected>è«‹é¸æ“‡è»Šç‰Œ (ETC å¡è™Ÿ)</option>
                    </select>
                </div>
                
                <div>
                    <label for="record-mileage" class="block text-sm font-medium text-gray-700">èµ·å§‹é‡Œç¨‹æ•¸ (Km)</label>
                    <input type="number" id="record-mileage" placeholder="ä¾‹å¦‚: 12500" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border focus:border-indigo-500 focus:ring-indigo-500">
                </div>
                <div class="md:col-span-2">
                    <label for="record-notes" class="block text-sm font-medium text-gray-700">éœ€æ±‚ / å‚™è¨» (äº¤è»Šè³‡è¨Š)</label>
                    <textarea id="record-notes" rows="2" placeholder="ä¾‹å¦‚: å…©å¼µå…’ç«¥åº§æ¤…(2æ­²è·Ÿ5æ­²)ï¼›è»Šå‹: Toyota 40ç³»" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border focus:border-indigo-500 focus:ring-indigo-500"></textarea>
                </div>
                
                <div class="md:col-span-3 grid grid-cols-1 sm:grid-cols-3 gap-4 p-4 border rounded-lg bg-gray-50 mt-4">
                    <div class="sm:col-span-3 text-sm font-semibold text-gray-700 border-b pb-2 mb-2">å®¢æˆ¶è³‡æ–™ (é¸å¡«)</div>
                    <div>
                        <label for="customer-name" class="block text-sm font-medium text-gray-700">å®¢æˆ¶å§“å</label>
                        <input type="text" id="customer-name" placeholder="ä¾‹å¦‚: ç‹å°æ˜" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border focus:border-indigo-500 focus:ring-indigo-500">
                    </div>
                    <div>
                        <label for="customer-phone" class="block text-sm font-medium text-gray-700">è¯çµ¡é›»è©±</label>
                        <input type="tel" id="customer-phone" placeholder="ä¾‹å¦‚: 0912345678" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border focus:border-indigo-500 focus:ring-indigo-500">
                    </div>
                    <div>
                        <label for="customer-dob" class="block text-sm font-medium text-gray-700">å‡ºç”Ÿå¹´æœˆæ—¥</label>
                        <input type="date" id="customer-dob" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border focus:border-indigo-500 focus:ring-indigo-500">
                    </div>
                </div>
                <div class="md:col-span-3 flex justify-end">
                    <button type="submit" id="submit-button" class="mt-4 px-6 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition duration-150 disabled:bg-indigo-400">
                        æ–°å¢äº¤è»Šç´€éŒ„
                    </button>
                </div>
            </form>
        </div>
        <div class="bg-white p-6 shadow-xl rounded-xl">
            <h2 class="text-xl font-semibold text-gray-700 mb-4 border-b pb-2">æ‰€æœ‰ç§Ÿè³ƒé€±æœŸç´€éŒ„</h2>
            
            <div class="flex flex-col sm:flex-row gap-4 mb-4">
                <input type="text" id="search-input" placeholder="æŸ¥è©¢ï¼šè¼¸å…¥åœ°é»ã€è»Šç‰Œã€å‚™è¨»é—œéµå­—" class="flex-grow p-2 border rounded-lg focus:border-indigo-500">
                <button onclick="window.refreshRecords()" class="px-3 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition duration-150 flex-shrink-0">
                    ğŸ”„ é‡æ–°æ•´ç†
                </button>
                <button id="sort-button" class="p-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition duration-150 flex-shrink-0">
                    <span id="sort-icon">ğŸ“…</span> æ’åº: ç”±æ–°åˆ°èˆŠ
                </button>
            </div>
            <div id="records-list-container" class="space-y-4">
                </div>
            
            <p id="no-records-message" class="text-center py-10 text-gray-500 hidden">ç›®å‰æ²’æœ‰ä»»ä½•ç´€éŒ„ã€‚</p>
        </div>
    </div>
    <div id="collection-modal" class="fixed inset-0 z-50 hidden modal-backdrop flex items-center justify-center p-4" aria-modal="true" role="dialog">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg p-6 transform transition-all duration-300 scale-95 opacity-0 modal-content-scroll" id="collection-modal-content">
            <h3 class="text-xl font-bold text-gray-800 border-b pb-3 mb-4" id="modal-title"></h3>
            
            <p class="text-sm text-gray-600 mb-4">æ­£åœ¨ç‚º <span id="modal-plate-display" class="font-bold text-indigo-600"></span> è¨˜éŒ„è³‡è¨Šã€‚</p>
            <form id="collection-form">
                <input type="hidden" id="modal-record-id">
                <input type="hidden" id="modal-mode"> <div class="grid grid-cols-2 gap-4">
                    <div id="modal-date-container">
                        <label for="collection-date" class="block text-sm font-medium text-gray-700">æ”¶è»Šæ—¥æœŸ</label>
                        <input type="date" id="collection-date" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border focus:border-indigo-500 focus:ring-indigo-500">
                    </div>
                    <div id="modal-time-container">
                        <label for="collection-time" class="block text-sm font-medium text-gray-700">æ”¶è»Šæ™‚é–“</label>
                        <input type="time" id="collection-time" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border focus:border-indigo-500 focus:ring-indigo-500">
                    </div>
                    <div class="col-span-2" id="modal-location-container">
                        <label for="collection-location" class="block text-sm font-medium text-gray-700">æ”¶è»Šåœ°é»</label>
                        <input type="text" id="collection-location" list="location-list" placeholder="è«‹é¸æ“‡æˆ–è¼¸å…¥æ”¶è»Šåœ°é»" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border focus:border-indigo-500 focus:ring-indigo-500">
                    </div>
                    <div class="col-span-2" id="modal-mileage-container">
                        <label for="end-mileage" class="block text-sm font-medium text-gray-700">çµæŸé‡Œç¨‹æ•¸ (Km)</label>
                        <input type="number" id="end-mileage" placeholder="è«‹è¼¸å…¥æ”¶è»Šæ™‚é‡Œç¨‹æ•¸" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border focus:border-indigo-500 focus:ring-indigo-500">
                        <p class="text-xs text-gray-500 mt-1">äº¤è»Šé‡Œç¨‹æ•¸: <span id="modal-start-mileage"></span> Km</p>
                    </div>
                </div>
                <div class="flex justify-end space-x-3 mt-6">
                    <button type="button" onclick="window.closeCollectionModal()" class="px-4 py-2 text-gray-600 bg-gray-200 rounded-lg hover:bg-gray-300 transition duration-150">å–æ¶ˆ</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 transition duration-150" id="collection-submit-btn">
                        ç¢ºèªä¸¦å„²å­˜
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="edit-modal" class="fixed inset-0 z-50 hidden modal-backdrop flex items-center justify-center p-4" aria-modal="true" role="dialog">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl p-6 transform transition-all duration-300 scale-95 opacity-0 modal-content-scroll" id="edit-modal-content">
            <h3 class="text-xl font-bold text-gray-800 border-b pb-3 mb-4">ç·¨è¼¯ç§Ÿè³ƒé€±æœŸç´€éŒ„</h3>
            
            <form id="edit-form">
                <input type="hidden" id="edit-record-id">
                
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div class="p-4 border rounded-lg bg-indigo-50 space-y-3">
                        <h4 class="font-bold text-lg text-indigo-700 border-b pb-2 mb-3">äº¤è»Šè³‡è¨Š (Delivery)</h4>
                        
                        <div>
                            <label for="edit-plate" class="block text-sm font-medium text-gray-700">è»Šç‰Œ (ä¸å¯ä¿®æ”¹)</label>
                            <input type="text" id="edit-plate" readonly class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 bg-gray-200 text-gray-600">
                        </div>
                        
                        <div>
                            <label for="edit-delivery-date" class="block text-sm font-medium text-gray-700">äº¤è»Šæ—¥æœŸ</label>
                            <input type="date" id="edit-delivery-date" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border">
                        </div>
                        
                        <div>
                            <label for="edit-delivery-time" class="block text-sm font-medium text-gray-700">äº¤è»Šæ™‚é–“</label>
                            <input type="time" id="edit-delivery-time" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border">
                        </div>
                        
                        <div>
                            <label for="edit-delivery-location" class="block text-sm font-medium text-gray-700">äº¤è»Šåœ°é»</label>
                            <input type="text" id="edit-delivery-location" list="location-list" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border">
                        </div>
                        
                        <div>
                            <label for="edit-start-mileage" class="block text-sm font-medium text-gray-700">èµ·å§‹é‡Œç¨‹æ•¸ (Km)</label>
                            <input type="number" id="edit-start-mileage" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border">
                        </div>
                    </div>
                    <div class="p-4 border rounded-lg bg-yellow-50 space-y-3">
                        <h4 class="font-bold text-lg text-yellow-700 border-b pb-2 mb-3">æ”¶è»Šè³‡è¨Š (Collection)</h4>
                        
                        <div>
                            <label for="edit-collection-date" class="block text-sm font-medium text-gray-700">æ”¶è»Šæ—¥æœŸ</label>
                            <input type="date" id="edit-collection-date" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border">
                        </div>
                        
                        <div>
                            <label for="edit-collection-time" class="block text-sm font-medium text-gray-700">æ”¶è»Šæ™‚é–“</label>
                            <input type="time" id="edit-collection-time" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border">
                        </div>
                        
                        <div>
                            <label for="edit-collection-location" class="block text-sm font-medium text-gray-700">æ”¶è»Šåœ°é»</label>
                             <input type="text" id="edit-collection-location" list="location-list" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border">
                        </div>
                        
                        <div>
                            <label for="edit-end-mileage" class="block text-sm font-medium text-gray-700">çµæŸé‡Œç¨‹æ•¸ (Km)</label>
                            <input type="number" id="edit-end-mileage" placeholder="å¾…ç™»éŒ„å‰‡ç•™ç©º" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border">
                        </div>
                    </div>
                    
                    <div class="p-4 border rounded-lg bg-gray-50 space-y-3">
                        <h4 class="font-bold text-lg text-gray-700 border-b pb-2 mb-3">å®¢æˆ¶è³‡è¨Šèˆ‡å‚™è¨»</h4>
                        
                        <div>
                            <label for="edit-customer-name" class="block text-sm font-medium text-gray-700">å®¢æˆ¶å§“å</label>
                            <input type="text" id="edit-customer-name" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border">
                        </div>
                        
                        <div>
                            <label for="edit-customer-phone" class="block text-sm font-medium text-gray-700">è¯çµ¡é›»è©±</label>
                            <input type="tel" id="edit-customer-phone" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border">
                        </div>
                        <div>
                            <label for="edit-customer-dob" class="block text-sm font-medium text-gray-700">å‡ºç”Ÿå¹´æœˆæ—¥</label>
                            <input type="date" id="edit-customer-dob" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border">
                        </div>
                        
                        <div>
                            <label for="edit-notes" class="block text-sm font-medium text-gray-700">éœ€æ±‚ / å‚™è¨»</label>
                            <textarea id="edit-notes" rows="3" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border"></textarea>
                        </div>
                    </div>
                </div>
                <div class="flex justify-end space-x-3 mt-6">
                    <button type="button" onclick="window.closeEditModal()" class="px-4 py-2 text-gray-600 bg-gray-200 rounded-lg hover:bg-gray-300 transition duration-150">å–æ¶ˆ</button>
                    <button type="submit" class="px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition duration-150" id="edit-submit-btn">
                        ç¢ºèªä¿®æ”¹ä¸¦å„²å­˜
                    </button>
                </div>
            </form>
        </div>
    </div>
    <datalist id="location-list">
        </datalist>
    <script type="module">
        // IIFE Start: Wrap the initialization logic to prevent global scope conflicts
        
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, deleteDoc, doc, updateDoc, setLogLevel, Timestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        (function() { 
        
        // è¨­å®š Firebase Debug Log
        setLogLevel('Debug');
        // =================================================================
        // *** æ‚¨çš„ Firebase å°ˆæ¡ˆé…ç½®å·²æˆåŠŸè¼‰å…¥ï¼ ***
        // =================================================================
        const firebaseConfig = {
            apiKey: "AIzaSyAqksNR1a1Tf4OgL8X2ezT8u5rlFygNHPc",
            authDomain: "rentalcarlog-app.firebaseapp.com",
            projectId: "rentalcarlog-app",
            storageBucket: "rentalcarlog-app.firebasestorage.app",
            messagingSenderId: "68461236293",
            appId: "1:68461236293:web:2ab0179cc52585ab74932c",
            measurementId: "G-C7LWGH36JY"
        };
        const YOUR_PROJECT_ID = "rentalcarlog-app"; 
        // =================================================================
        // =================================================================
        // *** å›ºå®šè»Šç‰Œèˆ‡ ETC å¡è™Ÿå°æ‡‰è¡¨ (è»Šç‰Œä¸‹æ‹‰é¸å–®ç”¨) ***
        // =================================================================
        const CAR_ETC_MAPPING = {
            "ãªã«ã‚334ã‚8888 40ç³»": "9160 0000 1326 8609",
            "å’Œæ³‰330ã‚3333 7åº§ ä¸­æ–‡å°èˆª": "9160 0000 1326 6207",
            "æˆç”°331ã‚7777 ç¸½çµ±åº§": "9160 0000 1326 6009",
            "æˆç”°331ã‚88 4WD 8åº§": "9160 0000 1410 6501",
        };
        // =================================================================
        // *** åœ°é»é¸é …åˆ—è¡¨ (å·²é‚„åŸ) ***
        // =================================================================
        const LOCATION_OPTIONS = [
            "æˆç”°ç©ºæ¸¯T1",
            "æˆç”°ç©ºæ¸¯T2",
            "ç¾½ç”°ç©ºæ¸¯T3",
            "æ±äº¬"
        ]; 
        // =================================================================
        
        // === é¡è‰²å®šç¾© (New) ===
        const PLATE_COLORS = [
            '#ef4444', // Red 500
            '#f97316', // Orange 500
            '#eab308', // Yellow 500
            '#22c55e', // Green 500
            '#06b6d4', // Cyan 500
            '#3b82f6', // Blue 500
            '#6366f1', // Indigo 500
            '#a855f7', // Violet 500
            '#ec4899', // Pink 500
        ];
        // === é¡è‰²å®šç¾©çµæŸ ===
        let app;
        let db;
        let auth;
        let userId = null;
        let isAuthReady = false;
        let allRecords = []; // å„²å­˜å¾ Firestore ç²å–çš„æ‰€æœ‰ç´€éŒ„
        let sortDirection = 'desc'; // 'desc' (æ–°åˆ°èˆŠ) æˆ– 'asc' (èˆŠåˆ°æ–°)
        
        let currentCalendarDate = new Date(); // New: ç”¨æ–¼æ—¥æ›†é¡¯ç¤º
        const messageBox = document.getElementById('message-box');
        const recordsListContainer = document.getElementById('records-list-container'); // è®Šæ›´åç¨±ç‚º List Container
        const noRecordsMessage = document.getElementById('no-records-message');
        const userIdDisplay = document.getElementById('user-id-display');
        const sortButton = document.getElementById('sort-button');
        const sortIcon = document.getElementById('sort-icon');
        const plateSelect = document.getElementById('record-plate');
        // åœ°é»å…ƒç´ ç¾åœ¨æ˜¯ Input (é€é list å±¬æ€§é€£æ¥ datalist)
        const locationSelect = document.getElementById('record-location'); 
        const collectionLocationSelect = document.getElementById('collection-location'); 
        
        // æ—¥æ›†å…ƒç´  (å·²é‚„åŸ)
        const calendarContainer = document.getElementById('calendar-container');
        const currentMonthYear = document.getElementById('current-month-year');
        const calendarGrid = document.getElementById('calendar-grid');
        const toggleCalendarButton = document.getElementById('toggle-calendar');
        const calendarEventsOverlay = document.getElementById('calendar-events-overlay'); 
        
        // æ—¥æœŸå€é–“ç¯©é¸å…ƒç´  (å·²ç§»é™¤)
        // const filterStartDateInput = document.getElementById('filter-start-date');
        // const filterEndDateInput = document.getElementById('filter-end-date');
        
        // æ–°å¢çš„å®¢æˆ¶è³‡æ–™è¼¸å…¥æ¬„ä½
        const customerNameInput = document.getElementById('customer-name');
        const customerPhoneInput = document.getElementById('customer-phone');
        const customerDobInput = document.getElementById('customer-dob');
        
        // ç·¨è¼¯æ¨¡æ…‹è¦–çª—å…ƒç´ 
        const editPlateInput = document.getElementById('edit-plate');
        const editDeliveryDateInput = document.getElementById('edit-delivery-date');
        const editDeliveryTimeInput = document.getElementById('edit-delivery-time');
        const editDeliveryLocationSelect = document.getElementById('edit-delivery-location');
        const editStartMileageInput = document.getElementById('edit-start-mileage');
        const editCollectionDateInput = document.getElementById('edit-collection-date');
        const editCollectionTimeInput = document.getElementById('edit-collection-time');
        const editCollectionLocationSelect = document.getElementById('edit-collection-location');
        const editEndMileageInput = document.getElementById('edit-end-mileage');
        const editCustomerNameInput = document.getElementById('edit-customer-name');
        const editCustomerPhoneInput = document.getElementById('edit-customer-phone');
        const editCustomerDobInput = document.getElementById('edit-customer-dob');
        const editNotesInput = document.getElementById('edit-notes');
        /** é¡¯ç¤ºæ‡‰ç”¨ç¨‹å¼è¨Šæ¯ */
        function displayMessage(text, type = 'info') {
            messageBox.textContent = text;
            messageBox.className = 'mb-6 p-3 rounded-lg text-sm transition-all duration-300';
            messageBox.classList.remove('hidden');
            switch (type) {
                case 'success':
                    messageBox.classList.add('bg-green-100', 'text-green-800');
                    break;
                case 'error':
                    messageBox.classList.add('bg-red-100', 'text-red-800');
                    break;
                case 'info':
                default:
                    messageBox.classList.add('bg-blue-100', 'text-blue-800');
                    break;
            }
            setTimeout(() => {
                messageBox.classList.add('hidden');
            }, 5000);
        }
        /** æ ¼å¼åŒ–æ—¥æœŸç‚º YYYY-MM-DD æ ¼å¼ */
        function getFormattedDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        /** æ ¼å¼åŒ–æ—¥æœŸç‚º YYYY-MM-DD HH:MM æ ¼å¼ */
        function createDateTime(dateStr, timeStr) {
            return new Date(`${dateStr}T${timeStr}:00`);
        }
        
        /** æ ¼å¼åŒ–æ—¥æœŸå­—ä¸²ç‚º Date ç‰©ä»¶ï¼Œä¸¦å°‡æ™‚é–“æ­¸é›¶ (ç”¨æ–¼ç¯„åœæ¯”è¼ƒ) */
        function dateStringToStartOfDay(dateStr) {
             if (!dateStr) return null;
             // ç¢ºä¿æ™‚å€ä¸æœƒå½±éŸ¿æ—¥æœŸæ¯”è¼ƒ (ä½¿ç”¨ UTC)
             const date = new Date(dateStr + 'T00:00:00Z');
             return isNaN(date) ? null : date;
        }
        // --- Firebase åˆå§‹åŒ–å’Œèªè­‰ ---
        function initFirebase() {
            const submitButton = document.getElementById('submit-button'); // å–å¾—æŒ‰éˆ•å…ƒç´ 
            
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                // èªè­‰ç‹€æ…‹è®Šæ›´ç›£è½
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        userIdDisplay.textContent = userId;
                        isAuthReady = true;
                        submitButton.disabled = false; // èªè­‰æˆåŠŸï¼Œå•Ÿç”¨æŒ‰éˆ•
                        console.log("Firebase èªè­‰å®Œæˆï¼ŒUser ID:", userId);
                        fetchRecords(); // èªè­‰å®Œæˆå¾Œé–‹å§‹ç›£è½ç´€éŒ„
                    } else {
                        // é‹è¡Œåœ¨æœ¬åœ°ç’°å¢ƒï¼Œæˆ‘å€‘ä½¿ç”¨æ¨™æº–çš„åŒ¿åç™»å…¥
                        try {
                             await signInAnonymously(auth);
                        } catch (error) {
                            console.error("èªè­‰å¤±æ•—:", error);
                            displayMessage("èªè­‰å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ– Firebase å°ˆæ¡ˆè¨­å®šã€‚", 'error');
                            submitButton.disabled = true; // èªè­‰å¤±æ•—ï¼Œç¦ç”¨æŒ‰éˆ•
                            userIdDisplay.textContent = 'èªè­‰å¤±æ•— (é€£ç·šç•°å¸¸)'; 
                            isAuthReady = true; 
                        }
                    }
                });
            } catch (e) {
                console.error("Firebase åˆå§‹åŒ–å¤±æ•—:", e);
                displayMessage(`Firebase åˆå§‹åŒ–å¤±æ•—ã€‚éŒ¯èª¤è¨Šæ¯: ${e.message}ã€‚ç„¡æ³•å„²å­˜ç´€éŒ„ã€‚`, 'error'); 
                submitButton.disabled = true; // ç¦ç”¨æŒ‰éˆ•
                userIdDisplay.textContent = 'åˆå§‹åŒ–éŒ¯èª¤'; 
                isAuthReady = true;
            }
        }
        /** ç²å– Firestore Collection Path (å…±äº«è·¯å¾‘) */
        function getCollectionPath() {
            // å”ä½œè·¯å¾‘: æ‰€æœ‰ç™»å…¥çš„ä½¿ç”¨è€… (A & B) éƒ½å°‡å­˜å–æ­¤è·¯å¾‘
            const sharedAppId = 'd34356109-rental-log-app'; // å›ºå®šçš„æ‡‰ç”¨ç¨‹å¼è­˜åˆ¥ç¢¼
            const sharedCollectionName = 'rental_records_shared';
            
            return `artifacts/${sharedAppId}/public/data/${sharedCollectionName}`;
        }
        // --- è³‡æ–™æ“ä½œ (CRUD) ---
        /** æ–°å¢ç´€éŒ„åˆ° Firestore (åƒ…é™äº¤è»Š) */
        async function addRecord(event) {
            event.preventDefault();
            if (!db || !userId) {
                displayMessage("è³‡æ–™åº«é€£ç·šæˆ–ç”¨æˆ¶èªè­‰å¤±æ•—ï¼Œç„¡æ³•å„²å­˜ç´€éŒ„ã€‚è«‹æª¢æŸ¥è¨­å®šæˆ–é‡æ–°è¼‰å…¥ã€‚", 'error');
                return;
            }
            document.getElementById('submit-button').disabled = true;
            // å®¢æˆ¶è³‡æ–™ (é¸å¡«)
            const customerName = customerNameInput.value || '';
            const customerPhone = customerPhoneInput.value || '';
            const customerDob = customerDobInput.value || '';
            // äº¤è»Šè³‡è¨Š (å¿…å¡«)
            const date = document.getElementById('record-date').value;
            const time = document.getElementById('record-time').value;
            const action = document.getElementById('record-action').value; // å›ºå®šç‚º 'äº¤è»Š'
            const location = locationSelect.value.trim(); // å¾ Input ç²å–å€¼ä¸¦æ¸…ç†
            const plate = plateSelect.value; 
            
            const etcId = CAR_ETC_MAPPING[plate]; 
            
            const mileage = document.getElementById('record-mileage').value;
            const notes = document.getElementById('record-notes').value || '';
            if (!plate || !etcId) {
                displayMessage("è«‹é¸æ“‡è»Šç‰Œ (ETC å¡è™Ÿæœƒè‡ªå‹•å¾é¸å–®ä¸­å¸¶å…¥)ã€‚", 'error');
                document.getElementById('submit-button').disabled = false;
                return;
            }
            
            // æª¢æŸ¥è»Šç‰Œæ˜¯å¦è¢«ç¦ç”¨ (äºŒæ¬¡é˜²å‘†ï¼Œç¢ºä¿é¸å–®æœªè¢«ç¹é)
            const selectedOption = plateSelect.options[plateSelect.selectedIndex];
            if (selectedOption && selectedOption.disabled) {
                 displayMessage("æ‰€é¸è»Šç‰Œç›®å‰æ­£åœ¨ç§Ÿè³ƒé€±æœŸä¸­ï¼Œè«‹å…ˆå®Œæˆæ”¶è»Šå¾Œå†é€²è¡Œäº¤è»Šã€‚", 'error');
                 document.getElementById('submit-button').disabled = false;
                 return;
            }
            if (!location) {
                displayMessage("è«‹è¼¸å…¥äº¤è»Šåœ°é»ã€‚", 'error');
                document.getElementById('submit-button').disabled = false;
                return;
            }
            const dateTimeString = `${date}T${time}:00`;
            const recordTime = new Date(dateTimeString);
            
            if (isNaN(recordTime)) {
                displayMessage("æ—¥æœŸæˆ–æ™‚é–“æ ¼å¼ç„¡æ•ˆã€‚", 'error');
                document.getElementById('submit-button').disabled = false;
                return;
            }
            const newRecord = {
                // å®¢æˆ¶è³‡æ–™
                customerName: customerName,
                customerPhone: customerPhone,
                customerDob: customerDob,
                // äº¤è»Šè³‡è¨Š
                action: action, // äº¤è»Š
                deliveryDate: date,
                deliveryTime: time,
                deliveryLocation: location,
                startMileage: parseInt(mileage, 10), // èµ·å§‹é‡Œç¨‹
                plate: plate,
                etcId: etcId,
                notes: notes,
                
                // æ”¶è»Šè³‡è¨Š (é è¨­ç‚ºç©ºï¼Œè¡¨ç¤ºé€±æœŸé–‹æ”¾)
                collectionDate: null,
                collectionTime: null,
                collectionLocation: null,
                endMileage: null,
                
                timestamp: Timestamp.fromDate(recordTime) // ä½¿ç”¨äº¤è»Šæ™‚é–“ä½œç‚ºä¸»è¦æ’åº
            };
            try {
                const collectionRef = collection(db, getCollectionPath());
                await addDoc(collectionRef, newRecord);
                displayMessage("äº¤è»Šç´€éŒ„å„²å­˜æˆåŠŸï¼é€±æœŸå·²é–‹å•Ÿã€‚", 'success');
                document.getElementById('record-form').reset();
            } catch (e) {
                console.error("æ–°å¢æ–‡ä»¶æ™‚ç™¼ç”ŸéŒ¯èª¤:", e);
                displayMessage(`å„²å­˜å¤±æ•—: ${e.message}`, 'error');
            } finally {
                document.getElementById('submit-button').disabled = false;
            }
        }
        /** æ›´æ–°ç´€éŒ„ (æ”¶è»Šæˆ–ç™»éŒ„é‡Œç¨‹) */
        async function submitCollectionUpdate(event) {
            event.preventDefault();
            if (!db || !userId) {
                displayMessage("è³‡æ–™åº«é€£ç·šæˆ–ç”¨æˆ¶èªè­‰å¤±æ•—ï¼Œç„¡æ³•å®Œæˆæ”¶è»Šã€‚", 'error');
                return;
            }
            const recordId = document.getElementById('modal-record-id').value;
            const mode = document.getElementById('modal-mode').value;
            
            const collectionDate = document.getElementById('collection-date').value;
            const collectionTime = document.getElementById('collection-time').value;
            const collectionLocation = collectionLocationSelect.value.trim(); // å¾ Input ç²å–å€¼ä¸¦æ¸…ç†
            const endMileageInput = document.getElementById('end-mileage').value;
            
            const updateData = {};
            const collectionSubmitBtn = document.getElementById('collection-submit-btn');
            // å–å¾—èµ·å§‹é‡Œç¨‹ (ç”¨æ–¼é‡Œç¨‹æª¢æŸ¥)
            const record = allRecords.find(r => r.id === recordId);
            const startMileage = record ? record.startMileage : 0;
            
            collectionSubmitBtn.disabled = true;
            if (mode === 'full') {
                // --- æ¨¡å¼ 1: è¨˜éŒ„æ™‚é–“/åœ°é» (é æ”¶è»Š) ---
                if (!collectionDate || !collectionTime || !collectionLocation) {
                    displayMessage("è«‹å¡«å¯«å®Œæ•´çš„æ”¶è»Šæ™‚é–“å’Œåœ°é»ã€‚", 'error');
                    collectionSubmitBtn.disabled = false;
                    return;
                }
                updateData.collectionDate = collectionDate;
                updateData.collectionTime = collectionTime;
                updateData.collectionLocation = collectionLocation;
                // endMileage ä»ç„¶ç‚º nullï¼Œä¿æŒã€Œå¾…ç™»éŒ„é‡Œç¨‹ã€ç‹€æ…‹
                
                // å¦‚æœç”¨æˆ¶åœ¨ 'full' æ¨¡å¼ä¸‹ä¹Ÿè¼¸å…¥äº†é‡Œç¨‹ï¼Œå‰‡ç›´æ¥å®Œæˆ
                if (endMileageInput) {
                    const endMileage = parseInt(endMileageInput, 10);
                    if (isNaN(endMileage) || endMileage < startMileage) {
                        displayMessage(`çµæŸé‡Œç¨‹æ•¸ç„¡æ•ˆæˆ–ä½æ–¼èµ·å§‹é‡Œç¨‹ (${startMileage.toLocaleString()} Km)ã€‚`, 'error');
                        collectionSubmitBtn.disabled = false;
                        return;
                    }
                    updateData.endMileage = endMileage;
                }
            } else if (mode === 'mileage') {
                // --- æ¨¡å¼ 2: ç™»éŒ„æœ€çµ‚é‡Œç¨‹ (çµç®—) ---
                const endMileage = parseInt(endMileageInput, 10);
                
                if (isNaN(endMileage)) {
                    displayMessage("è«‹è¼¸å…¥æœ‰æ•ˆçš„çµæŸé‡Œç¨‹æ•¸ã€‚", 'error');
                    collectionSubmitBtn.disabled = false;
                    return;
                }
                if (endMileage < startMileage) {
                     displayMessage(`æ”¶è»Šé‡Œç¨‹ (${endMileage.toLocaleString()} Km) ä¸å¾—ä½æ–¼äº¤è»Šé‡Œç¨‹ (${startMileage.toLocaleString()} Km)ã€‚`, 'error');
                     collectionSubmitBtn.disabled = false;
                     return;
                }
                
                updateData.endMileage = endMileage;
            }
            try {
                const docRef = doc(db, getCollectionPath(), recordId);
                await updateDoc(docRef, updateData);
                if (updateData.endMileage) {
                     displayMessage(`æ”¶è»Šç´€éŒ„å·²å®Œæˆï¼é‡Œç¨‹å·®: ${(updateData.endMileage - startMileage).toLocaleString()} Km`, 'success');
                } else {
                     displayMessage(`æ”¶è»Šæ™‚é–“/åœ°é»å·²è¨˜éŒ„ï¼Œå¾…ç™»éŒ„æœ€çµ‚é‡Œç¨‹ã€‚`, 'success');
                }
                
                window.closeCollectionModal();
            } catch (e) {
                console.error("æ›´æ–°æ”¶è»Šç´€éŒ„æ™‚ç™¼ç”ŸéŒ¯èª¤:", e);
                displayMessage(`å„²å­˜å¤±æ•—: ${e.message}`, 'error');
            } finally {
                collectionSubmitBtn.disabled = false;
            }
        }
        /** åˆªé™¤ç´€éŒ„ */
        async function deleteLogRecord(id) {
            // æª¢æŸ¥ Firebase æ˜¯å¦æˆåŠŸåˆå§‹åŒ– (dbå­˜åœ¨) ä¸”ç”¨æˆ¶å·²èªè­‰
            if (!db || !userId) {
                displayMessage("æ‡‰ç”¨ç¨‹å¼åˆå§‹åŒ–å¤±æ•—æˆ–èªè­‰æœªå®Œæˆï¼Œç„¡æ³•åŸ·è¡Œåˆªé™¤æ“ä½œã€‚", 'error');
                return;
            }
            
            const confirmation = confirm(`ç¢ºå®šè¦åˆªé™¤é€™ç­† ID ç‚º ${id.substring(0, 8)}... çš„å®Œæ•´é€±æœŸç´€éŒ„å—ï¼Ÿ`);
            if (!confirmation) return;
            try {
                const docRef = doc(db, getCollectionPath(), id);
                await deleteDoc(docRef);
                displayMessage("ç´€éŒ„å·²åˆªé™¤ã€‚", 'success');
            } catch (e) {
                console.error("åˆªé™¤æ–‡ä»¶æ™‚ç™¼ç”ŸéŒ¯èª¤:", e);
                displayMessage(`åˆªé™¤å¤±æ•—: ${e.message}`, 'error');
            }
        }
        
        // --- æ¨¡æ…‹è¦–çª—é‚è¼¯ ---
        function openCollectionModal(recordId, mode) {
            const record = allRecords.find(r => r.id === recordId);
            if (!record) {
                displayMessage("éŒ¯èª¤: æ‰¾ä¸åˆ°è©²ç­†ç´€éŒ„è³‡æ–™ï¼Œè«‹é‡æ•´é é¢ã€‚", 'error');
                return;
            }
            
            const modal = document.getElementById('collection-modal');
            const modalContent = document.getElementById('collection-modal-content');
            
            const modalTitle = document.getElementById('modal-title');
            const modalModeInput = document.getElementById('modal-mode');
            // è¨­ç½®é€šç”¨å€¼
            document.getElementById('modal-record-id').value = recordId;
            document.getElementById('modal-plate-display').textContent = record.plate;
            document.getElementById('modal-start-mileage').textContent = record.startMileage ? record.startMileage.toLocaleString() : '0';
            modalModeInput.value = mode;
            // è¨­ç½®æ”¶è»Šåœ°é» Input å€¼
            collectionLocationSelect.value = record.collectionLocation || '';
            // æ¸…é™¤ä¸Šæ¬¡çš„è¼¸å…¥å€¼
            document.getElementById('end-mileage').value = ''; 
            
            if (mode === 'mileage') {
                // --- æ¨¡å¼ 2: åƒ…ç™»éŒ„é‡Œç¨‹ ---
                modalTitle.textContent = 'ç™»éŒ„çµæŸé‡Œç¨‹æ•¸ (å®Œæˆçµç®—)';
                document.getElementById('collection-submit-btn').textContent = 'ç¢ºèªç™»éŒ„ä¸¦å®Œæˆçµç®—';
                
                document.getElementById('modal-date-container').classList.add('hidden');
                document.getElementById('modal-time-container').classList.add('hidden');
                document.getElementById('modal-location-container').classList.add('hidden');
                document.getElementById('modal-mileage-container').classList.remove('col-span-2');
                document.getElementById('modal-mileage-container').classList.add('col-span-2');
                document.getElementById('end-mileage').required = true;
                
            } else {
                // --- æ¨¡å¼ 1: è¨˜éŒ„æ™‚é–“/åœ°é» (full) ---
                modalTitle.textContent = 'è¨˜éŒ„æ”¶è»Šæ™‚é–“èˆ‡åœ°é»';
                document.getElementById('collection-submit-btn').textContent = 'ç¢ºèªä¸¦å„²å­˜æ”¶è»Šæ™‚é–“';
                document.getElementById('modal-date-container').classList.remove('hidden');
                document.getElementById('modal-time-container').classList.remove('hidden');
                document.getElementById('modal-location-container').classList.remove('hidden');
                document.getElementById('modal-mileage-container').classList.remove('col-span-2'); 
                
                document.getElementById('end-mileage').required = false; 
                
                // é è¨­æ—¥æœŸå’Œæ™‚é–“
                const today = new Date().toISOString().split('T')[0];
                const nowTime = new Date().toTimeString().split(' ')[0].substring(0, 5);
                document.getElementById('collection-date').value = record.collectionDate || today;
                document.getElementById('collection-time').value = record.collectionTime || nowTime;
                
            }
            // é¡¯ç¤ºæ¨¡æ…‹è¦–çª—
            modal.classList.remove('hidden');
            setTimeout(() => {
                modalContent.classList.remove('scale-95', 'opacity-0');
                modalContent.classList.add('scale-100', 'opacity-100');
            }, 10);
        }
        function closeCollectionModal() {
            const modal = document.getElementById('collection-modal');
            const modalContent = document.getElementById('collection-modal-content');
            
            // éš±è—æ¨¡æ…‹è¦–çª—
            modalContent.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                modal.classList.add('hidden');
                document.getElementById('collection-form').reset();
            }, 300);
        }
        window.openCollectionModal = openCollectionModal;
        window.closeCollectionModal = closeCollectionModal;
        document.getElementById('collection-form').addEventListener('submit', submitCollectionUpdate);
        
        // --- ç·¨è¼¯æ¨¡æ…‹è¦–çª—é‚è¼¯ (New) ---
        function openEditModal(recordId) {
            const record = allRecords.find(r => r.id === recordId);
            if (!record) {
                displayMessage("éŒ¯èª¤: æ‰¾ä¸åˆ°è©²ç­†ç´€éŒ„è³‡æ–™ï¼Œè«‹é‡æ•´é é¢ã€‚", 'error');
                return;
            }
            // 1. è¨­ç½® ID
            document.getElementById('edit-record-id').value = recordId;
            // 2. è¨­ç½®äº¤è»Šè³‡è¨Š
            editPlateInput.value = record.plate; // è»Šç‰Œä¸å¯ç·¨è¼¯
            editDeliveryDateInput.value = record.deliveryDate;
            editDeliveryTimeInput.value = record.deliveryTime;
            editStartMileageInput.value = record.startMileage;
            editNotesInput.value = record.notes || '';
            
            // è¨­ç½®äº¤è»Šåœ°é» Input å€¼
            editDeliveryLocationSelect.value = record.deliveryLocation || '';
            // 3. è¨­ç½®æ”¶è»Šè³‡è¨Š
            editCollectionDateInput.value = record.collectionDate || '';
            editCollectionTimeInput.value = record.collectionTime || '';
            editEndMileageInput.value = record.endMileage || '';
            
            // è¨­ç½®æ”¶è»Šåœ°é» Input å€¼
            editCollectionLocationSelect.value = record.collectionLocation || '';
            
            // 4. è¨­ç½®å®¢æˆ¶è³‡è¨Š
            editCustomerNameInput.value = record.customerName || '';
            editCustomerPhoneInput.value = record.customerPhone || '';
            editCustomerDobInput.value = record.customerDob || '';
            
            // é¡¯ç¤ºæ¨¡æ…‹è¦–çª—
            const modal = document.getElementById('edit-modal');
            const modalContent = document.getElementById('edit-modal-content');
            modal.classList.remove('hidden');
            setTimeout(() => {
                modalContent.classList.remove('scale-95', 'opacity-0');
                modalContent.classList.add('scale-100', 'opacity-100');
            }, 10);
        }
        async function submitEditUpdate(event) {
            event.preventDefault();
            if (!db || !userId) {
                displayMessage("è³‡æ–™åº«é€£ç·šæˆ–ç”¨æˆ¶èªè­‰å¤±æ•—ï¼Œç„¡æ³•å„²å­˜ä¿®æ”¹ã€‚", 'error');
                return;
            }
            
            const recordId = document.getElementById('edit-record-id').value;
            const originalRecord = allRecords.find(r => r.id === recordId);
            const editSubmitBtn = document.getElementById('edit-submit-btn');
            if (!originalRecord) {
                displayMessage("æ‰¾ä¸åˆ°åŸå§‹ç´€éŒ„ï¼Œç„¡æ³•ä¿®æ”¹ã€‚", 'error');
                return;
            }
            editSubmitBtn.disabled = true;
            
            const startMileage = parseInt(editStartMileageInput.value, 10);
            const endMileage = editEndMileageInput.value ? parseInt(editEndMileageInput.value, 10) : null;
            
            // --- é‡Œç¨‹æ•¸é˜²å‘†æª¢æŸ¥ ---
            if (endMileage !== null && endMileage < startMileage) {
                displayMessage(`éŒ¯èª¤: çµæŸé‡Œç¨‹ (${endMileage.toLocaleString()} Km) ä¸å¾—ä½æ–¼èµ·å§‹é‡Œç¨‹ (${startMileage.toLocaleString()} Km)ã€‚`, 'error');
                editSubmitBtn.disabled = false;
                return;
            }
            
            // æº–å‚™æ›´æ–°æ•¸æ“š
            const updateData = {
                // äº¤è»Šè³‡è¨Š (Delivery) - å¯ç·¨è¼¯
                deliveryDate: editDeliveryDateInput.value,
                deliveryTime: editDeliveryTimeInput.value,
                deliveryLocation: editDeliveryLocationSelect.value.trim(), // å¾ Input ç²å–å€¼ä¸¦æ¸…ç†
                startMileage: startMileage,
                notes: editNotesInput.value || '',
                // æ”¶è»Šè³‡è¨Š (Collection) - å¯ç·¨è¼¯
                collectionDate: editCollectionDateInput.value || null,
                collectionTime: editCollectionTimeInput.value || null,
                collectionLocation: editCollectionLocationSelect.value.trim() || null, // å¾ Input ç²å–å€¼ä¸¦æ¸…ç†
                endMileage: endMileage,
                // å®¢æˆ¶è³‡è¨Š - å¯ç·¨è¼¯
                customerName: editCustomerNameInput.value || null,
                customerPhone: editCustomerPhoneInput.value || null,
                customerDob: editCustomerDobInput.value || null,
                
                // ä¿æŒåŸæœ‰çš„ timestamp ç”¨æ–¼æ’åº
                timestamp: originalRecord.timestamp 
            };
            
            // æª¢æŸ¥æ˜¯å¦å½±éŸ¿é˜²å‘†æ©Ÿåˆ¶ (åªæœ‰åœ¨ä¿®æ”¹äº¤è»Šæˆ–æ”¶è»Šç‹€æ…‹æ™‚æ‰æª¢æŸ¥)
            const oldPlate = originalRecord.plate;
            const newStartMileage = updateData.startMileage;
            const newEndMileage = updateData.endMileage;
            // å¦‚æœäº¤è»Šé‡Œç¨‹è¢«æ¸…ç©ºæˆ–ä¸åˆæ³•
            if (isNaN(newStartMileage)) {
                displayMessage("èµ·å§‹é‡Œç¨‹å¿…é ˆæ˜¯æœ‰æ•ˆæ•¸å­—ã€‚", 'error');
                editSubmitBtn.disabled = false;
                return;
            }
            // å¦‚æœç´€éŒ„å¾å·²å®Œæˆè®Šç‚ºå¾…æ”¶è»Šï¼Œå‰‡éœ€è¦æª¢æŸ¥è»Šè¼›æ˜¯å¦æœƒèˆ‡å…¶ä»–ç´€éŒ„è¡çª
            const wasCompleted = originalRecord.endMileage !== null;
            const isNowCompleted = newEndMileage !== null;
            
            if (wasCompleted && !isNowCompleted) {
                // æª¢æŸ¥æ˜¯å¦æœ‰å…¶ä»–ç´€éŒ„ç¾åœ¨ä½”ç”¨äº†é€™è¼›è»Š
                const currentlyUnavailable = getUnavailablePlatesForTime(allRecords.filter(r => r.id !== recordId), createDateTime(updateData.deliveryDate, updateData.deliveryTime));
                if (currentlyUnavailable.includes(oldPlate)) {
                    displayMessage(`éŒ¯èª¤: æ­¤è»Šç‰Œ (${oldPlate}) åœ¨å…¶ä»–é€±æœŸä¸­å·²è¢«ç§Ÿå‡ºï¼Œç„¡æ³•å°‡æœ¬ç´€éŒ„è¨­ç‚ºã€Œå¾…æ”¶è»Šã€ã€‚`, 'error');
                    editSubmitBtn.disabled = false;
                    return;
                }
            }
            try {
                const docRef = doc(db, getCollectionPath(), recordId);
                await updateDoc(docRef, updateData);
                displayMessage("ç´€éŒ„ä¿®æ”¹æˆåŠŸï¼", 'success');
                window.closeEditModal();
            } catch (e) {
                console.error("æ›´æ–°æ–‡ä»¶æ™‚ç™¼ç”ŸéŒ¯èª¤:", e);
                displayMessage(`ä¿®æ”¹å¤±æ•—: ${e.message}`, 'error');
            } finally {
                editSubmitBtn.disabled = false;
            }
        }
        function closeEditModal() {
            const modal = document.getElementById('edit-modal');
            const modalContent = document.getElementById('edit-modal-content');
            
            modalContent.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300);
        }
        window.openEditModal = openEditModal;
        window.closeEditModal = closeEditModal;
        document.getElementById('edit-form').addEventListener('submit', submitEditUpdate);
        // --- END ç·¨è¼¯æ¨¡æ…‹è¦–çª—é‚è¼¯ ---
        
        // --- è»Šè¼›é˜²å‘†é‚è¼¯ ---
        
        /** ç²å–åœ¨ç‰¹å®šæ™‚é–“é»æ‰€æœ‰å°šæœªå®Œæˆçµç®— (endMileage === null) çš„è»Šç‰Œ */
        function getUnavailablePlatesForTime(records, proposedDeliveryTimestamp) {
            const proposedTime = proposedDeliveryTimestamp.getTime();
            const now = new Date().getTime(); // ç²å–ç•¶å‰æ™‚é–“
            return records
                .filter(record => {
                    // åªæª¢æŸ¥æœªçµç®—ï¼ˆopenï¼‰çš„é€±æœŸ
                    if (record.endMileage !== null) return false; 
                    
                    const deliveryTime = createDateTime(record.deliveryDate, record.deliveryTime).getTime();
                    
                    // Case A: é€±æœŸå·²æ’å®šæ”¶è»Šæ™‚é–“
                    if (record.collectionDate && record.collectionTime) {
                        const collectionTime = createDateTime(record.collectionDate, record.collectionTime).getTime();
                        
                        // è¡çªæ¢ä»¶: æ“¬è­°æ™‚é–“è½åœ¨ [äº¤è»Šæ™‚é–“, æ’å®šæ”¶è»Šæ™‚é–“] ä¹‹é–“
                        return deliveryTime < proposedTime && collectionTime > proposedTime;
                    } else {
                        // Case B: é€±æœŸå°šæœªæ’å®šæ”¶è»Šæ™‚é–“ (Open-ended rental)
                        
                        // B1: é€±æœŸå·²ç¶“é–‹å§‹ (äº¤è»Šæ™‚é–“åœ¨éå»)
                        if (deliveryTime < now) {
                            // **æ–°é‚è¼¯**ï¼šå¦‚æœæ“¬è­°æ™‚é–“åœ¨æœªä¾†ï¼Œæˆ‘å€‘å‡è¨­ç”¨æˆ¶æœƒè§£æ±ºè¡çªä¸¦æ”¾è¡Œï¼Œä»¥å…è¨±é è¨‚ã€‚
                            // å¦å‰‡ (æ“¬è­°æ™‚é–“åœ¨ç¾åœ¨æˆ–éå»)ï¼Œå‰‡è¡çªï¼Œå› ç‚ºè»Šè¼›æ­£åœ¨ä½¿ç”¨ä¸­ã€‚
                            if (proposedTime > now) {
                                return false; // å…è¨±é è¨‚ï¼Œå°‡é¢¨éšªè½‰äº¤çµ¦ç”¨æˆ¶ã€‚
                            }
                            return true; // è¡çªï¼Œå› ç‚ºè»Šè¼›ç›®å‰æ­£åœ¨ä½¿ç”¨ä¸­ã€‚
                        }
                        
                        // B2: é€±æœŸæ˜¯æœªä¾†çš„é è¨‚ (äº¤è»Šæ™‚é–“åœ¨æœªä¾†)
                        // å› ç‚ºæ²’æœ‰æ”¶è»Šæ™‚é–“ï¼Œé€™å€‹é è¨‚æœƒç„¡é™æœŸåœ°ä½”ç”¨è»Šè¼›ã€‚
                        if (deliveryTime <= proposedTime) { 
                            return true; // è¡çªï¼Œé€™å€‹æœªä¾†é è¨‚æœƒé˜»æ“‹æ‰€æœ‰å¾ŒçºŒçš„é è¨‚ã€‚
                        }
                        
                        return false; 
                    }
                })
                .map(record => record.plate);
        }
        /** è¨­ç½®è»Šç‰Œå’Œ ETC å¡è™Ÿçš„å°æ‡‰é‚è¼¯ */
        function setupPlateEtcMapping(unavailablePlates = []) {
            plateSelect.innerHTML = '<option value="" disabled selected>è«‹é¸æ“‡è»Šç‰Œ (ETC å¡è™Ÿ)</option>'; 
            
            Object.keys(CAR_ETC_MAPPING).forEach(plateDescription => {
                const etcId = CAR_ETC_MAPPING[plateDescription];
                const option = document.createElement('option');
                option.value = plateDescription; 
                
                if (unavailablePlates.includes(plateDescription)) {
                    // è»Šè¼›å·²ç§Ÿå‡º/æ’ç¨‹è¡çªï¼Œç¦ç”¨é¸é …
                    option.textContent = `${plateDescription} (å·²ç§Ÿå‡º/è¡çª)`; 
                    option.disabled = true;
                } else {
                    // è»Šè¼›å¯é¸
                    option.textContent = `${plateDescription} (${etcId})`; 
                }
                
                plateSelect.appendChild(option);
            });
        }
        // --- END è»Šè¼›é˜²å‘†é‚è¼¯ ---
        /** ç²å–ç°¡åŒ–çš„è»Šç‰Œè™Ÿç¢¼ */
        function getShortPlateDisplay(fullPlate) {
            // è¦å‰‡ 1: æˆç”°331ã‚7777 ç¸½çµ±åº§ -> 7777 ç¸½çµ±åº§
            if (fullPlate.includes('æˆç”°331ã‚7777')) {
                return '7777 ç¸½çµ±åº§';
            }
            // è¦å‰‡ 2: ãªã«ã‚334ã‚8888 40ç³» -> 8888 40ç³»
            if (fullPlate.includes('ãªã«ã‚334ã‚8888')) {
                return '8888 40ç³»';
            }
            // è¦å‰‡ 3: æˆç”°331ã‚88 4WD 8åº§ -> 88 4WD 8åº§
            if (fullPlate.includes('æˆç”°331ã‚88')) {
                return '88 4WD 8åº§';
            }
            // è¦å‰‡ 4: å’Œæ³‰330ã‚3333 7åº§ ä¸­æ–‡å°èˆª -> 3333 7åº§
            if (fullPlate.includes('å’Œæ³‰330ã‚3333')) {
                return '3333 7åº§';
            }
            // Fallback: å¦‚æœä¸ç¬¦åˆä¸Šè¿°è¦å‰‡ï¼Œå‰‡è¿”å›å®Œæ•´è»Šç‰Œ
            return fullPlate;
        }
        /** è¨­ç½®åœ°é» Datalist é¸é … (New) */
        function setupDatalistOptions() {
            const datalist = document.getElementById('location-list');
            if (!datalist) return;
            datalist.innerHTML = '';
            
            LOCATION_OPTIONS.forEach(location => {
                const option = document.createElement('option');
                option.value = location;
                datalist.appendChild(option);
            });
        }
        /** é¡¯ç¤º/éš±è—è©³ç´°è³‡è¨Š */
        function toggleDetails(id) {
            const detailRow = document.getElementById(`detail-row-${id}`);
            const expandIcon = document.getElementById(`expand-icon-${id}`);
            if (detailRow) {
                const isHidden = detailRow.classList.toggle('hidden');
                if (expandIcon) {
                    expandIcon.textContent = isHidden ? 'â–¼' : 'â–²';
                }
            }
        }
        window.toggleDetails = toggleDetails;
        
        /** æ»¾å‹•åˆ°æŒ‡å®šç´€éŒ„ä¸¦å±•é–‹è©³ç´°è³‡è¨Š (New) */
        function scrollToRecord(recordId) {
            const recordRow = document.getElementById(`detail-row-${recordId}`);
            if (recordRow) {
                // 1. å±•é–‹è©³ç´°è³‡è¨Š
                const isHidden = recordRow.classList.contains('hidden');
                if (isHidden) {
                    window.toggleDetails(recordId);
                }
                
                // 2. æ»¾å‹•åˆ°å¡ç‰‡ (summaryDiv)
                const summaryDiv = document.getElementById(`summary-row-${recordId}`);
                    if (summaryDiv) {
                    summaryDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    // 3. çŸ­æš«é«˜äº®
                    summaryDiv.classList.add('ring-4', 'ring-indigo-300');
                    setTimeout(() => {
                        summaryDiv.classList.remove('ring-4', 'ring-indigo-300');
                    }, 1500);
                }
            } else {
                displayMessage("æ‰¾ä¸åˆ°è©²ç­†ç´€éŒ„ï¼Œè«‹å˜—è©¦èª¿æ•´æœå°‹æ¢ä»¶æˆ–é‡æ–°è¼‰å…¥é é¢ã€‚", 'info');
            }
        }
        window.scrollToRecord = scrollToRecord;
        /** è™•ç†æ—¥æœŸå€é–“ç¯©é¸ */
        function handleDateFilter() {
            renderRecords(allRecords);
        }
        window.handleDateFilter = handleDateFilter;
        /** æ¸…é™¤æ—¥æœŸç¯©é¸ */
        function clearDateFilter() {
            filterStartDateInput.value = '';
            filterEndDateInput.value = '';
            renderRecords(allRecords);
        }
        window.clearDateFilter = clearDateFilter;
        /** æ›´æ–°è¡Œç¨‹æç¤º (New) */
        function updateScheduleTip() {
            const today = new Date();
            const tomorrow = new Date();
            tomorrow.setDate(today.getDate() + 1);
            const dayAfterTomorrow = new Date();
            dayAfterTomorrow.setDate(today.getDate() + 2); 
            const todayStr = getFormattedDate(today);
            const tomorrowStr = getFormattedDate(tomorrow);
            const dayAfterTomorrowStr = getFormattedDate(dayAfterTomorrow);
            
            const getDisplayDate = (dateStr) => dateStr.substring(5).replace('-', '/');
            // 1. ä»Šæ—¥æ”¶è»Š
            const todayCollections = allRecords.filter(record => 
                record.collectionDate === todayStr && record.endMileage === null
            );
            // 2. æ˜æ—¥æ”¶è»Š
            const tomorrowCollections = allRecords.filter(record => 
                record.collectionDate === tomorrowStr && record.endMileage === null
            );
            // 3. æ˜æ—¥äº¤è»Š
            const tomorrowDeliveries = allRecords.filter(record => 
                record.deliveryDate === tomorrowStr
            );
            
            // 4. å¾Œå¤©æ”¶è»Š
            const dayAfterTomorrowCollections = allRecords.filter(record => 
                record.collectionDate === dayAfterTomorrowStr && record.endMileage === null
            );
            // 5. å¾Œå¤©äº¤è»Š
            const dayAfterTomorrowDeliveries = allRecords.filter(record => 
                record.deliveryDate === dayAfterTomorrowStr
            );
            let tipParts = [];
            // Helper function to format details
            const formatDetails = (records, type) => {
                if (records.length === 0) return [];
                
                const timeField = (type === 'Delivery' ? 'deliveryTime' : 'collectionTime');
                const locationField = (type === 'Delivery' ? 'deliveryLocation' : 'collectionLocation');
                return records.map(r => {
                    const plate = getShortPlateDisplay(r.plate); 
                    const time = r[timeField];
                    const location = r[locationField];
                    
                    const dateToCheck = (type === 'Delivery' ? r.deliveryDate : r.collectionDate);
                    let dayText;
                    
                    if (dateToCheck === todayStr) {
                        dayText = 'ä»Šå¤©';
                    } else if (dateToCheck === tomorrowStr) {
                        dayText = `æ˜å¤© (${getDisplayDate(tomorrowStr)})`;
                    } else if (dateToCheck === dayAfterTomorrowStr) {
                        dayText = `å¾Œå¤© (${getDisplayDate(dayAfterTomorrowStr)})`;
                    } else {
                         dayText = getDisplayDate(dateToCheck); 
                    }
                    
                    const typeText = (type === 'Delivery' ? 'äº¤è»Š' : 'æ”¶è»Š');
                    const tipContent = `${dayText}æœ‰ <strong>1</strong> ç­†${typeText}æ’ç¨‹: ${plate}ï¼Œæ™‚é–“ï¼š${time}ï¼Œåœ°é»ï¼š${location}ã€‚`;
                    
                    return {
                        id: r.id, 
                        html: tipContent
                    };
                });
            };
            // Gather all tips as objects (Order: Today -> Tomorrow -> D+2)
            const allTips = [
                ...formatDetails(todayCollections, 'Collection'),
                ...formatDetails(tomorrowCollections, 'Collection'),
                ...formatDetails(tomorrowDeliveries, 'Delivery'),
                ...formatDetails(dayAfterTomorrowCollections, 'Collection'),
                ...formatDetails(dayAfterTomorrowDeliveries, 'Delivery')
            ];
            
            const tipElement = document.getElementById('schedule-tip'); 
            
            if (allTips.length === 0) {
                tipElement.innerHTML = `<span class="text-xs text-gray-600">ç„¡ç•¶å‰é‡è¦æ’ç¨‹æç¤ºã€‚</span>`;
            } else {
                const listHTML = allTips.map(tip => 
                    `<div onclick="window.scrollToRecord('${tip.id}')" 
                          class="text-xs font-semibold text-red-900 cursor-pointer hover:bg-red-100 p-1 rounded transition duration-150">
                        ${tip.html}
                    </div>`
                ).join('');
                tipElement.innerHTML = listHTML;
            }
            
            // æ¯æ¬¡æ›´æ–°å®Œæç¤ºå¾Œï¼Œé‡æ–°æ¸²æŸ“æ—¥æ›† (New)
            renderCalendar();
        }
        /** æ¸²æŸ“ç´€éŒ„åˆ—è¡¨ (Card View) */
        function renderRecords(records) {
            recordsListContainer.innerHTML = '';
            
            if (records.length === 0) {
                noRecordsMessage.classList.remove('hidden');
                updateScheduleTip(); 
                return;
            }
            noRecordsMessage.classList.add('hidden');
            
            // --- 2. æ‡‰ç”¨æ’åº ---
            const sortedRecords = [...records].sort((a, b) => {
                const timeA = a.timestamp.toDate().getTime();
                const timeB = b.timestamp.toDate().getTime();
                
                if (sortDirection === 'desc') {
                    return timeB - timeA; 
                } else {
                    return timeA - timeB; 
                }
            });
            // --- 3. æ¸²æŸ“éæ¿¾å¾Œçš„ç´€éŒ„ ---
            // åŸ·è¡ŒæŸ¥è©¢éæ¿¾
            const searchTerm = document.getElementById('search-input').value.toLowerCase().trim();
            
            const filteredRecords = sortedRecords.filter(record => {
                if (!searchTerm) return true; 
                
                return (
                    record.deliveryLocation.toLowerCase().includes(searchTerm) ||
                    (record.collectionLocation && record.collectionLocation.toLowerCase().includes(searchTerm)) ||
                    record.plate.toLowerCase().includes(searchTerm) ||
                    record.notes.toLowerCase().includes(searchTerm) ||
                    (record.customerName && record.customerName.toLowerCase().includes(searchTerm)) ||
                    (record.customerPhone && record.customerPhone.toLowerCase().includes(searchTerm)) ||
                    record.etcId.toLowerCase().includes(searchTerm)
                );
            });
            filteredRecords.forEach(record => {
                const recordId = record.id; 
                const isCollectionScheduled = record.collectionDate !== null && record.collectionTime !== null;
                const isTimeLogged = record.collectionDate !== null;
                const isCompleted = record.endMileage !== null;
                
                let statusHTML, actionButton, actionMode;
                if (isCompleted) {
                    statusHTML = `<span class="px-2 py-0.5 rounded-full text-xs bg-green-100 text-green-700 font-semibold">å·²å®Œæˆ</span>`;
                    actionButton = `<span class="px-3 py-1 text-xs font-semibold text-green-700">å®Œæˆçµç®—</span>`;
                } else if (isTimeLogged) {
                    // å¾…æ”¶è»Š (å¾…ç™»éŒ„é‡Œç¨‹) - New vertical display
                    statusHTML = `
                        <div class="px-2 py-1 bg-orange-100 text-orange-700 font-bold rounded-lg text-center leading-tight">
                            <span class="text-sm">å¾…æ”¶è»Š</span><br>
                            <span class="text-xs font-normal">ï¼ˆå¾…ç™»éŒ„é‡Œç¨‹ï¼‰</span>
                        </div>
                    `;
                    actionMode = 'mileage';
                    actionButton = `<button onclick="window.openCollectionModal('${recordId}', '${actionMode}')" class="px-3 py-1 text-xs font-semibold text-white bg-orange-600 rounded-lg hover:bg-orange-700 transition duration-150">ç™»éŒ„é‡Œç¨‹</button>`;
                } else {
                    statusHTML = `<span class="px-2 py-0.5 rounded-full text-xs bg-yellow-100 text-yellow-700 font-semibold">å¾…æ”¶è»Š</span>`;
                    actionMode = 'full';
                    actionButton = `<button onclick="window.openCollectionModal('${recordId}', '${actionMode}')" class="px-3 py-1 text-xs font-semibold text-white bg-blue-600 rounded-lg hover:bg-blue-700 transition duration-150">æ”¶è»Š</button>`;
                }
                
                // æå–ç°¡çŸ­çš„è»Šç‰Œé¡¯ç¤º (æ–°éœ€æ±‚)
                const shortPlateDisplay = getShortPlateDisplay(record.plate);
                // --- 1. å¡ç‰‡æ‘˜è¦ DIV (Summary Row) ---
                const card = document.createElement('div');
                card.id = `summary-row-${recordId}`;
                card.className = "bg-white border border-gray-200 rounded-lg shadow-md overflow-hidden transition duration-150 hover:shadow-lg cursor-pointer ring-offset-2";
                card.onclick = (e) => {
                    // é¿å…é»æ“Šæ“ä½œæŒ‰éˆ•æ™‚è§¸ç™¼å±•é–‹
                    if (!e.target.closest('.action-controls')) {
                         window.toggleDetails(recordId);
                    }
                };
                const headerDiv = document.createElement('div');
                // ä½¿ç”¨ Flexbox ä½ˆå±€ï¼Œè®“ç‹€æ…‹å€å¡Šã€è³‡è¨Šå€å¡Šå’Œæ“ä½œæŒ‰éˆ•åœ¨æ‰‹æ©Ÿä¸Šæ°´å¹³æ’åˆ—
                headerDiv.className = "p-2 flex items-start justify-between border-b border-gray-100 flex-nowrap"; 
                
                // 1.1 Status Block (Left Side)
                const statusBlock = document.createElement('div');
                statusBlock.className = "flex-shrink-0 text-center leading-none self-center";
                statusBlock.innerHTML = statusHTML;
                // 1.2 Main Info (Center)
                const infoDiv = document.createElement('div');
                // æ¸›å°‘ padding å’Œ marginï¼Œè®“ä¸­é–“è³‡è¨Šæ›´ç·Šæ¹Š
                infoDiv.className = "flex-grow min-w-0 px-2 space-y-0.5"; 
                
                infoDiv.innerHTML = `
                    <p class="text-base font-bold text-indigo-700 leading-tight plate-fix min-w-0">
                        ${shortPlateDisplay}
                    </p>
                    
                    <p class="text-xs text-gray-900 leading-snug min-w-0">
                        äº¤è»Š: <span class="font-semibold">${record.deliveryDate.substring(5).replace('-', '/')} ${record.deliveryTime}</span>
                        @ ${record.deliveryLocation}
                    </p>
                    
                    ${isCollectionScheduled ? 
                        `<p class="text-xs font-semibold text-orange-600 leading-snug min-w-0">
                            æ”¶è»Š ğŸ“¥: ${record.collectionDate.substring(5).replace('-', '/')} ${record.collectionTime}
                            @ ${record.collectionLocation}
                        </p>`
                        : ''}
                `;
                // 1.3 Action Controls (Right Side)
                const actionControls = document.createElement('div');
                // ä½¿ç”¨ Flexbox column å‚ç›´å †ç–ŠæŒ‰éˆ•
                actionControls.className = "flex-shrink-0 flex flex-col items-end space-y-1 action-controls self-center ml-2";
                actionControls.innerHTML = `
                    <span id="expand-icon-${recordId}" class="text-lg text-indigo-500 cursor-pointer mb-1">â–¼</span>
                    <button onclick="window.openEditModal('${recordId}')" class="px-2 py-1 text-xs font-semibold text-gray-700 bg-yellow-300 rounded-lg hover:bg-yellow-400 transition duration-150 w-full whitespace-nowrap">ç·¨è¼¯</button>
                    ${actionButton}
                    <button onclick="window.deleteLogRecord('${recordId}')" class="text-red-600 hover:text-red-900 transition duration-150 text-xs px-2 py-1 w-full whitespace-nowrap">åˆªé™¤</button>
                `;
                headerDiv.appendChild(statusBlock);
                headerDiv.appendChild(infoDiv);
                headerDiv.appendChild(actionControls);
                card.appendChild(headerDiv);
                // --- 2. è©³ç´°å…§å®¹ DIV (Detail Row) - é è¨­éš±è— ---
                const detailDiv = document.createElement('div');
                detailDiv.id = `detail-row-${recordId}`;
                detailDiv.className = "hidden p-3 bg-gray-50 border-t border-gray-200"; 
                
                // è™•ç†å®¢æˆ¶è³‡è¨Šé¡¯ç¤º
                const customerInfo = (record.customerName || record.customerPhone || record.customerDob) ? `
                    <div class="space-y-1 sm:col-span-2 border-b pb-2 mb-3">
                        <p class="font-bold text-base text-gray-800">å®¢æˆ¶è³‡è¨Š</p>
                        <p><span class="font-medium text-gray-500">å§“å:</span> ${record.customerName || 'â€”'}</p>
                        <p><span class="font-medium text-gray-500">é›»è©±:</span> ${record.customerPhone || 'â€”'}</p>
                        <p><span class="font-medium text-gray-500">ç”Ÿæ—¥:</span> ${record.customerDob || 'â€”'}</p>
                    </div>
                ` : `<div class="sm:col-span-2 border-b pb-2 mb-3"><p class="font-bold text-base text-gray-800">å®¢æˆ¶è³‡è¨Š: ç„¡è¨˜éŒ„</p></div>`;
                // çµ„åˆè©³ç´°è³‡è¨Šå…§å®¹
                detailDiv.innerHTML = `
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 text-sm text-gray-700">
                        
                        <div class="space-y-1 sm:col-span-2 border-b pb-2 mb-2">
                            <p class="font-bold text-lg text-gray-800">è»Šè¼›: ${record.plate} (${record.etcId || 'â€”'})</p>
                        </div>
                        <div class="space-y-1 p-3 border rounded-lg bg-white shadow-sm">
                            <p class="font-bold text-green-700">äº¤è»Š (Delivery)</p>
                            <p><span class="font-medium text-gray-500">æ™‚é–“/åœ°é»:</span> ${record.deliveryDate} ${record.deliveryTime} / ${record.deliveryLocation}</p>
                            <p><span class="font-medium text-gray-500">èµ·å§‹é‡Œç¨‹:</span> <span class="font-bold text-indigo-600">${record.startMileage ? record.startMileage.toLocaleString() : 'â€”'} Km</span></p>
                        </div>
                        <div class="space-y-1 p-3 border rounded-lg ${isCompleted ? 'bg-teal-50 shadow-sm' : isTimeLogged ? 'bg-orange-50 shadow-sm' : 'bg-red-50 shadow-sm'}">
                            <p class="font-bold ${isCompleted ? 'text-teal-700' : isTimeLogged ? 'text-orange-600' : 'text-red-600'}">æ”¶è»Š (Collection)</p>
                            ${isTimeLogged ? 
                                `<p><span class="font-medium text-gray-500">é è¨ˆ/å¯¦éš›æ™‚é–“:</span> ${record.collectionDate} ${record.collectionTime} / ${record.collectionLocation}</p>` :
                                `<p class="text-red-600 font-semibold">å°šæœªè¨˜éŒ„æ”¶è»Šæ™‚é–“èˆ‡åœ°é»ã€‚</p>`
                            }
                            ${isCompleted ? 
                                 `<p><span class="font-medium text-gray-500">çµæŸé‡Œç¨‹:</span> <span class="font-bold text-indigo-600">${record.endMileage ? record.endMileage.toLocaleString() : 'â€”'} Km</span></p>
                                 <p><span class="font-medium text-gray-500">ç¸½é‡Œç¨‹å·®:</span> <span class="font-bold text-pink-600">${(record.endMileage && record.startMileage) ? (record.endMileage - record.startMileage).toLocaleString() : 'â€”'} Km</span></p>` : 
                                 (isTimeLogged ? 
                                    `<p class="text-orange-600 font-semibold">é‡Œç¨‹å¾…ç™»éŒ„ï¼Œé€±æœŸå°šæœªçµç®—ã€‚</p>` : ''
                                 )
                            }
                        </div>
                        ${customerInfo}
                        <div class="space-y-1 sm:col-span-2 border-t pt-2 mt-2">
                            <p class="font-medium text-gray-500">äº¤è»Šå‚™è¨»</p>
                            <p class="text-gray-900 whitespace-pre-wrap p-2 bg-gray-100 rounded">${record.notes || 'ç„¡å‚™è¨»'}</p>
                        </div>
                    </div>
                `;
                
                card.appendChild(detailDiv);
                
                recordsListContainer.appendChild(card);
            });
            if (filteredRecords.length === 0) {
                noRecordsMessage.classList.remove('hidden');
            } else {
                 noRecordsMessage.classList.add('hidden');
            }
            updateScheduleTip();
        }
        /** å¾ Firestore ç›£è½ç´€éŒ„çš„å¯¦æ™‚æ›´æ–° */
        function fetchRecords() {
            if (!db || !userId) return;
            const collectionRef = collection(db, getCollectionPath());
            
            // ä½¿ç”¨ onSnapshot å¯¦æ™‚ç›£è½
            onSnapshot(collectionRef, (snapshot) => {
                const records = [];
                snapshot.forEach((doc) => {
                    records.push({ id: doc.id, ...doc.data() });
                });
                
                allRecords = records; // æ›´æ–°å…¨å±€ç´€éŒ„åˆ—è¡¨
                
                // DEBUG: é€™è£¡ä¸éœ€è¦é¡å¤–çš„ console.logï¼ŒrenderRecords å·²ç¶“æœ‰ console.log äº†
                renderRecords(allRecords); // æ¸²æŸ“åˆ—è¡¨
                
                // === é˜²å‘†æ©Ÿåˆ¶ï¼šéæ¿¾å·²ç§Ÿå‡ºçš„è»Šè¼› (ä½¿ç”¨ç•¶å‰è¡¨å–®æ™‚é–“) ===
                const date = document.getElementById('record-date').value;
                const time = document.getElementById('record-time').value;
                
                let unavailablePlates = [];
                if (date && time) {
                     unavailablePlates = getUnavailablePlatesForTime(allRecords, createDateTime(date, time));
                }
                setupPlateEtcMapping(unavailablePlates);
                // ======================================
                
                updateScheduleTip(); // <-- Call the new function here, which also calls renderCalendar
                
                // !!! æ–°å¢é™¤éŒ¯ç´€éŒ„: é¡¯ç¤ºè®€å–åˆ°çš„ç´€éŒ„æ•¸é‡ !!!
                console.log("è³‡æ–™å·²æ›´æ–° (Firestore è®€å–æ•¸é‡):", records.length, "ç­†ç´€éŒ„");
            }, (error) => {
                console.error("ç›£è½ç´€éŒ„æ™‚ç™¼ç”ŸéŒ¯èª¤:", error);
                displayMessage("è¼‰å…¥ç´€éŒ„å¤±æ•—ï¼Œè«‹æª¢æŸ¥æ¬Šé™ã€‚", 'error');
            });
        }
        
        // --- æ—¥æ›†/æ’ç¨‹é‚è¼¯ (é‚„åŸ Grid) ---
        // è¼”åŠ©å‡½å¼ï¼šå–å¾— date string çš„æ—¥æœŸéƒ¨åˆ†
        function getDate(dateStr) {
            return new Date(dateStr + "T00:00:00");
        }
        // è¼”åŠ©å‡½å¼ï¼šè¨ˆç®—å…©å€‹æ—¥æœŸä¹‹é–“çš„å¤©æ•¸
        function getDaysBetween(date1, date2) {
            const date1Ms = getDate(date1).getTime();
            const date2Ms = getDate(date2).getTime();
            const diffTime = Math.abs(date2Ms - date1Ms);
            return Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1; // åŒ…å«é ­å°¾å…©å¤©
        }
        
        // è¼”åŠ©å‡½å¼ï¼šè¨ˆç®—è»Šç‰Œçš„é¡è‰²ç´¢å¼•
        function getPlateColor(plate) {
            let hash = 0;
            for (let i = 0; i < plate.length; i++) {
                hash = plate.charCodeAt(i) + ((hash << 5) - hash);
            }
            const index = Math.abs(hash) % PLATE_COLORS.length;
            return PLATE_COLORS[index];
        }
        
        // æ¸²æŸ“æ—¥æ›†æ’ç¨‹é•·æ¢ (ä¿®æ­£äº†è»Œé“å®šä½å’Œè¡Œé«˜è¨ˆç®—/æ‡‰ç”¨é‚è¼¯)
        function renderEventsOverlay(records) {
            if (!Array.isArray(records)) return; 
            const overlay = document.getElementById('calendar-events-overlay');
            const grid = document.getElementById('calendar-grid');
            overlay.innerHTML = '';
            
            if (grid.children.length === 0) return;
            const year = currentCalendarDate.getFullYear();
            const month = currentCalendarDate.getMonth();
            const currentMonthStart = new Date(year, month, 1);
            const currentMonthEnd = new Date(year, month + 1, 0);
            const firstDayOfMonth = currentMonthStart.getDay(); // è©²æœˆç¬¬ä¸€å¤©æ˜¯æ˜ŸæœŸå¹¾ (0=æ—¥)
            const daysInMonth = currentMonthEnd.getDate();
            
            // éæ¿¾å‡ºæœ¬æœˆæœ‰æ’ç¨‹çš„é€±æœŸ (å¿…é ˆæœ‰æ’å®šæ”¶è»Šæ™‚é–“)
            const visibleCycles = records.filter(r => 
                r.collectionDate && r.collectionTime && r.deliveryDate && r.deliveryTime &&
                (getDate(r.deliveryDate).getTime() <= currentMonthEnd.getTime()) &&
                (getDate(r.collectionDate).getTime() >= currentMonthStart.getTime())
            );
            
            // 1. å»ºç«‹è»Œé“è¿½è¹¤å™¨ä¸¦è¨ˆç®— Track Map
            let dateTrackMap = {}; // Key: YYYY-MM-DD, Value: [true, true, false, ...]
            const eventHeight = 22; // é•·æ¢é«˜åº¦ + å‚ç›´é–“è· (margin: 2px 0)
            const dayNumberOffset = 24; // æ—¥æœŸæ•¸å­—çš„å‚ç›´ç©ºé–“ (padding-top: 24px)
            const gridGap = 4; // Tailwind gap-1 = 4px
            
            // è¨ˆç®—é•·æ¢ä½”ç”¨å“ªäº›è»Œé“
            visibleCycles.forEach(record => {
                const deliveryDate = getDate(record.deliveryDate);
                const collectionDate = getDate(record.collectionDate);
                
                // æ¸…ç©ºä¹‹å‰çš„ segments è³‡è¨Š
                record.segments = [];
                
                // è™•ç†è·¨é€±/è·¨æœˆåˆ†æ®µ
                let currentDate = new Date(Math.max(deliveryDate.getTime(), currentMonthStart.getTime()));
                
                while (currentDate.getTime() <= collectionDate.getTime() && currentDate.getTime() <= currentMonthEnd.getTime()) {
                    
                    let segmentStart = new Date(currentDate);
                    
                    // æ‰¾åˆ°æœ¬æ®µé•·æ¢çš„çµæŸé» (é€±æœ« or é€±æœŸçµæŸ or æœˆä»½çµæŸ)
                    const endOfWeek = new Date(segmentStart);
                    endOfWeek.setDate(segmentStart.getDate() + (6 - segmentStart.getDay())); // è©²é€±æ˜ŸæœŸå…­çš„æ—¥æœŸ
                    
                    let segmentEnd = new Date(Math.min(collectionDate.getTime(), endOfWeek.getTime(), currentMonthEnd.getTime()));
                    
                    if (segmentStart.getTime() > segmentEnd.getTime()) {
                         currentDate.setDate(currentDate.getDate() + 1);
                         continue;
                    }
                    
                    // å°‹æ‰¾ç©ºé–’è»Œé“ (æª¢æŸ¥è©²é•·æ¢æ‰€ä½”ç”¨çš„æ¯ä¸€å¤©)
                    let track = 0;
                    let isFree = false;
                    
                    let checkDate = new Date(segmentStart);
                    let daysToCheck = [];
                    while (checkDate.getTime() <= segmentEnd.getTime()) {
                        daysToCheck.push(getFormattedDate(checkDate));
                        checkDate.setDate(checkDate.getDate() + 1);
                    }
                    
                    while (!isFree) {
                        isFree = true;
                        for (const dateStr of daysToCheck) {
                            if (dateTrackMap[dateStr] && dateTrackMap[dateStr][track]) {
                                isFree = false;
                                break;
                            }
                        }
                        if (!isFree) {
                            track++;
                        }
                    }
                    // æ¨™è¨˜è»Œé“ä½”ç”¨
                    for (const dateStr of daysToCheck) {
                        if (!dateTrackMap[dateStr]) {
                            dateTrackMap[dateStr] = [];
                        }
                        dateTrackMap[dateStr][track] = true;
                    }
                    
                    // å°‡è»Œé“è³‡è¨Šå„²å­˜åˆ° record ç‰©ä»¶ï¼Œä»¥ä¾›å¾ŒçºŒæ¸²æŸ“
                    record.segments.push({
                        track: track,
                        start: getFormattedDate(segmentStart),
                        end: getFormattedDate(segmentEnd)
                    });

                    // ç§»å‹•åˆ°ä¸‹ä¸€æ®µçš„èµ·å§‹é»
                    currentDate = new Date(segmentEnd);
                    currentDate.setDate(currentDate.getDate() + 1);
                }
            });
            
            // 2. è¨ˆç®— Grid è¡Œé«˜ä¸¦æº–å‚™ç´¯ç© Top Offset
            const totalDaysInGrid = firstDayOfMonth + daysInMonth;
            const rows = Math.ceil(totalDaysInGrid / 7);
            let rowHeights = {};
            let accumulatedTop = 0; // ç´¯ç© Top Offset
            
            for (let r = 0; r < rows; r++) {
                let maxTracksInRow = 0;
                
                // æª¢æŸ¥æœ¬è¡Œçš„æ‰€æœ‰å¤©æ•¸
                for (let d = 0; d < 7; d++) {
                    const dayIndexInMonth = (r * 7 + d) - firstDayOfMonth; 
                    
                    if (dayIndexInMonth >= 0 && dayIndexInMonth < daysInMonth) {
                        const dateStr = getFormattedDate(new Date(year, month, dayIndexInMonth + 1));
                        if (dateTrackMap[dateStr]) {
                            // è¨ˆç®—å¯¦éš›ä½”ç”¨çš„è»Œé“æ•¸é‡
                            maxTracksInRow = Math.max(maxTracksInRow, dateTrackMap[dateStr].filter(t => t).length);
                        }
                    }
                }
                
                // è¨ˆç®—è©²è¡Œæ‰€éœ€é«˜åº¦ (24px æ•¸å­—ç©ºé–“ + (è»Œé“æ•¸ * 22px äº‹ä»¶é«˜åº¦) + 10px åº•éƒ¨é–“è·)
                const requiredEventHeight = dayNumberOffset + (maxTracksInRow * eventHeight) + 10;
                // ç¢ºä¿æœ€å°é«˜åº¦ç‚º 80px (CSS ä¸­ .calendar-day çš„ min-height)
                const rowHeight = Math.max(80, requiredEventHeight);
                
                // å„²å­˜é«˜åº¦å’Œç´¯ç© Top
                rowHeights[r + 1] = { height: rowHeight, top: accumulatedTop }; // r+1 is gridRowStart
                
                // æ‡‰ç”¨åˆ° Grid è¡Œçš„ Day Div (main grid)
                for (let d = 0; d < 7; d++) {
                    const dayIndex = r * 7 + d;
                    const dayDiv = grid.children[dayIndex];
                    if (dayDiv) {
                         dayDiv.style.minHeight = `${rowHeight}px`;
                    }
                }
                
                accumulatedTop += rowHeight + gridGap; // åŠ ä¸Š grid ä¹‹é–“çš„ 4px gap
            }
            
            // 3. æ¸²æŸ“é•·æ¢ (ä½¿ç”¨å„²å­˜çš„ segment è³‡è¨Š)
            visibleCycles.forEach(record => {
                const isCompleted = record.endMileage !== null; 
                const barColor = isCompleted ? '#9ca3af' : getPlateColor(record.plate); 
                const shortPlateDisplay = getShortPlateDisplay(record.plate);
                
                if (!record.segments) return;
                
                record.segments.forEach(segment => {
                    const segmentStart = getDate(segment.start);
                    const segmentEnd = getDate(segment.end);
                    const track = segment.track;
                    
                    // --- Grid å®šä½è¨ˆç®— (ç”¨æ–¼è·¨å¤šæ—¥) ---
                    const daysSinceMonthStart = (segmentStart.getTime() - currentMonthStart.getTime()) / (1000 * 60 * 60 * 24); 
                    const totalDayIndex = daysSinceMonthStart + firstDayOfMonth; 
                    
                    let gridColStart = segmentStart.getDay() + 1; 
                    let gridColEnd = segmentEnd.getDay() + 2; 
                    
                    const collectionDate = getDate(record.collectionDate);
                    // ä¿®æ­£ 1: å¦‚æœé•·æ¢åœ¨è©²é€±æœ«çµæŸ (æ˜ŸæœŸå…­)ï¼Œä¸”é€±æœŸå°šæœªçµæŸï¼Œå‰‡ GridColEnd æ‡‰è·¨åˆ°ä¸‹ä¸€è¡Œ (8)
                    if (segmentEnd.getDay() === 6 && segmentEnd.getTime() < collectionDate.getTime()) {
                        gridColEnd = 8;
                    }
                    
                    const gridRowStart = Math.floor(totalDayIndex / 7) + 1;
                    
                    // --- çµ•å° Top ä½ç½®è¨ˆç®— (ä¿®æ­£å‚ç›´åç§») ---
                    const eventRowInfo = rowHeights[gridRowStart];
                    if (!eventRowInfo) return; 
                    
                    // çµ•å° Top = ç´¯ç© Top (å‰å¹¾è¡Œçš„ç¸½é«˜) + æ—¥æœŸæ•¸å­—ä¸‹ç·£ (24px) + è»Œé“åç§»
                    const absoluteTopOffset = eventRowInfo.top + dayNumberOffset + (track * eventHeight);
                    
                    // --- ç¹ªè£½é•·æ¢ ---
                    const eventBar = document.createElement('div');
                    eventBar.className = `event-bar`;
                    eventBar.style.backgroundColor = barColor;
                    eventBar.setAttribute('onclick', `window.scrollToRecord('${record.id}');`);
                    eventBar.title = `${shortPlateDisplay}: ${record.deliveryLocation} -> ${record.collectionLocation} (${record.deliveryDate} ${record.deliveryTime} - ${record.collectionDate} ${record.collectionTime})`;
                    
                    // Grid å®šä½
                    eventBar.style.gridColumn = `${gridColStart} / ${gridColEnd}`;
                    // æ³¨æ„ï¼šgridRowStart å¿…é ˆè¨­çµ¦çµ•å°å®šä½çš„å…ƒç´ ï¼Œæ‰èƒ½æ­£ç¢ºéŒ¨å®šé•·æ¢åœ¨æ­£ç¢ºçš„è¡Œ
                    eventBar.style.gridRowStart = gridRowStart; 
                    
                    // çµ•å°å®šä½
                    eventBar.style.top = `${absoluteTopOffset}px`;
                    eventBar.style.left = '4px'; // 4px padding/margin inside the cell
                    eventBar.style.right = '4px';
                    
                    const deliveryLoc = record.deliveryLocation.substring(0, 4);
                    const collectionLoc = record.collectionLocation.substring(0, 4);
                    const content = `${shortPlateDisplay}: ${deliveryLoc} -> ${collectionLoc} (${record.deliveryDate.substring(5).replace('-', '/')} - ${record.collectionDate.substring(5).replace('-', '/')})`;
                    eventBar.textContent = content;
                    
                    overlay.appendChild(eventBar);
                });
            });
        }
        function renderCalendar() {
            if (!calendarGrid) return;
            
            // æ¸…ç©ºæ—¥æ›†æ ¼å’Œæ’ç¨‹ç–Šå±¤
            calendarGrid.innerHTML = '';
            calendarEventsOverlay.innerHTML = ''; // Clear events overlay
            
            // è¨­ç½®æœˆä»½æ¨™é¡Œ
            currentMonthYear.textContent = currentCalendarDate.toLocaleDateString('zh-TW', {
                year: 'numeric',
                month: 'long'
            });
            const todayStr = getFormattedDate(new Date());
            const year = currentCalendarDate.getFullYear();
            const month = currentCalendarDate.getMonth();
            // 1. è©²æœˆç¬¬ä¸€å¤©æ˜¯æ˜ŸæœŸå¹¾ (0=æ—¥, 1=ä¸€...)
            const firstDayOfMonth = new Date(year, month, 1).getDay();
            // 2. è©²æœˆç¸½å…±æœ‰å¹¾å¤©
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            // å¡«å……ä¸Šå€‹æœˆçš„ç©ºç™½
            for (let i = 0; i < firstDayOfMonth; i++) {
                const emptyDay = document.createElement('div');
                emptyDay.className = "p-1 border border-gray-100 rounded-lg bg-gray-50";
                calendarGrid.appendChild(emptyDay);
                
                // ç‚º Overlay æ·»åŠ å°æ‡‰çš„ç©ºç™½ Grid Item (å¿…é ˆä¿æŒæ•¸é‡ä¸€è‡´)
                const emptyOverlay = document.createElement('div');
                emptyOverlay.className = "relative pointer-events-none"; // Ensure it's a grid item
                calendarEventsOverlay.appendChild(emptyOverlay);
            }
            // å¡«å……æœ¬æœˆæ—¥æœŸ
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                const dateStr = getFormattedDate(date);
                const dayDiv = document.createElement('div');
                // æ¯å€‹æ ¼å­éœ€è¦ç›¸å°å®šä½ä¾†å®šä½æ—¥æœŸæ•¸å­—ï¼Œä½†åŒæ™‚ä½œç‚º Grid Item
                dayDiv.className = `p-1 border border-gray-200 rounded-lg text-sm transition duration-150 calendar-day flex flex-col space-y-1 ${dateStr === todayStr ? 'bg-indigo-200 border-indigo-500' : 'bg-white'}`;
                
                dayDiv.innerHTML = `
                    <div class="day-number ${dateStr === todayStr ? 'text-indigo-800' : 'text-gray-900'}">
                        ${day}
                    </div>
                `;
                
                calendarGrid.appendChild(dayDiv);
                // ç‚º Overlay æ·»åŠ å°æ‡‰çš„ Grid Item (ç”¨æ–¼å®šä½ absolute é•·æ¢ï¼Œä¿æŒæ•¸é‡ä¸€è‡´)
                const overlayDay = document.createElement('div');
                overlayDay.className = "relative pointer-events-none"; 
                calendarEventsOverlay.appendChild(overlayDay);
            }
            
            // æ¸²æŸ“æ’ç¨‹é•·æ¢ (æ–°çš„é‚è¼¯æœƒåŒæ™‚èª¿æ•´è¡Œé«˜)
            renderEventsOverlay(allRecords); 
        }
        
        
        // æ—¥æ›†å°èˆªæ§åˆ¶
        function changeMonth(delta) {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + delta);
            renderCalendar();
        }
        
        // è¨»å†Šæ—¥æ›†äº‹ä»¶
        toggleCalendarButton.addEventListener('click', () => {
            calendarContainer.classList.toggle('hidden');
            if (!calendarContainer.classList.contains('hidden')) {
                renderCalendar();
            }
        });
        document.getElementById('prev-month').addEventListener('click', () => changeMonth(-1));
        document.getElementById('next-month').addEventListener('click', () => changeMonth(1));
        // --- END æ—¥æ›†/æ’ç¨‹é‚è¼¯ ---
        
        // --- äº‹ä»¶ç›£è½å™¨ ---
        document.addEventListener('DOMContentLoaded', () => {
            initFirebase();
            
            // è¨­ç½® Datalist é¸é … (New)
            setupDatalistOptions();
            // è¨­ç½®è»Šç‰Œé¸å–®
            const initialToday = new Date().toISOString().split('T')[0];
            const initialNowTime = new Date().toTimeString().split(' ')[0].substring(0, 5);
            const initialDateTime = createDateTime(initialToday, initialNowTime);
            setupPlateEtcMapping(getUnavailablePlatesForTime(allRecords, initialDateTime));
            
            document.getElementById('record-form').addEventListener('submit', addRecord);
            
            window.deleteLogRecord = deleteLogRecord; 
            
            // è¨»å†Šé‡æ–°æ•´ç†å’Œæœå°‹äº‹ä»¶
            window.refreshRecords = () => {
                document.getElementById('search-input').value = ''; // æ¸…ç©ºæœå°‹
                renderRecords(allRecords); // é‡æ–°æ¸²æŸ“æ‰€æœ‰ç´€éŒ„
            };
            document.getElementById('search-input').addEventListener('input', () => renderRecords(allRecords));
            // æ’åºæŒ‰éˆ•åˆ‡æ›
            sortButton.addEventListener('click', () => {
                sortDirection = sortDirection === 'desc' ? 'asc' : 'desc';
                sortIcon.textContent = sortDirection === 'desc' ? 'ğŸ“…' : 'ğŸ“†';
                sortButton.innerHTML = `<span id="sort-icon">${sortIcon.textContent}</span> æ’åº: ç”±${sortDirection === 'desc' ? 'æ–°åˆ°èˆŠ' : 'èˆŠåˆ°æ–°'}`;
                renderRecords(allRecords); // é‡æ–°æ¸²æŸ“ä»¥æ‡‰ç”¨æ–°çš„æ’åº
            });
            // åˆå§‹åŒ–æ—¥æœŸè¼¸å…¥æ¡†ç‚ºä»Šå¤©
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('record-date').value = today;
            
            // --- æ ¸å¿ƒé‚è¼¯ï¼šç•¶æ—¥æœŸæˆ–æ™‚é–“æ”¹è®Šæ™‚ï¼Œæ›´æ–°è»Šç‰Œå¯ç”¨æ€§ ---
            const updateAvailability = () => {
                const date = document.getElementById('record-date').value;
                const time = document.getElementById('record-time').value;
                if (date && time && allRecords.length > 0) {
                    const proposedDateTime = createDateTime(date, time);
                    const unavailablePlates = getUnavailablePlatesForTime(allRecords, proposedDateTime);
                    setupPlateEtcMapping(unavailablePlates);
                }
            };
            document.getElementById('record-date').addEventListener('change', updateAvailability);
            document.getElementById('record-time').addEventListener('change', updateAvailability);
            
            
            // åˆå§‹åŒ–ç•¶å‰æ—¥æœŸé¡¯ç¤º (New)
            const currentDateDisplay = document.getElementById('current-date-display');
            currentDateDisplay.textContent = new Date().toLocaleDateString('zh-TW', {
                year: 'numeric', month: 'long', day: 'numeric', weekday: 'short'
            });
        });
        // IIFE End
        })();
    </script>
</body>
</html>
