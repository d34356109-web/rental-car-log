<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>租車交車紀錄系統</title>
    <!-- 載入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* 使用 Inter 字體 */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }
        /* 自定義滾動條樣式 */
        .log-container::-webkit-scrollbar {
            height: 8px;
        }
        .log-container::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }
        .log-container::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
        /* 模態視窗背景 */
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.5);
        }
    </style>
    
    <!-- PWA / 行動裝置 App 介面設定 -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#4f46e5">
    <link rel="manifest" href="manifest.webmanifest">
</head>
<body class="p-4 md:p-8">

    <!-- 主容器 -->
    <div class="max-w-7xl mx-auto">
        <header class="mb-8 p-4 bg-white shadow-lg rounded-xl">
            <h1 class="3xl font-bold text-gray-800 mb-2">租車交車紀錄控管中心</h1>
            <p class="text-gray-500">使用 Firestore 儲存紀錄，資料即時同步。當前使用者 ID: <span id="user-id-display" class="font-mono text-xs bg-gray-100 p-1 rounded">載入中...</span></p>
        </header>

        <!-- 當前日期與排程提示 (New) -->
        <div class="mb-4 p-4 bg-indigo-50 border-l-4 border-indigo-600 rounded-lg shadow-md">
            <p class="text-sm font-semibold text-indigo-700">📆 今日日期: <span id="current-date-display" class="font-mono"></span></p>
            <!-- 調整字體大小為 text-lg，顏色為 text-red-700 -->
            <p class="text-lg font-bold text-red-700 mt-1">💡 行程提示: <span id="schedule-tip">載入中...</span></p>
        </div>

        <!-- 訊息/載入指示器 -->
        <div id="message-box" class="mb-6 p-3 rounded-lg text-sm transition-all duration-300 hidden"></div>

        <!-- 新增紀錄表單 (行動裝置上為單欄，平板以上為多欄) - 只用於交車 -->
        <div class="bg-white p-6 shadow-xl rounded-xl mb-10">
            <h2 class="text-xl font-semibold text-gray-700 mb-4 border-b pb-2">新增「交車」紀錄 (開啟新租賃週期)</h2>
            <form id="record-form" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                
                <!-- 動作 (固定為交車) -->
                <input type="hidden" id="record-action" value="交車">

                <!-- 交車資訊區塊 -->
                <div>
                    <label for="record-date" class="block text-sm font-medium text-gray-700">交車日期</label>
                    <input type="date" id="record-date" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border focus:border-indigo-500 focus:ring-indigo-500">
                </div>
                <div>
                    <label for="record-time" class="block text-sm font-medium text-gray-700">交車時間</label>
                    <input type="time" id="record-time" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border focus:border-indigo-500 focus:ring-indigo-500">
                </div>
                <div>
                    <label for="record-location" class="block text-sm font-medium text-gray-700">交車地點</label>
                    <!-- 地點改為文字輸入框 + datalist -->
                    <input type="text" id="record-location" list="location-list" placeholder="請選擇或輸入交車地點" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border focus:border-indigo-500 focus:ring-indigo-500">
                </div>
                
                <!-- 車牌 (合併顯示 ETC 卡號) -->
                <div>
                    <label for="record-plate" class="block text-sm font-medium text-gray-700">車牌 (ETC 卡號)</label>
                    <select id="record-plate" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border focus:border-indigo-500 focus:ring-indigo-500">
                        <option value="" disabled selected>請選擇車牌 (ETC 卡號)</option>
                    </select>
                </div>
                
                <!-- 里程數 (交車時的起始里程) -->
                <div>
                    <label for="record-mileage" class="block text-sm font-medium text-gray-700">起始里程數 (Km)</label>
                    <input type="number" id="record-mileage" placeholder="例如: 12500" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border focus:border-indigo-500 focus:ring-indigo-500">
                </div>

                <!-- 需求/備註 -->
                <div class="md:col-span-2">
                    <label for="record-notes" class="block text-sm font-medium text-gray-700">需求 / 備註 (交車資訊)</label>
                    <textarea id="record-notes" rows="2" placeholder="例如: 兩張兒童座椅(2歲跟5歲)；車型: Toyota 40系" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border focus:border-indigo-500 focus:ring-indigo-500"></textarea>
                </div>
                
                <!-- 客戶資料區塊 -->
                <div class="md:col-span-3 grid grid-cols-1 sm:grid-cols-3 gap-4 p-4 border rounded-lg bg-gray-50 mt-4">
                    <div class="sm:col-span-3 text-sm font-semibold text-gray-700 border-b pb-2 mb-2">客戶資料 (選填)</div>
                    <div>
                        <label for="customer-name" class="block text-sm font-medium text-gray-700">客戶姓名</label>
                        <input type="text" id="customer-name" placeholder="例如: 王小明" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border focus:border-indigo-500 focus:ring-indigo-500">
                    </div>
                    <div>
                        <label for="customer-phone" class="block text-sm font-medium text-gray-700">聯絡電話</label>
                        <input type="tel" id="customer-phone" placeholder="例如: 0912345678" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border focus:border-indigo-500 focus:ring-indigo-500">
                    </div>
                    <div>
                        <label for="customer-dob" class="block text-sm font-medium text-gray-700">出生年月日</label>
                        <input type="date" id="customer-dob" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border focus:border-indigo-500 focus:ring-indigo-500">
                    </div>
                </div>

                <!-- 提交按鈕 -->
                <div class="md:col-span-3 flex justify-end">
                    <button type="submit" id="submit-button" class="mt-4 px-6 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition duration-150 disabled:bg-indigo-400">
                        新增交車紀錄
                    </button>
                </div>
            </form>
        </div>

        <!-- 紀錄列表與查詢 -->
        <div class="bg-white p-6 shadow-xl rounded-xl">
            <h2 class="text-xl font-semibold text-gray-700 mb-4 border-b pb-2">所有租賃週期紀錄</h2>
            
            <!-- 查詢/排序控制項 -->
            <div class="flex flex-col sm:flex-row gap-4 mb-4">
                <input type="text" id="search-input" placeholder="查詢：輸入地點、車牌、備註關鍵字" class="flex-grow p-2 border rounded-lg focus:border-indigo-500">
                <button id="sort-button" class="p-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition duration-150 flex-shrink-0">
                    <span id="sort-icon">📅</span> 排序: 由新到舊
                </button>
            </div>

            <!-- 紀錄表格容器 (恢復響應式表格) -->
            <div class="log-container overflow-x-auto rounded-lg border border-gray-200">
                <table class="min-w-full divide-y divide-gray-200">
                    <!-- 表格標頭：簡潔顯示 (4 欄位) -->
                    <thead class="bg-gray-50 sticky top-0">
                        <tr>
                            <th class="px-1 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-20">狀態</th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">交車 / 收車時間</th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">地點</th>
                            <th class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">收車/操作</th>
                        </tr>
                    </thead>
                    <tbody id="records-table-body" class="bg-white divide-y divide-gray-200">
                        <!-- 紀錄將會動態載入此處 -->
                    </tbody>
                </table>
                <p id="no-records-message" class="text-center py-10 text-gray-500 hidden">目前沒有任何紀錄。</p>
            </div>
        </div>

    </div>

    <!-- 收車模態視窗 (Collection Modal) -->
    <div id="collection-modal" class="fixed inset-0 z-50 hidden modal-backdrop flex items-center justify-center p-4" aria-modal="true" role="dialog">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg p-6 transform transition-all duration-300 scale-95 opacity-0 max-h-[90vh] overflow-y-auto" id="collection-modal-content">
            <h3 class="text-xl font-bold text-gray-800 border-b pb-3 mb-4" id="modal-title"></h3>
            
            <p class="text-sm text-gray-600 mb-4">正在為 <span id="modal-plate-display" class="font-bold text-indigo-600"></span> 記錄資訊。</p>

            <form id="collection-form">
                <input type="hidden" id="modal-record-id">
                <input type="hidden" id="modal-mode"> <!-- 隱藏欄位用於判斷模式：'full' 或 'mileage' -->

                <div class="grid grid-cols-2 gap-4">
                    <!-- 收車日期 -->
                    <div id="modal-date-container">
                        <label for="collection-date" class="block text-sm font-medium text-gray-700">收車日期</label>
                        <input type="date" id="collection-date" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border focus:border-indigo-500 focus:ring-indigo-500">
                    </div>
                    <!-- 收車時間 -->
                    <div id="modal-time-container">
                        <label for="collection-time" class="block text-sm font-medium text-gray-700">收車時間</label>
                        <input type="time" id="collection-time" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border focus:border-indigo-500 focus:ring-indigo-500">
                    </div>
                    <!-- 收車地點 -->
                    <div class="col-span-2" id="modal-location-container">
                        <label for="collection-location" class="block text-sm font-medium text-gray-700">收車地點</label>
                        <!-- 地點改為文字輸入框 + datalist -->
                        <input type="text" id="collection-location" list="location-list" placeholder="請選擇或輸入收車地點" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border focus:border-indigo-500 focus:ring-indigo-500">
                    </div>
                    <!-- 結束里程數 -->
                    <div class="col-span-2" id="modal-mileage-container">
                        <label for="end-mileage" class="block text-sm font-medium text-gray-700">結束里程數 (Km)</label>
                        <input type="number" id="end-mileage" placeholder="請輸入收車時里程數" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border focus:border-indigo-500 focus:ring-indigo-500">
                        <p class="text-xs text-gray-500 mt-1">交車里程數: <span id="modal-start-mileage"></span> Km</p>
                    </div>
                </div>

                <div class="flex justify-end space-x-3 mt-6">
                    <button type="button" onclick="window.closeCollectionModal()" class="px-4 py-2 text-gray-600 bg-gray-200 rounded-lg hover:bg-gray-300 transition duration-150">取消</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 transition duration-150" id="collection-submit-btn">
                        確認並儲存
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- 編輯模態視窗 (Edit Modal - New) -->
    <div id="edit-modal" class="fixed inset-0 z-50 hidden modal-backdrop flex items-center justify-center p-4" aria-modal="true" role="dialog">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl p-6 transform transition-all duration-300 scale-95 opacity-0 max-h-[90vh] overflow-y-auto" id="edit-modal-content">
            <h3 class="text-xl font-bold text-gray-800 border-b pb-3 mb-4">編輯租賃週期紀錄</h3>
            
            <form id="edit-form">
                <input type="hidden" id="edit-record-id">
                
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">

                    <!-- 左側：交車資訊 (Delivery) -->
                    <div class="p-4 border rounded-lg bg-indigo-50 space-y-3">
                        <h4 class="font-bold text-lg text-indigo-700 border-b pb-2 mb-3">交車資訊 (Delivery)</h4>
                        
                        <div>
                            <label for="edit-plate" class="block text-sm font-medium text-gray-700">車牌 (不可修改)</label>
                            <input type="text" id="edit-plate" readonly class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 bg-gray-200 text-gray-600">
                        </div>
                        
                        <div>
                            <label for="edit-delivery-date" class="block text-sm font-medium text-gray-700">交車日期</label>
                            <input type="date" id="edit-delivery-date" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border">
                        </div>
                        
                        <div>
                            <label for="edit-delivery-time" class="block text-sm font-medium text-gray-700">交車時間</label>
                            <input type="time" id="edit-delivery-time" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border">
                        </div>
                        
                        <div>
                            <label for="edit-delivery-location" class="block text-sm font-medium text-gray-700">交車地點</label>
                            <!-- 地點改為文字輸入框 + datalist -->
                            <input type="text" id="edit-delivery-location" list="location-list" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border">
                        </div>
                        
                        <div>
                            <label for="edit-start-mileage" class="block text-sm font-medium text-gray-700">起始里程數 (Km)</label>
                            <input type="number" id="edit-start-mileage" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border">
                        </div>
                    </div>

                    <!-- 中間：收車資訊 (Collection) -->
                    <div class="p-4 border rounded-lg bg-yellow-50 space-y-3">
                        <h4 class="font-bold text-lg text-yellow-700 border-b pb-2 mb-3">收車資訊 (Collection)</h4>
                        
                        <div>
                            <label for="edit-collection-date" class="block text-sm font-medium text-gray-700">收車日期</label>
                            <input type="date" id="edit-collection-date" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border">
                        </div>
                        
                        <div>
                            <label for="edit-collection-time" class="block text-sm font-medium text-gray-700">收車時間</label>
                            <input type="time" id="edit-collection-time" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border">
                        </div>
                        
                        <div>
                            <label for="edit-collection-location" class="block text-sm font-medium text-gray-700">收車地點</label>
                             <!-- 地點改為文字輸入框 + datalist -->
                            <input type="text" id="edit-collection-location" list="location-list" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border">
                        </div>
                        
                        <div>
                            <label for="edit-end-mileage" class="block text-sm font-medium text-gray-700">結束里程數 (Km)</label>
                            <input type="number" id="edit-end-mileage" placeholder="待登錄則留空" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border">
                        </div>
                    </div>
                    
                    <!-- 右側：客戶與備註 -->
                    <div class="p-4 border rounded-lg bg-gray-50 space-y-3">
                        <h4 class="font-bold text-lg text-gray-700 border-b pb-2 mb-3">客戶資訊與備註</h4>
                        
                        <div>
                            <label for="edit-customer-name" class="block text-sm font-medium text-gray-700">客戶姓名</label>
                            <input type="text" id="edit-customer-name" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border">
                        </div>
                        
                        <div>
                            <label for="edit-customer-phone" class="block text-sm font-medium text-gray-700">聯絡電話</label>
                            <input type="tel" id="edit-customer-phone" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border">
                        </div>

                        <div>
                            <label for="edit-customer-dob" class="block text-sm font-medium text-gray-700">出生年月日</label>
                            <input type="date" id="edit-customer-dob" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border">
                        </div>
                        
                        <div>
                            <label for="edit-notes" class="block text-sm font-medium text-gray-700">需求 / 備註</label>
                            <textarea id="edit-notes" rows="3" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border"></textarea>
                        </div>
                    </div>
                </div>

                <div class="flex justify-end space-x-3 mt-6">
                    <button type="button" onclick="window.closeEditModal()" class="px-4 py-2 text-gray-600 bg-gray-200 rounded-lg hover:bg-gray-300 transition duration-150">取消</button>
                    <button type="submit" class="px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition duration-150" id="edit-submit-btn">
                        確認修改並儲存
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Datalist for Location Suggestions (for select-or-custom-input behavior) -->
    <datalist id="location-list">
        <!-- Options populated by JavaScript -->
    </datalist>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, deleteDoc, doc, updateDoc, setLogLevel, Timestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // 設定 Firebase Debug Log
        setLogLevel('Debug');

        // =================================================================
        // *** 您的 Firebase 專案配置已成功載入！ ***
        // =================================================================
        const firebaseConfig = {
            apiKey: "AIzaSyAqksNR1a1Tf4OgL8X2ezT8u5rlFygNHPc",
            authDomain: "rentalcarlog-app.firebaseapp.com",
            projectId: "rentalcarlog-app",
            storageBucket: "rentalcarlog-app.firebasestorage.app",
            messagingSenderId: "68461236293",
            appId: "1:68461236293:web:2ab0179cc52585ab74932c",
            measurementId: "G-C7LWGH36JY"
        };
        const YOUR_PROJECT_ID = "rentalcarlog-app"; 
        // =================================================================

        // =================================================================
        // *** 固定車牌與 ETC 卡號對應表 (車牌下拉選單用) ***
        // =================================================================
        const CAR_ETC_MAPPING = {
            "なにわ334わ8888 40系": "9160 0000 1326 8609",
            "和泉330わ3333 7座 中文導航": "9160 0000 1326 6207",
            "成田331わ7777 總統座": "9160 0000 1326 6009",
            "成田331わ88 4WD 8座": "9160 0000 1410 6501",
        };

        // =================================================================
        // *** 地點選項列表 (已還原) ***
        // =================================================================
        const LOCATION_OPTIONS = [
            "成田空港T1",
            "成田空港T2",
            "羽田空港T3",
            "東京"
        ]; 
        // =================================================================

        let app;
        let db;
        let auth;
        let userId = null;
        let isAuthReady = false;
        let allRecords = []; // 儲存從 Firestore 獲取的所有紀錄
        let sortDirection = 'desc'; // 'desc' (新到舊) 或 'asc' (舊到新)

        const messageBox = document.getElementById('message-box');
        const recordsTableBody = document.getElementById('records-table-body');
        const noRecordsMessage = document.getElementById('no-records-message');
        const userIdDisplay = document.getElementById('user-id-display');
        const sortButton = document.getElementById('sort-button');
        const sortIcon = document.getElementById('sort-icon');
        const plateSelect = document.getElementById('record-plate');
        // 地點元素現在是 Input (透過 list 屬性連接 datalist)
        const locationSelect = document.getElementById('record-location'); 
        const collectionLocationSelect = document.getElementById('collection-location'); 
        
        // 新增的客戶資料輸入欄位
        const customerNameInput = document.getElementById('customer-name');
        const customerPhoneInput = document.getElementById('customer-phone');
        const customerDobInput = document.getElementById('customer-dob');
        
        // 編輯模態視窗元素
        const editPlateInput = document.getElementById('edit-plate');
        const editDeliveryDateInput = document.getElementById('edit-delivery-date');
        const editDeliveryTimeInput = document.getElementById('edit-delivery-time');
        const editDeliveryLocationSelect = document.getElementById('edit-delivery-location');
        const editStartMileageInput = document.getElementById('edit-start-mileage');
        const editCollectionDateInput = document.getElementById('edit-collection-date');
        const editCollectionTimeInput = document.getElementById('edit-collection-time');
        const editCollectionLocationSelect = document.getElementById('edit-collection-location');
        const editEndMileageInput = document.getElementById('edit-end-mileage');
        const editCustomerNameInput = document.getElementById('edit-customer-name');
        const editCustomerPhoneInput = document.getElementById('edit-customer-phone');
        const editCustomerDobInput = document.getElementById('edit-customer-dob');
        const editNotesInput = document.getElementById('edit-notes');


        /** 顯示應用程式訊息 */
        function displayMessage(text, type = 'info') {
            messageBox.textContent = text;
            messageBox.className = 'mb-6 p-3 rounded-lg text-sm transition-all duration-300';
            messageBox.classList.remove('hidden');

            switch (type) {
                case 'success':
                    messageBox.classList.add('bg-green-100', 'text-green-800');
                    break;
                case 'error':
                    messageBox.classList.add('bg-red-100', 'text-red-800');
                    break;
                case 'info':
                default:
                    messageBox.classList.add('bg-blue-100', 'text-blue-800');
                    break;
            }

            setTimeout(() => {
                messageBox.classList.add('hidden');
            }, 5000);
        }

        /** 格式化日期為 YYYY-MM-DD 格式 */
        function getFormattedDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }


        // --- Firebase 初始化和認證 ---
        function initFirebase() {
            const submitButton = document.getElementById('submit-button'); // 取得按鈕元素
            
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                // 認證狀態變更監聽
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        userIdDisplay.textContent = userId;
                        isAuthReady = true;
                        submitButton.disabled = false; // 認證成功，啟用按鈕
                        console.log("Firebase 認證完成，User ID:", userId);
                        fetchRecords(); // 認證完成後開始監聽紀錄
                    } else {
                        // 運行在本地環境，我們使用標準的匿名登入
                        try {
                             await signInAnonymously(auth);
                        } catch (error) {
                            console.error("認證失敗:", error);
                            displayMessage("認證失敗，請檢查網路或 Firebase 專案設定。", 'error');
                            submitButton.disabled = true; // 認證失敗，禁用按鈕
                            userIdDisplay.textContent = '認證失敗 (連線異常)'; 
                            isAuthReady = true; 
                        }
                    }
                });

            } catch (e) {
                console.error("Firebase 初始化失敗:", e);
                displayMessage(`Firebase 初始化失敗。錯誤訊息: ${e.message}。無法儲存紀錄。`, 'error'); 
                submitButton.disabled = true; // 禁用按鈕
                userIdDisplay.textContent = '初始化錯誤'; 
                isAuthReady = true;
            }
        }

        /** 獲取 Firestore Collection Path (共享路徑) */
        function getCollectionPath() {
            // 協作路徑: 所有登入的使用者 (A & B) 都將存取此路徑
            const sharedAppId = 'd34356109-rental-log-app'; // 固定的應用程式識別碼
            const sharedCollectionName = 'rental_records_shared';
            
            return `artifacts/${sharedAppId}/public/data/${sharedCollectionName}`;
        }


        // --- 資料操作 (CRUD) ---

        /** 新增紀錄到 Firestore (僅限交車) */
        async function addRecord(event) {
            event.preventDefault();
            if (!db || !userId) {
                displayMessage("資料庫連線或用戶認證失敗，無法儲存紀錄。請檢查設定或重新載入。", 'error');
                return;
            }

            document.getElementById('submit-button').disabled = true;

            // 客戶資料 (選填)
            const customerName = customerNameInput.value || '';
            const customerPhone = customerPhoneInput.value || '';
            const customerDob = customerDobInput.value || '';

            // 交車資訊 (必填)
            const date = document.getElementById('record-date').value;
            const time = document.getElementById('record-time').value;
            const action = document.getElementById('record-action').value; // 固定為 '交車'
            const location = locationSelect.value.trim(); // 從 Input 獲取值並清理
            const plate = plateSelect.value; 
            
            const etcId = CAR_ETC_MAPPING[plate]; 
            
            const mileage = document.getElementById('record-mileage').value;
            const notes = document.getElementById('record-notes').value || '';

            if (!plate || !etcId) {
                displayMessage("請選擇車牌 (ETC 卡號會自動從選單中帶入)。", 'error');
                document.getElementById('submit-button').disabled = false;
                return;
            }
            
            // 檢查車牌是否被禁用 (二次防呆，確保選單未被繞過)
            const selectedOption = plateSelect.options[plateSelect.selectedIndex];
            if (selectedOption && selectedOption.disabled) {
                 displayMessage("所選車牌目前正在租賃週期中，請先完成收車後再進行交車。", 'error');
                 document.getElementById('submit-button').disabled = false;
                 return;
            }


            if (!location) {
                displayMessage("請輸入交車地點。", 'error');
                document.getElementById('submit-button').disabled = false;
                return;
            }

            const dateTimeString = `${date}T${time}:00`;
            const recordTime = new Date(dateTimeString);
            
            if (isNaN(recordTime)) {
                displayMessage("日期或時間格式無效。", 'error');
                document.getElementById('submit-button').disabled = false;
                return;
            }

            const newRecord = {
                // 客戶資料
                customerName: customerName,
                customerPhone: customerPhone,
                customerDob: customerDob,

                // 交車資訊
                action: action, // 交車
                deliveryDate: date,
                deliveryTime: time,
                deliveryLocation: location,
                startMileage: parseInt(mileage, 10), // 起始里程
                plate: plate,
                etcId: etcId,
                notes: notes,
                
                // 收車資訊 (預設為空，表示週期開放)
                collectionDate: null,
                collectionTime: null,
                collectionLocation: null,
                endMileage: null,
                
                timestamp: Timestamp.fromDate(recordTime) // 使用交車時間作為主要排序
            };

            try {
                const collectionRef = collection(db, getCollectionPath());
                await addDoc(collectionRef, newRecord);
                displayMessage("交車紀錄儲存成功！週期已開啟。", 'success');
                document.getElementById('record-form').reset();
            } catch (e) {
                console.error("新增文件時發生錯誤:", e);
                displayMessage(`儲存失敗: ${e.message}`, 'error');
            } finally {
                document.getElementById('submit-button').disabled = false;
            }
        }

        /** 更新紀錄 (收車或登錄里程) */
        async function submitCollectionUpdate(event) {
            event.preventDefault();
            if (!db || !userId) {
                displayMessage("資料庫連線或用戶認證失敗，無法完成收車。", 'error');
                return;
            }

            const recordId = document.getElementById('modal-record-id').value;
            const mode = document.getElementById('modal-mode').value;
            
            const collectionDate = document.getElementById('collection-date').value;
            const collectionTime = document.getElementById('collection-time').value;
            const collectionLocation = collectionLocationSelect.value.trim(); // 從 Input 獲取值並清理
            const endMileageInput = document.getElementById('end-mileage').value;
            
            const updateData = {};
            const collectionSubmitBtn = document.getElementById('collection-submit-btn');

            // 取得起始里程 (用於里程檢查)
            const record = allRecords.find(r => r.id === recordId);
            const startMileage = record ? record.startMileage : 0;
            
            collectionSubmitBtn.disabled = true;

            if (mode === 'full') {
                // --- 模式 1: 記錄時間/地點 (預收車) ---
                if (!collectionDate || !collectionTime || !collectionLocation) {
                    displayMessage("請填寫完整的收車時間和地點。", 'error');
                    collectionSubmitBtn.disabled = false;
                    return;
                }

                updateData.collectionDate = collectionDate;
                updateData.collectionTime = collectionTime;
                updateData.collectionLocation = collectionLocation;
                // endMileage 仍然為 null，保持「待登錄里程」狀態
                
                // 如果用戶在 'full' 模式下也輸入了里程，則直接完成
                if (endMileageInput) {
                    const endMileage = parseInt(endMileageInput, 10);
                    if (isNaN(endMileage) || endMileage < startMileage) {
                        displayMessage(`結束里程數無效或低於起始里程 (${startMileage.toLocaleString()} Km)。`, 'error');
                        collectionSubmitBtn.disabled = false;
                        return;
                    }
                    updateData.endMileage = endMileage;
                }

            } else if (mode === 'mileage') {
                // --- 模式 2: 登錄最終里程 (結算) ---
                const endMileage = parseInt(endMileageInput, 10);
                
                if (isNaN(endMileage)) {
                    displayMessage("請輸入有效的結束里程數。", 'error');
                    collectionSubmitBtn.disabled = false;
                    return;
                }
                if (endMileage < startMileage) {
                     displayMessage(`收車里程 (${endMileage.toLocaleString()} Km) 不得低於交車里程 (${startMileage.toLocaleString()} Km)。`, 'error');
                     collectionSubmitBtn.disabled = false;
                     return;
                }
                
                updateData.endMileage = endMileage;
            }

            try {
                const docRef = doc(db, getCollectionPath(), recordId);
                await updateDoc(docRef, updateData);

                if (updateData.endMileage) {
                     displayMessage(`收車紀錄已完成！里程差: ${(updateData.endMileage - startMileage).toLocaleString()} Km`, 'success');
                } else {
                     displayMessage(`收車時間/地點已記錄，待登錄最終里程。`, 'success');
                }
                
                window.closeCollectionModal();

            } catch (e) {
                console.error("更新收車紀錄時發生錯誤:", e);
                displayMessage(`儲存失敗: ${e.message}`, 'error');
            } finally {
                collectionSubmitBtn.disabled = false;
            }
        }

        /** 刪除紀錄 */
        async function deleteLogRecord(id) {
            // 檢查 Firebase 是否成功初始化 (db存在) 且用戶已認證
            if (!db || !userId) {
                displayMessage("應用程式初始化失敗或認證未完成，無法執行刪除操作。", 'error');
                return;
            }
            
            const confirmation = confirm(`確定要刪除這筆 ID 為 ${id.substring(0, 8)}... 的完整週期紀錄嗎？`);
            if (!confirmation) return;

            try {
                const docRef = doc(db, getCollectionPath(), id);
                await deleteDoc(docRef);
                displayMessage("紀錄已刪除。", 'success');
            } catch (e) {
                console.error("刪除文件時發生錯誤:", e);
                displayMessage(`刪除失敗: ${e.message}`, 'error');
            }
        }
        
        // --- 模態視窗邏輯 ---
        function openCollectionModal(recordId, mode) {
            const record = allRecords.find(r => r.id === recordId);
            if (!record) {
                displayMessage("錯誤: 找不到該筆紀錄資料，請重整頁面。", 'error');
                return;
            }
            
            const modal = document.getElementById('collection-modal');
            const modalContent = document.getElementById('collection-modal-content');
            
            const modalTitle = document.getElementById('modal-title');
            const modalModeInput = document.getElementById('modal-mode');

            // 設置通用值
            document.getElementById('modal-record-id').value = recordId;
            document.getElementById('modal-plate-display').textContent = record.plate;
            document.getElementById('modal-start-mileage').textContent = record.startMileage ? record.startMileage.toLocaleString() : '0';
            modalModeInput.value = mode;

            // 設置收車地點 Input 值
            collectionLocationSelect.value = record.collectionLocation || '';

            // 清除上次的輸入值
            document.getElementById('end-mileage').value = ''; 
            
            if (mode === 'mileage') {
                // --- 模式 2: 僅登錄里程 ---
                modalTitle.textContent = '登錄結束里程數 (完成結算)';
                document.getElementById('collection-submit-btn').textContent = '確認登錄並完成結算';
                
                document.getElementById('modal-date-container').classList.add('hidden');
                document.getElementById('modal-time-container').classList.add('hidden');
                document.getElementById('modal-location-container').classList.add('hidden');
                document.getElementById('modal-mileage-container').classList.remove('col-span-2');
                document.getElementById('modal-mileage-container').classList.add('col-span-2');
                document.getElementById('end-mileage').required = true;
                
            } else {
                // --- 模式 1: 記錄收車時間/地點 (full) ---
                modalTitle.textContent = '記錄收車時間與地點';
                document.getElementById('collection-submit-btn').textContent = '確認並儲存收車時間';

                document.getElementById('modal-date-container').classList.remove('hidden');
                document.getElementById('modal-time-container').classList.remove('hidden');
                document.getElementById('modal-location-container').classList.remove('hidden');
                document.getElementById('modal-mileage-container').classList.remove('col-span-2'); 
                
                document.getElementById('end-mileage').required = false; 
                
                // 預設日期和時間
                const today = new Date().toISOString().split('T')[0];
                const nowTime = new Date().toTimeString().split(' ')[0].substring(0, 5);
                document.getElementById('collection-date').value = record.collectionDate || today;
                document.getElementById('collection-time').value = record.collectionTime || nowTime;
                
            }

            // 顯示模態視窗
            modal.classList.remove('hidden');
            setTimeout(() => {
                modalContent.classList.remove('scale-95', 'opacity-0');
                modalContent.classList.add('scale-100', 'opacity-100');
            }, 10);
        }

        function closeCollectionModal() {
            const modal = document.getElementById('collection-modal');
            const modalContent = document.getElementById('collection-modal-content');
            
            // 隱藏模態視窗
            modalContent.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                modal.classList.add('hidden');
                document.getElementById('collection-form').reset();
            }, 300);
        }
        window.openCollectionModal = openCollectionModal;
        window.closeCollectionModal = closeCollectionModal;
        document.getElementById('collection-form').addEventListener('submit', submitCollectionUpdate);
        
        // --- 編輯模態視窗邏輯 (New) ---

        function openEditModal(recordId) {
            const record = allRecords.find(r => r.id === recordId);
            if (!record) {
                displayMessage("錯誤: 找不到該筆紀錄資料，請重整頁面。", 'error');
                return;
            }

            // 1. 設置 ID
            document.getElementById('edit-record-id').value = recordId;

            // 2. 設置交車資訊
            editPlateInput.value = record.plate; // 車牌不可編輯
            editDeliveryDateInput.value = record.deliveryDate;
            editDeliveryTimeInput.value = record.deliveryTime;
            editStartMileageInput.value = record.startMileage;
            editNotesInput.value = record.notes || '';
            
            // 設置交車地點 Input 值
            editDeliveryLocationSelect.value = record.deliveryLocation || '';


            // 3. 設置收車資訊
            editCollectionDateInput.value = record.collectionDate || '';
            editCollectionTimeInput.value = record.collectionTime || '';
            editEndMileageInput.value = record.endMileage || '';
            
            // 設置收車地點 Input 值
            editCollectionLocationSelect.value = record.collectionLocation || '';
            
            // 4. 設置客戶資訊
            editCustomerNameInput.value = record.customerName || '';
            editCustomerPhoneInput.value = record.customerPhone || '';
            editCustomerDobInput.value = record.customerDob || '';
            
            // 顯示模態視窗
            const modal = document.getElementById('edit-modal');
            const modalContent = document.getElementById('edit-modal-content');
            modal.classList.remove('hidden');
            setTimeout(() => {
                modalContent.classList.remove('scale-95', 'opacity-0');
                modalContent.classList.add('scale-100', 'opacity-100');
            }, 10);
        }

        async function submitEditUpdate(event) {
            event.preventDefault();
            if (!db || !userId) {
                displayMessage("資料庫連線或用戶認證失敗，無法儲存修改。", 'error');
                return;
            }
            
            const recordId = document.getElementById('edit-record-id').value;
            const originalRecord = allRecords.find(r => r.id === recordId);
            const editSubmitBtn = document.getElementById('edit-submit-btn');

            if (!originalRecord) {
                displayMessage("找不到原始紀錄，無法修改。", 'error');
                return;
            }

            editSubmitBtn.disabled = true;
            
            const startMileage = parseInt(editStartMileageInput.value, 10);
            const endMileage = editEndMileageInput.value ? parseInt(editEndMileageInput.value, 10) : null;
            
            // --- 里程數防呆檢查 ---
            if (endMileage !== null && endMileage < startMileage) {
                displayMessage(`錯誤: 結束里程 (${endMileage.toLocaleString()} Km) 不得低於起始里程 (${startMileage.toLocaleString()} Km)。`, 'error');
                editSubmitBtn.disabled = false;
                return;
            }
            
            // 準備更新數據
            const updateData = {
                // 交車資訊 (Delivery) - 可編輯
                deliveryDate: editDeliveryDateInput.value,
                deliveryTime: editDeliveryTimeInput.value,
                deliveryLocation: editDeliveryLocationSelect.value.trim(), // 從 Input 獲取值並清理
                startMileage: startMileage,
                notes: editNotesInput.value || '',

                // 收車資訊 (Collection) - 可編輯
                collectionDate: editCollectionDateInput.value || null,
                collectionTime: editCollectionTimeInput.value || null,
                collectionLocation: editCollectionLocationSelect.value.trim() || null, // 從 Input 獲取值並清理
                endMileage: endMileage,

                // 客戶資訊 - 可編輯
                customerName: editCustomerNameInput.value || null,
                customerPhone: editCustomerPhoneInput.value || null,
                customerDob: editCustomerDobInput.value || null,
                
                // 保持原有的 timestamp 用於排序
                timestamp: originalRecord.timestamp 
            };
            
            // 檢查是否影響防呆機制 (只有在修改交車或收車狀態時才檢查)
            const oldPlate = originalRecord.plate;
            const newStartMileage = updateData.startMileage;
            const newEndMileage = updateData.endMileage;

            // 如果交車里程被清空或不合法
            if (isNaN(newStartMileage)) {
                displayMessage("起始里程必須是有效數字。", 'error');
                editSubmitBtn.disabled = false;
                return;
            }

            // 如果紀錄從已完成變為待收車，則需要檢查車輛是否會與其他紀錄衝突
            const wasCompleted = originalRecord.endMileage !== null;
            const isNowCompleted = newEndMileage !== null;
            
            if (wasCompleted && !isNowCompleted) {
                // 檢查是否有其他紀錄現在佔用了這輛車
                const currentlyUnavailable = getUnavailablePlates(allRecords.filter(r => r.id !== recordId));
                if (currentlyUnavailable.includes(oldPlate)) {
                    displayMessage(`錯誤: 此車牌 (${oldPlate}) 在其他週期中已被租出，無法將本紀錄設為「待收車」。`, 'error');
                    editSubmitBtn.disabled = false;
                    return;
                }
            }


            try {
                const docRef = doc(db, getCollectionPath(), recordId);
                await updateDoc(docRef, updateData);
                displayMessage("紀錄修改成功！", 'success');
                window.closeEditModal();
            } catch (e) {
                console.error("更新文件時發生錯誤:", e);
                displayMessage(`修改失敗: ${e.message}`, 'error');
            } finally {
                editSubmitBtn.disabled = false;
            }
        }

        function closeEditModal() {
            const modal = document.getElementById('edit-modal');
            const modalContent = document.getElementById('edit-modal-content');
            
            modalContent.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300);
        }
        window.openEditModal = openEditModal;
        window.closeEditModal = closeEditModal;
        document.getElementById('edit-form').addEventListener('submit', submitEditUpdate);
        // --- END 編輯模態視窗邏輯 ---


        
        // --- 車輛防呆邏輯 ---
        
        /** 獲取目前所有尚未完成結算 (endMileage === null) 的車牌 */
        function getUnavailablePlates(records) {
            return records
                .filter(record => record.endMileage === null)
                .map(record => record.plate);
        }

        /** 設置車牌和 ETC 卡號的對應邏輯 */
        function setupPlateEtcMapping(unavailablePlates = []) {
            plateSelect.innerHTML = '<option value="" disabled selected>請選擇車牌 (ETC 卡號)</option>'; 
            
            Object.keys(CAR_ETC_MAPPING).forEach(plateDescription => {
                const etcId = CAR_ETC_MAPPING[plateDescription];
                const option = document.createElement('option');
                option.value = plateDescription; 
                
                if (unavailablePlates.includes(plateDescription)) {
                    // 車輛已租出，禁用選項
                    option.textContent = `${plateDescription} (已租出)`; 
                    option.disabled = true;
                } else {
                    // 車輛可選
                    option.textContent = `${plateDescription} (${etcId})`; 
                }
                
                plateSelect.appendChild(option);
            });
        }
        // --- END 車輛防呆邏輯 ---


        /** 設置地點 Datalist 選項 (New) */
        function setupDatalistOptions() {
            const datalist = document.getElementById('location-list');
            if (!datalist) return;
            datalist.innerHTML = '';
            
            LOCATION_OPTIONS.forEach(location => {
                const option = document.createElement('option');
                option.value = location;
                datalist.appendChild(option);
            });
        }


        /** 顯示/隱藏詳細資訊 */
        function toggleDetails(id) {
            const detailRow = document.getElementById(`detail-row-${id}`);
            const expandIcon = document.getElementById(`expand-icon-${id}`);
            if (detailRow) {
                const isHidden = detailRow.classList.toggle('hidden');
                if (expandIcon) {
                    expandIcon.textContent = isHidden ? '▼' : '▲';
                }
            }
        }
        window.toggleDetails = toggleDetails;
        
        /** 更新行程提示 (New) */
        function updateScheduleTip() {
            const today = new Date();
            const tomorrow = new Date();
            tomorrow.setDate(today.getDate() + 1);

            const todayStr = getFormattedDate(today);
            const tomorrowStr = getFormattedDate(tomorrow);

            // 1. 今日收車: collectionDate = today 且 endMileage = null
            const todayCollections = allRecords.filter(record => 
                record.collectionDate === todayStr && record.endMileage === null
            );

            // 2. 明日收車 (New): collectionDate = tomorrow 且 endMileage = null
            const tomorrowCollections = allRecords.filter(record => 
                record.collectionDate === tomorrowStr && record.endMileage === null
            );

            // 3. 明日交車: deliveryDate = tomorrow
            const tomorrowDeliveries = allRecords.filter(record => 
                record.deliveryDate === tomorrowStr
            );

            let tipParts = [];

            // Helper function to format details
            const formatDetails = (records, type) => {
                if (records.length === 0) return '';
                
                // Determine which fields to use
                const timeField = (type === 'Delivery' ? 'deliveryTime' : 'collectionTime');
                const locationField = (type === 'Delivery' ? 'deliveryLocation' : 'collectionLocation');

                // 格式範例: 和泉330わ3333，時間：19:00，地點：成田空港T1
                const details = records.map(r => {
                    const plate = r.plate.split(' ')[0]; // 簡化的車牌號碼
                    const time = r[timeField];
                    const location = r[locationField];
                    return `${plate}，時間：${time}，地點：${location}`; // Updated format
                }).join('； '); // 使用分號 (；) 分隔

                const typeText = (type === 'Delivery' ? '交車' : '收車');
                const dayText = (records[0].deliveryDate === todayStr || records[0].collectionDate === todayStr) ? '今天' : '明天';
                
                return `${dayText}有 **${records.length}** 筆${typeText}排程: ${details}。`;
            };

            // --- A. 今日收車 ---
            if (todayCollections.length > 0) {
                tipParts.push(formatDetails(todayCollections, 'Collection'));
            }

            // --- B. 明日收車 ---
            if (tomorrowCollections.length > 0) {
                tipParts.push(formatDetails(tomorrowCollections, 'Collection'));
            }

            // --- C. 明日交車 ---
            if (tomorrowDeliveries.length > 0) {
                tipParts.push(formatDetails(tomorrowDeliveries, 'Delivery'));
            }
            
            const tipElement = document.getElementById('schedule-tip'); 
            
            if (tipParts.length === 0) {
                tipElement.innerHTML = `無當前重要排程提示。`;
                tipElement.classList.remove('font-bold');
            } else {
                tipElement.innerHTML = tipParts.join(' ');
                tipElement.classList.add('font-bold');
            }
        }


        /** 渲染紀錄列表 (點擊展開模式) */
        function renderRecords(records) {
            recordsTableBody.innerHTML = '';
            
            if (records.length === 0) {
                noRecordsMessage.classList.remove('hidden');
                updateScheduleTip(); // 確保無紀錄時提示也能更新
                return;
            }

            noRecordsMessage.classList.add('hidden');

            const sortedRecords = [...records].sort((a, b) => {
                const timeA = a.timestamp.toDate().getTime();
                const timeB = b.timestamp.toDate().getTime();
                
                if (sortDirection === 'desc') {
                    return timeB - timeA; // 新到舊
                } else {
                    return timeA - timeB; // 舊到新
                }
            });

            // 執行查詢過濾
            const searchTerm = document.getElementById('search-input').value.toLowerCase().trim();
            const filteredRecords = sortedRecords.filter(record => {
                if (!searchTerm) return true;
                return (
                    record.deliveryLocation.toLowerCase().includes(searchTerm) ||
                    (record.collectionLocation && record.collectionLocation.toLowerCase().includes(searchTerm)) ||
                    record.plate.toLowerCase().includes(searchTerm) ||
                    record.notes.toLowerCase().includes(searchTerm) ||
                    (record.customerName && record.customerName.toLowerCase().includes(searchTerm)) ||
                    (record.customerPhone && record.customerPhone.toLowerCase().includes(searchTerm)) ||
                    record.etcId.toLowerCase().includes(searchTerm)
                );
            });


            filteredRecords.forEach(record => {
                const recordId = record.id; 
                const isCollectionScheduled = record.collectionDate !== null && record.collectionTime !== null;
                const isTimeLogged = record.collectionDate !== null;
                const isCompleted = record.endMileage !== null;
                
                let statusHTML, actionButton, actionMode;

                if (isCompleted) {
                    statusHTML = `<span class="px-2 py-0.5 rounded-full text-xs bg-green-100 text-green-700 font-semibold">已完成</span>`;
                    actionButton = `<span class="ml-2 px-3 py-1 text-xs font-semibold text-green-700">完成結算</span>`;
                } else if (isTimeLogged) {
                    // 待收車 (待登錄里程) - New vertical display
                    statusHTML = `
                        <div class="px-2 py-1 bg-orange-100 text-orange-700 font-bold rounded-lg text-center leading-tight">
                            <span class="text-sm">待收車</span><br>
                            <span class="text-xs font-normal">（待登錄里程）</span>
                        </div>
                    `;
                    actionMode = 'mileage';
                    actionButton = `<button onclick="window.openCollectionModal('${recordId}', '${actionMode}')" class="ml-2 px-3 py-1 text-xs font-semibold text-white bg-orange-600 rounded-lg hover:bg-orange-700 transition duration-150">登錄里程</button>`;
                } else {
                    statusHTML = `<span class="px-2 py-0.5 rounded-full text-xs bg-yellow-100 text-yellow-700 font-semibold">待收車</span>`;
                    actionMode = 'full';
                    actionButton = `<button onclick="window.openCollectionModal('${recordId}', '${actionMode}')" class="ml-2 px-3 py-1 text-xs font-semibold text-white bg-blue-600 rounded-lg hover:bg-blue-700 transition duration-150">收車</button>`;
                }

                // 1. 摘要行 (Summary Row)
                const summaryRow = document.createElement('tr');
                summaryRow.className = "cursor-pointer hover:bg-gray-50 transition duration-100 border-b border-gray-200";
                summaryRow.onclick = (e) => {
                    if (!e.target.closest('.action-cell')) {
                         window.toggleDetails(recordId);
                    }
                };
                
                // 渲染 4 個摘要欄位 + 1 個操作欄位
                summaryRow.innerHTML = `
                    <td class="px-1 py-3 whitespace-nowrap text-left">
                        ${statusHTML}
                    </td>
                    <td class="px-3 py-3 whitespace-nowrap text-sm text-gray-900">
                        <!-- 交車資訊 -->
                        ${record.deliveryDate} ${record.deliveryTime}
                        <!-- 新增收車資訊 -->
                        ${isCollectionScheduled ? 
                            `<br><span class="text-xs text-gray-500">
                                (收車 📥) ${record.collectionDate} ${record.collectionTime}
                            </span>` 
                            : ''}
                    </td>
                    <td class="px-3 py-3 text-sm text-gray-900">${record.deliveryLocation}</td>
                    
                    <!-- 展開/操作按鈕 -->
                    <td class="px-3 py-3 whitespace-nowrap text-center action-cell">
                        <div class="flex items-center justify-center space-x-2">
                            <span id="expand-icon-${recordId}" class="text-xl text-indigo-500 cursor-pointer">▼</span>
                            
                            <!-- 編輯按鈕 (New Addition) -->
                            <button onclick="window.openEditModal('${recordId}')" class="px-2 py-1 text-xs font-semibold text-gray-700 bg-yellow-300 rounded-lg hover:bg-yellow-400 transition duration-150">編輯</button>

                            <!-- 收車按鈕或完成標記 -->
                            ${actionButton}

                            <div class="delete-btn-container">
                                <button onclick="window.deleteLogRecord('${recordId}')" class="text-red-600 hover:text-red-900 transition duration-150">刪除</button>
                            </div>
                        </div>
                    </td>
                `;
                recordsTableBody.appendChild(summaryRow);


                // 2. 詳細資訊行 (Detail Row) - 預設隱藏
                const detailRow = document.createElement('tr');
                detailRow.id = `detail-row-${recordId}`;
                detailRow.className = "hidden bg-gray-100 border-b border-gray-300"; 
                
                // 處理客戶資訊顯示
                const customerInfo = (record.customerName || record.customerPhone || record.customerDob) ? `
                    <div class="space-y-1 sm:col-span-3 border-b pb-2 mb-2">
                        <p class="font-bold text-lg text-gray-800">客戶資訊</p>
                        <p><span class="font-medium text-gray-500">姓名:</span> ${record.customerName || '—'}</p>
                        <p><span class="font-medium text-gray-500">電話:</span> ${record.customerPhone || '—'}</p>
                        <p><span class="font-medium text-gray-500">生日:</span> ${record.customerDob || '—'}</p>
                    </div>
                ` : `<div class="sm:col-span-3 border-b pb-2 mb-2"><p class="font-bold text-lg text-gray-800">客戶資訊: 無記錄</p></div>`;


                // 詳細資訊欄位跨越 4 欄位
                detailRow.innerHTML = `
                    <td colspan="4" class="p-4"> 
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 text-sm text-gray-700 p-3 border border-gray-300 rounded-lg shadow-inner bg-white">
                            
                            <!-- 客戶資訊 -->
                            ${customerInfo}

                            <!-- 租賃週期概要 -->
                            <div class="space-y-1 sm:col-span-3 border-b pb-2 mb-2">
                                <p class="font-bold text-lg text-gray-800">車輛: ${record.plate} (${record.etcId || '—'})</p>
                            </div>

                            <!-- 交車資訊 -->
                            <div class="space-y-1 p-2 border rounded-lg bg-gray-50">
                                <p class="font-bold text-green-700">交車 (Delivery)</p>
                                <p><span class="font-medium text-gray-500">時間/地點:</span> ${record.deliveryDate} ${record.deliveryTime} / ${record.deliveryLocation}</p>
                                <p><span class="font-medium text-gray-500">起始里程:</span> <span class="font-bold text-indigo-600">${record.startMileage ? record.startMileage.toLocaleString() : '—'} Km</span></p>
                            </div>

                            <!-- 收車資訊 -->
                            <div class="space-y-1 p-2 border rounded-lg ${isCompleted ? 'bg-teal-50' : isTimeLogged ? 'bg-orange-50' : 'bg-red-50 sm:col-span-2'}">
                                <p class="font-bold ${isCompleted ? 'text-teal-700' : isTimeLogged ? 'text-orange-600' : 'text-red-600'}">收車 (Collection)</p>
                                ${isTimeLogged ? 
                                    `<p><span class="font-medium text-gray-500">預計/實際時間:</span> ${record.collectionDate} ${record.collectionTime} / ${record.collectionLocation}</p>` :
                                    `<p class="text-red-600 font-semibold">尚未記錄收車時間與地點。</p>`
                                }
                                ${isCompleted ? 
                                     `<p><span class="font-medium text-gray-500">結束里程:</span> <span class="font-bold text-indigo-600">${record.endMileage ? record.endMileage.toLocaleString() : '—'} Km</span></p>
                                     <p><span class="font-medium text-gray-500">總里程差:</span> <span class="font-bold text-pink-600">${(record.endMileage && record.startMileage) ? (record.endMileage - record.startMileage).toLocaleString() : '—'} Km</span></p>` : 
                                     (isTimeLogged ? 
                                        `<p class="text-orange-600 font-semibold">里程待登錄，週期尚未結算。</p>` : ''
                                     )
                                }
                            </div>

                            <!-- 備註 -->
                            <div class="space-y-1 sm:col-span-3">
                                <p class="font-medium text-gray-500 border-t pt-2 mt-2">交車備註</p>
                                <p class="text-gray-900 whitespace-pre-wrap">${record.notes || '無備註'}</p>
                            </div>
                        </div>
                    </td>
                `;
                recordsTableBody.appendChild(detailRow);
            });
        }

        /** 從 Firestore 監聽紀錄的實時更新 */
        function fetchRecords() {
            if (!db || !userId) return;

            const collectionRef = collection(db, getCollectionPath());
            
            // 使用 onSnapshot 實時監聽
            onSnapshot(collectionRef, (snapshot) => {
                const records = [];
                snapshot.forEach((doc) => {
                    records.push({ id: doc.id, ...doc.data() });
                });
                
                allRecords = records; // 更新全局紀錄列表
                renderRecords(allRecords);
                
                // === 防呆機制：過濾已租出的車輛 ===
                const unavailablePlates = getUnavailablePlates(allRecords);
                setupPlateEtcMapping(unavailablePlates);
                // ======================================
                
                updateScheduleTip(); // <-- Call the new function here
                
                console.log("資料已更新:", records.length, "筆紀錄");
            }, (error) => {
                console.error("監聽紀錄時發生錯誤:", error);
                displayMessage("載入紀錄失敗，請檢查權限。", 'error');
            });
        }
        
        // --- 事件監聽器 ---

        document.addEventListener('DOMContentLoaded', () => {
            initFirebase();
            
            // 設置 Datalist 選項 (New)
            setupDatalistOptions();

            // 設置車牌選單
            setupPlateEtcMapping([]); // 初始載入時沒有已租出車輛
            
            document.getElementById('record-form').addEventListener('submit', addRecord);
            
            window.deleteLogRecord = deleteLogRecord; 
            
            document.getElementById('search-input').addEventListener('input', () => renderRecords(allRecords));

            // 排序按鈕切換
            sortButton.addEventListener('click', () => {
                sortDirection = sortDirection === 'desc' ? 'asc' : 'desc';
                sortIcon.textContent = sortDirection === 'desc' ? '📅' : '📆';
                sortButton.innerHTML = `<span id="sort-icon">${sortIcon.textContent}</span> 排序: 由${sortDirection === 'desc' ? '新到舊' : '舊到新'}`;
                renderRecords(allRecords); // 重新渲染以應用新的排序
            });

            // 初始化日期輸入框為今天
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('record-date').value = today;
            
            // 初始化當前日期顯示 (New)
            const currentDateDisplay = document.getElementById('current-date-display');
            currentDateDisplay.textContent = new Date().toLocaleDateString('zh-TW', {
                year: 'numeric', month: 'long', day: 'numeric', weekday: 'short'
            });
        });

    </script>
</body>
</html>
