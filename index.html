<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç§Ÿè»Šäº¤è»Šç´€éŒ„ç³»çµ±</title>
    <!-- è¼‰å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ä½¿ç”¨ Inter å­—é«” */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }
        /* è‡ªå®šç¾©æ»¾å‹•æ¢æ¨£å¼ */
        .log-container::-webkit-scrollbar {
            height: 8px;
        }
        .log-container::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }
        .log-container::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
        /* äº¤è»Šå’Œæ”¶è»Šçš„é¡è‰²æ¨™è¨˜ */
        .delivery-color { background-color: #e0f2f1; color: #0f766e; } /* æ·ºé’ç¶  */
        .collection-color { background-color: #fef3c7; color: #a16207; } /* æ·ºé‡‘é»ƒ */
        /* æ¨¡æ…‹è¦–çª—èƒŒæ™¯ */
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.5);
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <!-- ä¸»å®¹å™¨ -->
    <div class="max-w-7xl mx-auto">
        <header class="mb-8 p-4 bg-white shadow-lg rounded-xl">
            <h1 class="3xl font-bold text-gray-800 mb-2">ç§Ÿè»Šäº¤è»Šç´€éŒ„æ§ç®¡ä¸­å¿ƒ</h1>
            <p class="text-gray-500">ä½¿ç”¨ Firestore å„²å­˜ç´€éŒ„ï¼Œè³‡æ–™å³æ™‚åŒæ­¥ã€‚ç•¶å‰ä½¿ç”¨è€… ID: <span id="user-id-display" class="font-mono text-xs bg-gray-100 p-1 rounded">è¼‰å…¥ä¸­...</span></p>
        </header>

        <!-- è¨Šæ¯/è¼‰å…¥æŒ‡ç¤ºå™¨ -->
        <div id="message-box" class="mb-6 p-3 rounded-lg text-sm transition-all duration-300 hidden"></div>

        <!-- æ–°å¢ç´€éŒ„è¡¨å–® (è¡Œå‹•è£ç½®ä¸Šç‚ºå–®æ¬„ï¼Œå¹³æ¿ä»¥ä¸Šç‚ºå¤šæ¬„) - åªç”¨æ–¼äº¤è»Š -->
        <div class="bg-white p-6 shadow-xl rounded-xl mb-10">
            <h2 class="text-xl font-semibold text-gray-700 mb-4 border-b pb-2">æ–°å¢ã€Œäº¤è»Šã€ç´€éŒ„ (é–‹å•Ÿæ–°ç§Ÿè³ƒé€±æœŸ)</h2>
            <form id="record-form" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                
                <!-- å‹•ä½œ (å›ºå®šç‚ºäº¤è»Š) -->
                <input type="hidden" id="record-action" value="äº¤è»Š">

                <!-- äº¤è»Šè³‡è¨Šå€å¡Š -->
                <div>
                    <label for="record-date" class="block text-sm font-medium text-gray-700">äº¤è»Šæ—¥æœŸ</label>
                    <input type="date" id="record-date" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border focus:border-indigo-500 focus:ring-indigo-500">
                </div>
                <div>
                    <label for="record-time" class="block text-sm font-medium text-gray-700">äº¤è»Šæ™‚é–“</label>
                    <input type="time" id="record-time" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border focus:border-indigo-500 focus:ring-indigo-500">
                </div>
                <div>
                    <label for="record-location" class="block text-sm font-medium text-gray-700">äº¤è»Šåœ°é» (è«‹é¸æ“‡)</label>
                    <select id="record-location" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border focus:border-indigo-500 focus:ring-indigo-500">
                    </select>
                </div>
                
                <!-- è»Šç‰Œ (åˆä½µé¡¯ç¤º ETC å¡è™Ÿ) -->
                <div>
                    <label for="record-plate" class="block text-sm font-medium text-gray-700">è»Šç‰Œ (ETC å¡è™Ÿ)</label>
                    <select id="record-plate" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border focus:border-indigo-500 focus:ring-indigo-500">
                        <option value="" disabled selected>è«‹é¸æ“‡è»Šç‰Œ (ETC å¡è™Ÿ)</option>
                    </select>
                </div>
                
                <!-- é‡Œç¨‹æ•¸ (äº¤è»Šæ™‚çš„èµ·å§‹é‡Œç¨‹) -->
                <div>
                    <label for="record-mileage" class="block text-sm font-medium text-gray-700">èµ·å§‹é‡Œç¨‹æ•¸ (Km)</label>
                    <input type="number" id="record-mileage" placeholder="ä¾‹å¦‚: 12500" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border focus:border-indigo-500 focus:ring-indigo-500">
                </div>

                <!-- éœ€æ±‚/å‚™è¨» -->
                <div class="md:col-span-2">
                    <label for="record-notes" class="block text-sm font-medium text-gray-700">éœ€æ±‚ / å‚™è¨» (äº¤è»Šè³‡è¨Š)</label>
                    <textarea id="record-notes" rows="2" placeholder="ä¾‹å¦‚: å…©å¼µå…’ç«¥åº§æ¤…(2æ­²è·Ÿ5æ­²)ï¼›è»Šå‹: Toyota 40ç³»" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border focus:border-indigo-500 focus:ring-indigo-500"></textarea>
                </div>
                
                <!-- å®¢æˆ¶è³‡æ–™å€å¡Š - å·²ç§»å‹•è‡³å‚™è¨»ä¸‹æ–¹ -->
                <div class="md:col-span-3 grid grid-cols-1 sm:grid-cols-3 gap-4 p-4 border rounded-lg bg-gray-50 mt-4">
                    <div class="sm:col-span-3 text-sm font-semibold text-gray-700 border-b pb-2 mb-2">å®¢æˆ¶è³‡æ–™ (é¸å¡«)</div>
                    <div>
                        <label for="customer-name" class="block text-sm font-medium text-gray-700">å®¢æˆ¶å§“å</label>
                        <input type="text" id="customer-name" placeholder="ä¾‹å¦‚: ç‹å°æ˜" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border focus:border-indigo-500 focus:ring-indigo-500">
                    </div>
                    <div>
                        <label for="customer-phone" class="block text-sm font-medium text-gray-700">è¯çµ¡é›»è©±</label>
                        <input type="tel" id="customer-phone" placeholder="ä¾‹å¦‚: 0912345678" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border focus:border-indigo-500 focus:ring-indigo-500">
                    </div>
                    <div>
                        <label for="customer-dob" class="block text-sm font-medium text-gray-700">å‡ºç”Ÿå¹´æœˆæ—¥</label>
                        <input type="date" id="customer-dob" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border focus:border-indigo-500 focus:ring-indigo-500">
                    </div>
                </div>

                <!-- æäº¤æŒ‰éˆ• -->
                <div class="md:col-span-3 flex justify-end">
                    <button type="submit" id="submit-button" class="mt-4 px-6 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition duration-150 disabled:bg-indigo-400">
                        æ–°å¢äº¤è»Šç´€éŒ„
                    </button>
                </div>
            </form>
        </div>

        <!-- ç´€éŒ„åˆ—è¡¨èˆ‡æŸ¥è©¢ -->
        <div class="bg-white p-6 shadow-xl rounded-xl">
            <h2 class="text-xl font-semibold text-gray-700 mb-4 border-b pb-2">æ‰€æœ‰ç§Ÿè³ƒé€±æœŸç´€éŒ„</h2>
            
            <!-- æŸ¥è©¢/æ’åºæ§åˆ¶é … -->
            <div class="flex flex-col sm:flex-row gap-4 mb-4">
                <input type="text" id="search-input" placeholder="æŸ¥è©¢ï¼šè¼¸å…¥åœ°é»ã€è»Šç‰Œã€å‚™è¨»é—œéµå­—" class="flex-grow p-2 border rounded-lg focus:border-indigo-500">
                <button id="sort-button" class="p-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition duration-150 flex-shrink-0">
                    <span id="sort-icon">ğŸ“…</span> æ’åº: ç”±æ–°åˆ°èˆŠ
                </button>
            </div>

            <!-- ç´€éŒ„è¡¨æ ¼å®¹å™¨ (æ¢å¾©éŸ¿æ‡‰å¼è¡¨æ ¼) -->
            <div class="log-container overflow-x-auto rounded-lg border border-gray-200">
                <table class="min-w-full divide-y divide-gray-200">
                    <!-- è¡¨æ ¼æ¨™é ­ï¼šç°¡æ½”é¡¯ç¤º (4 æ¬„ä½) -->
                    <thead class="bg-gray-50 sticky top-0">
                        <tr>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ç‹€æ…‹</th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">äº¤è»Šæ—¥æœŸ/æ™‚é–“</th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">åœ°é»</th>
                            <th class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">æ”¶è»Š/æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="records-table-body" class="bg-white divide-y divide-gray-200">
                        <!-- ç´€éŒ„å°‡æœƒå‹•æ…‹è¼‰å…¥æ­¤è™• -->
                    </tbody>
                </table>
                <p id="no-records-message" class="text-center py-10 text-gray-500 hidden">ç›®å‰æ²’æœ‰ä»»ä½•ç´€éŒ„ã€‚</p>
            </div>
        </div>

    </div>

    <!-- æ”¶è»Šæ¨¡æ…‹è¦–çª— (Collection Modal) -->
    <div id="collection-modal" class="fixed inset-0 z-50 hidden modal-backdrop flex items-center justify-center p-4" aria-modal="true" role="dialog">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg p-6 transform transition-all duration-300 scale-95 opacity-0" id="collection-modal-content">
            <h3 class="text-xl font-bold text-gray-800 border-b pb-3 mb-4" id="modal-title"></h3>
            
            <p class="text-sm text-gray-600 mb-4">æ­£åœ¨ç‚º <span id="modal-plate-display" class="font-bold text-indigo-600"></span> è¨˜éŒ„è³‡è¨Šã€‚</p>

            <form id="collection-form">
                <input type="hidden" id="modal-record-id">
                <input type="hidden" id="modal-mode"> <!-- éš±è—æ¬„ä½ç”¨æ–¼åˆ¤æ–·æ¨¡å¼ï¼š'full' æˆ– 'mileage' -->

                <div class="grid grid-cols-2 gap-4">
                    <!-- æ”¶è»Šæ—¥æœŸ -->
                    <div id="modal-date-container">
                        <label for="collection-date" class="block text-sm font-medium text-gray-700">æ”¶è»Šæ—¥æœŸ</label>
                        <input type="date" id="collection-date" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border focus:border-indigo-500 focus:ring-indigo-500">
                    </div>
                    <!-- æ”¶è»Šæ™‚é–“ -->
                    <div id="modal-time-container">
                        <label for="collection-time" class="block text-sm font-medium text-gray-700">æ”¶è»Šæ™‚é–“</label>
                        <input type="time" id="collection-time" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border focus:border-indigo-500 focus:ring-indigo-500">
                    </div>
                    <!-- æ”¶è»Šåœ°é» -->
                    <div class="col-span-2" id="modal-location-container">
                        <label for="collection-location" class="block text-sm font-medium text-gray-700">æ”¶è»Šåœ°é» (è«‹é¸æ“‡)</label>
                        <select id="collection-location" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border focus:border-indigo-500 focus:ring-indigo-500">
                        </select>
                    </div>
                    <!-- çµæŸé‡Œç¨‹æ•¸ -->
                    <div class="col-span-2" id="modal-mileage-container">
                        <label for="end-mileage" class="block text-sm font-medium text-gray-700">çµæŸé‡Œç¨‹æ•¸ (Km)</label>
                        <input type="number" id="end-mileage" placeholder="è«‹è¼¸å…¥æ”¶è»Šæ™‚é‡Œç¨‹æ•¸" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border focus:border-indigo-500 focus:ring-indigo-500">
                        <p class="text-xs text-gray-500 mt-1">äº¤è»Šé‡Œç¨‹æ•¸: <span id="modal-start-mileage"></span> Km</p>
                    </div>
                </div>

                <div class="flex justify-end space-x-3 mt-6">
                    <button type="button" onclick="window.closeCollectionModal()" class="px-4 py-2 text-gray-600 bg-gray-200 rounded-lg hover:bg-gray-300 transition duration-150">å–æ¶ˆ</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 transition duration-150" id="collection-submit-btn">
                        ç¢ºèªä¸¦å„²å­˜
                    </button>
                </div>
            </form>
        </div>
    </div>


    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, deleteDoc, doc, updateDoc, setLogLevel, Timestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // è¨­å®š Firebase Debug Log
        setLogLevel('Debug');

        // =================================================================
        // *** æ‚¨çš„ Firebase å°ˆæ¡ˆé…ç½®å·²æˆåŠŸè¼‰å…¥ï¼ ***
        // =================================================================
        const firebaseConfig = {
            apiKey: "AIzaSyAqksNR1a1Tf4OgL8X2ezT8u5rlFygNHPc",
            authDomain: "rentalcarlog-app.firebaseapp.com",
            projectId: "rentalcarlog-app",
            storageBucket: "rentalcarlog-app.firebasestorage.app",
            messagingSenderId: "68461236293",
            appId: "1:68461236293:web:2ab0179cc52585ab74932c",
            measurementId: "G-C7LWGH36JY"
        };
        const YOUR_PROJECT_ID = "rentalcarlog-app"; 
        // =================================================================

        // =================================================================
        // *** å›ºå®šè»Šç‰Œèˆ‡ ETC å¡è™Ÿå°æ‡‰è¡¨ (è»Šç‰Œä¸‹æ‹‰é¸å–®ç”¨) ***
        // =================================================================
        const CAR_ETC_MAPPING = {
            "ãªã«ã‚334ã‚8888 40ç³»": "9160 0000 1326 8609",
            "å’Œæ³‰330ã‚3333 7åº§ ä¸­æ–‡å°èˆª": "9160 0000 1326 6207",
            "æˆç”°331ã‚7777 ç¸½çµ±åº§": "9160 0000 1326 6009",
            "æˆç”°331ã‚88 4WD 8åº§": "9160 0000 1410 6501",
        };

        // =================================================================
        // *** åœ°é»é¸é …åˆ—è¡¨ (åœ°é»ä¸‹æ‹‰é¸å–®ç”¨) ***
        // =================================================================
        const LOCATION_OPTIONS = [
            "æˆç”°ç©ºæ¸¯T1",
            "æˆç”°ç©ºæ¸¯T2",
            "ç¾½ç”°ç©ºæ¸¯T3",
            "æ±äº¬"
        ];
        // =================================================================

        let app;
        let db;
        let auth;
        let userId = null;
        let isAuthReady = false;
        let allRecords = []; // å„²å­˜å¾ Firestore ç²å–çš„æ‰€æœ‰ç´€éŒ„
        let sortDirection = 'desc'; // 'desc' (æ–°åˆ°èˆŠ) æˆ– 'asc' (èˆŠåˆ°æ–°)

        const messageBox = document.getElementById('message-box');
        const recordsTableBody = document.getElementById('records-table-body');
        const noRecordsMessage = document.getElementById('no-records-message');
        const userIdDisplay = document.getElementById('user-id-display');
        const sortButton = document.getElementById('sort-button');
        const sortIcon = document.getElementById('sort-icon');
        const plateSelect = document.getElementById('record-plate');
        const locationSelect = document.getElementById('record-location'); // å–å¾—äº¤è»Šåœ°é» select å…ƒç´ 
        const collectionLocationSelect = document.getElementById('collection-location'); // å–å¾—æ”¶è»Šåœ°é» select å…ƒç´ 
        
        // æ–°å¢çš„å®¢æˆ¶è³‡æ–™è¼¸å…¥æ¬„ä½
        const customerNameInput = document.getElementById('customer-name');
        const customerPhoneInput = document.getElementById('customer-phone');
        const customerDobInput = document.getElementById('customer-dob');


        /** é¡¯ç¤ºæ‡‰ç”¨ç¨‹å¼è¨Šæ¯ */
        function displayMessage(text, type = 'info') {
            messageBox.textContent = text;
            messageBox.className = 'mb-6 p-3 rounded-lg text-sm transition-all duration-300';
            messageBox.classList.remove('hidden');

            switch (type) {
                case 'success':
                    messageBox.classList.add('bg-green-100', 'text-green-800');
                    break;
                case 'error':
                    messageBox.classList.add('bg-red-100', 'text-red-800');
                    break;
                case 'info':
                default:
                    messageBox.classList.add('bg-blue-100', 'text-blue-800');
                    break;
            }

            setTimeout(() => {
                messageBox.classList.add('hidden');
            }, 5000);
        }

        // --- Firebase åˆå§‹åŒ–å’Œèªè­‰ ---
        function initFirebase() {
            const submitButton = document.getElementById('submit-button'); // å–å¾—æŒ‰éˆ•å…ƒç´ 
            
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                // èªè­‰ç‹€æ…‹è®Šæ›´ç›£è½
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        userIdDisplay.textContent = userId;
                        isAuthReady = true;
                        submitButton.disabled = false; // èªè­‰æˆåŠŸï¼Œå•Ÿç”¨æŒ‰éˆ•
                        console.log("Firebase èªè­‰å®Œæˆï¼ŒUser ID:", userId);
                        fetchRecords(); // èªè­‰å®Œæˆå¾Œé–‹å§‹ç›£è½ç´€éŒ„
                    } else {
                        // é‹è¡Œåœ¨æœ¬åœ°ç’°å¢ƒï¼Œæˆ‘å€‘ä½¿ç”¨æ¨™æº–çš„åŒ¿åç™»å…¥
                        try {
                             await signInAnonymously(auth);
                        } catch (error) {
                            console.error("èªè­‰å¤±æ•—:", error);
                            displayMessage("èªè­‰å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ– Firebase å°ˆæ¡ˆè¨­å®šã€‚", 'error');
                            submitButton.disabled = true; // èªè­‰å¤±æ•—ï¼Œç¦ç”¨æŒ‰éˆ•
                            userIdDisplay.textContent = 'èªè­‰å¤±æ•— (é€£ç·šç•°å¸¸)'; 
                            isAuthReady = true; 
                        }
                    }
                });

            } catch (e) {
                console.error("Firebase åˆå§‹åŒ–å¤±æ•—:", e);
                displayMessage(`Firebase åˆå§‹åŒ–å¤±æ•—ã€‚éŒ¯èª¤è¨Šæ¯: ${e.message}ã€‚ç„¡æ³•å„²å­˜ç´€éŒ„ã€‚`, 'error'); 
                submitButton.disabled = true; // ç¦ç”¨æŒ‰éˆ•
                userIdDisplay.textContent = 'åˆå§‹åŒ–éŒ¯èª¤'; 
                isAuthReady = true;
            }
        }

        /** ç²å– Firestore Collection Path (å…±äº«è·¯å¾‘) */
        function getCollectionPath() {
            // å”ä½œè·¯å¾‘: æ‰€æœ‰ç™»å…¥çš„ä½¿ç”¨è€… (A & B) éƒ½å°‡å­˜å–æ­¤è·¯å¾‘
            const sharedAppId = 'd34356109-rental-log-app'; // å›ºå®šçš„æ‡‰ç”¨ç¨‹å¼è­˜åˆ¥ç¢¼
            const sharedCollectionName = 'rental_records_shared';
            
            return `artifacts/${sharedAppId}/public/data/${sharedCollectionName}`;
        }


        // --- è³‡æ–™æ“ä½œ (CRUD) ---

        /** æ–°å¢ç´€éŒ„åˆ° Firestore (åƒ…é™äº¤è»Š) */
        async function addRecord(event) {
            event.preventDefault();
            if (!db || !userId) {
                displayMessage("è³‡æ–™åº«é€£ç·šæˆ–ç”¨æˆ¶èªè­‰å¤±æ•—ï¼Œç„¡æ³•å„²å­˜ç´€éŒ„ã€‚è«‹æª¢æŸ¥è¨­å®šæˆ–é‡æ–°è¼‰å…¥ã€‚", 'error');
                return;
            }

            document.getElementById('submit-button').disabled = true;

            // å®¢æˆ¶è³‡æ–™ (é¸å¡«)
            const customerName = customerNameInput.value || '';
            const customerPhone = customerPhoneInput.value || '';
            const customerDob = customerDobInput.value || '';

            // äº¤è»Šè³‡è¨Š (å¿…å¡«)
            const date = document.getElementById('record-date').value;
            const time = document.getElementById('record-time').value;
            const action = document.getElementById('record-action').value; // å›ºå®šç‚º 'äº¤è»Š'
            const location = locationSelect.value;
            const plate = plateSelect.value; 
            
            const etcId = CAR_ETC_MAPPING[plate]; 
            
            const mileage = document.getElementById('record-mileage').value;
            const notes = document.getElementById('record-notes').value || '';

            if (!plate || !etcId) {
                displayMessage("è«‹é¸æ“‡è»Šç‰Œ (ETC å¡è™Ÿæœƒè‡ªå‹•å¾é¸å–®ä¸­å¸¶å…¥)ã€‚", 'error');
                document.getElementById('submit-button').disabled = false;
                return;
            }
            
            // æª¢æŸ¥è»Šç‰Œæ˜¯å¦è¢«ç¦ç”¨ (äºŒæ¬¡é˜²å‘†ï¼Œç¢ºä¿é¸å–®æœªè¢«ç¹é)
            const selectedOption = plateSelect.options[plateSelect.selectedIndex];
            if (selectedOption && selectedOption.disabled) {
                 displayMessage("æ‰€é¸è»Šç‰Œç›®å‰æ­£åœ¨ç§Ÿè³ƒé€±æœŸä¸­ï¼Œè«‹å…ˆå®Œæˆæ”¶è»Šå¾Œå†é€²è¡Œäº¤è»Šã€‚", 'error');
                 document.getElementById('submit-button').disabled = false;
                 return;
            }


            if (!location) {
                displayMessage("è«‹é¸æ“‡äº¤è»Šåœ°é»ã€‚", 'error');
                document.getElementById('submit-button').disabled = false;
                return;
            }

            const dateTimeString = `${date}T${time}:00`;
            const recordTime = new Date(dateTimeString);
            
            if (isNaN(recordTime)) {
                displayMessage("æ—¥æœŸæˆ–æ™‚é–“æ ¼å¼ç„¡æ•ˆã€‚", 'error');
                document.getElementById('submit-button').disabled = false;
                return;
            }

            const newRecord = {
                // å®¢æˆ¶è³‡æ–™
                customerName: customerName,
                customerPhone: customerPhone,
                customerDob: customerDob,

                // äº¤è»Šè³‡è¨Š
                action: action, // äº¤è»Š
                deliveryDate: date,
                deliveryTime: time,
                deliveryLocation: location,
                startMileage: parseInt(mileage, 10), // èµ·å§‹é‡Œç¨‹
                plate: plate,
                etcId: etcId,
                notes: notes,
                
                // æ”¶è»Šè³‡è¨Š (é è¨­ç‚ºç©ºï¼Œè¡¨ç¤ºé€±æœŸé–‹æ”¾)
                collectionDate: null,
                collectionTime: null,
                collectionLocation: null,
                endMileage: null,
                
                timestamp: Timestamp.fromDate(recordTime) // ä½¿ç”¨äº¤è»Šæ™‚é–“ä½œç‚ºä¸»è¦æ’åº
            };

            try {
                const collectionRef = collection(db, getCollectionPath());
                await addDoc(collectionRef, newRecord);
                displayMessage("äº¤è»Šç´€éŒ„å„²å­˜æˆåŠŸï¼é€±æœŸå·²é–‹å•Ÿã€‚", 'success');
                document.getElementById('record-form').reset();
                setupLocationMapping(); // é‡è¨­åœ°é»ä¸‹æ‹‰é¸å–®
            } catch (e) {
                console.error("æ–°å¢æ–‡ä»¶æ™‚ç™¼ç”ŸéŒ¯èª¤:", e);
                displayMessage(`å„²å­˜å¤±æ•—: ${e.message}`, 'error');
            } finally {
                document.getElementById('submit-button').disabled = false;
            }
        }

        /** æ›´æ–°ç´€éŒ„ (æ”¶è»Šæˆ–ç™»éŒ„é‡Œç¨‹) */
        async function submitCollectionUpdate(event) {
            event.preventDefault();
            if (!db || !userId) {
                displayMessage("è³‡æ–™åº«é€£ç·šæˆ–ç”¨æˆ¶èªè­‰å¤±æ•—ï¼Œç„¡æ³•å®Œæˆæ”¶è»Šã€‚", 'error');
                return;
            }

            const recordId = document.getElementById('modal-record-id').value;
            const mode = document.getElementById('modal-mode').value;
            
            const collectionDate = document.getElementById('collection-date').value;
            const collectionTime = document.getElementById('collection-time').value;
            const collectionLocation = collectionLocationSelect.value;
            const endMileageInput = document.getElementById('end-mileage').value;
            
            const updateData = {};
            const collectionSubmitBtn = document.getElementById('collection-submit-btn');

            // å–å¾—èµ·å§‹é‡Œç¨‹ (ç”¨æ–¼é‡Œç¨‹æª¢æŸ¥)
            const startMileageText = document.getElementById('modal-start-mileage').textContent.replace(/,/g, '').split(' ')[0]; // ç§»é™¤åƒä½åˆ†éš”ç¬¦å’Œ "Km"
            const startMileage = parseInt(startMileageText, 10);
            
            collectionSubmitBtn.disabled = true;

            if (mode === 'full') {
                // --- æ¨¡å¼ 1: è¨˜éŒ„æ™‚é–“/åœ°é» (é æ”¶è»Š) ---
                if (!collectionDate || !collectionTime || !collectionLocation) {
                    displayMessage("è«‹å¡«å¯«å®Œæ•´çš„æ”¶è»Šæ™‚é–“å’Œåœ°é»ã€‚", 'error');
                    collectionSubmitBtn.disabled = false;
                    return;
                }

                updateData.collectionDate = collectionDate;
                updateData.collectionTime = collectionTime;
                updateData.collectionLocation = collectionLocation;
                // endMileage ä»ç„¶ç‚º nullï¼Œä¿æŒã€Œå¾…ç™»éŒ„é‡Œç¨‹ã€ç‹€æ…‹
                
                // å¦‚æœç”¨æˆ¶åœ¨ 'full' æ¨¡å¼ä¸‹ä¹Ÿè¼¸å…¥äº†é‡Œç¨‹ï¼Œå‰‡ç›´æ¥å®Œæˆ
                if (endMileageInput) {
                    const endMileage = parseInt(endMileageInput, 10);
                    if (isNaN(endMileage) || endMileage < startMileage) {
                        displayMessage(`çµæŸé‡Œç¨‹æ•¸ç„¡æ•ˆæˆ–ä½æ–¼èµ·å§‹é‡Œç¨‹ (${startMileage.toLocaleString()} Km)ã€‚`, 'error');
                        collectionSubmitBtn.disabled = false;
                        return;
                    }
                    updateData.endMileage = endMileage;
                }

            } else if (mode === 'mileage') {
                // --- æ¨¡å¼ 2: ç™»éŒ„æœ€çµ‚é‡Œç¨‹ (çµç®—) ---
                const endMileage = parseInt(endMileageInput, 10);
                
                if (isNaN(endMileage)) {
                    displayMessage("è«‹è¼¸å…¥æœ‰æ•ˆçš„çµæŸé‡Œç¨‹æ•¸ã€‚", 'error');
                    collectionSubmitBtn.disabled = false;
                    return;
                }
                if (endMileage < startMileage) {
                     displayMessage(`æ”¶è»Šé‡Œç¨‹ (${endMileage.toLocaleString()} Km) ä¸å¾—ä½æ–¼äº¤è»Šé‡Œç¨‹ (${startMileage.toLocaleString()} Km)ã€‚`, 'error');
                     collectionSubmitBtn.disabled = false;
                     return;
                }
                
                updateData.endMileage = endMileage;
            }

            try {
                const docRef = doc(db, getCollectionPath(), recordId);
                await updateDoc(docRef, updateData);

                if (updateData.endMileage) {
                     displayMessage(`æ”¶è»Šç´€éŒ„å·²å®Œæˆï¼é‡Œç¨‹å·®: ${(updateData.endMileage - startMileage).toLocaleString()} Km`, 'success');
                } else {
                     displayMessage(`æ”¶è»Šæ™‚é–“/åœ°é»å·²è¨˜éŒ„ï¼Œå¾…ç™»éŒ„æœ€çµ‚é‡Œç¨‹ã€‚`, 'success');
                }
                
                window.closeCollectionModal();

            } catch (e) {
                console.error("æ›´æ–°æ”¶è»Šç´€éŒ„æ™‚ç™¼ç”ŸéŒ¯èª¤:", e);
                displayMessage(`å„²å­˜å¤±æ•—: ${e.message}`, 'error');
            } finally {
                collectionSubmitBtn.disabled = false;
            }
        }

        /** åˆªé™¤ç´€éŒ„ */
        async function deleteLogRecord(id) {
            // æª¢æŸ¥ Firebase æ˜¯å¦æˆåŠŸåˆå§‹åŒ– (dbå­˜åœ¨) ä¸”ç”¨æˆ¶å·²èªè­‰
            if (!db || !userId) {
                displayMessage("æ‡‰ç”¨ç¨‹å¼åˆå§‹åŒ–å¤±æ•—æˆ–èªè­‰æœªå®Œæˆï¼Œç„¡æ³•åŸ·è¡Œåˆªé™¤æ“ä½œã€‚", 'error');
                return;
            }
            
            const confirmation = confirm(`ç¢ºå®šè¦åˆªé™¤é€™ç­† ID ç‚º ${id.substring(0, 8)}... çš„å®Œæ•´é€±æœŸç´€éŒ„å—ï¼Ÿ`);
            if (!confirmation) return;

            try {
                const docRef = doc(db, getCollectionPath(), id);
                await deleteDoc(docRef);
                displayMessage("ç´€éŒ„å·²åˆªé™¤ã€‚", 'success');
            } catch (e) {
                console.error("åˆªé™¤æ–‡ä»¶æ™‚ç™¼ç”ŸéŒ¯èª¤:", e);
                displayMessage(`åˆªé™¤å¤±æ•—: ${e.message}`, 'error');
            }
        }
        
        // --- æ¨¡æ…‹è¦–çª—é‚è¼¯ ---
        function openCollectionModal(recordId, mode) {
            console.log(`Attempting to open modal for Record ID: ${recordId}, Mode: ${mode}`); // è¨ºæ–·æ—¥èªŒ
            // Debug Fix: Retrieve the record object from the global array using the ID
            const record = allRecords.find(r => r.id === recordId);
            if (!record) {
                console.error(`ERROR: Record ID ${recordId} not found in allRecords array. Data might be stale.`);
                displayMessage("éŒ¯èª¤: æ‰¾ä¸åˆ°è©²ç­†ç´€éŒ„è³‡æ–™ï¼Œè«‹é‡æ•´é é¢ã€‚", 'error');
                return;
            }
            
            const modal = document.getElementById('collection-modal');
            const modalContent = document.getElementById('collection-modal-content');
            
            const modalTitle = document.getElementById('modal-title');
            const modalModeInput = document.getElementById('modal-mode');
            const collectionSubmitBtn = document.getElementById('collection-submit-btn');

            // è¨­ç½®é€šç”¨å€¼
            document.getElementById('modal-record-id').value = recordId;
            document.getElementById('modal-plate-display').textContent = record.plate;
            document.getElementById('modal-start-mileage').textContent = record.startMileage ? record.startMileage.toLocaleString() : '0';
            modalModeInput.value = mode;

            // è¨­ç½®æ”¶è»Šåœ°é»é¸å–® (ä¾›å…©ç¨®æ¨¡å¼ä½¿ç”¨)
            setupCollectionLocationMapping();

            if (mode === 'mileage') {
                // --- æ¨¡å¼ 2: åƒ…ç™»éŒ„é‡Œç¨‹ ---
                modalTitle.textContent = 'ç™»éŒ„çµæŸé‡Œç¨‹æ•¸ (å®Œæˆçµç®—)';
                collectionSubmitBtn.textContent = 'ç¢ºèªç™»éŒ„ä¸¦å®Œæˆçµç®—';
                
                document.getElementById('modal-date-container').classList.add('hidden');
                document.getElementById('modal-time-container').classList.add('hidden');
                document.getElementById('modal-location-container').classList.add('hidden');
                document.getElementById('modal-mileage-container').classList.remove('col-span-2');
                document.getElementById('modal-mileage-container').classList.add('col-span-2');
                document.getElementById('end-mileage').required = true;

                // å¦‚æœå·²æœ‰æ”¶è»Šæ™‚é–“ï¼Œå‰‡åœ¨æ¨™é¡Œä¸‹æ–¹é¡¯ç¤º
                
            } else {
                // --- æ¨¡å¼ 1: è¨˜éŒ„æ”¶è»Šæ™‚é–“/åœ°é» (full) ---
                modalTitle.textContent = 'è¨˜éŒ„æ”¶è»Šæ™‚é–“èˆ‡åœ°é»';
                collectionSubmitBtn.textContent = 'ç¢ºèªä¸¦å„²å­˜æ”¶è»Šæ™‚é–“';

                document.getElementById('modal-date-container').classList.remove('hidden');
                document.getElementById('modal-time-container').classList.remove('hidden');
                document.getElementById('modal-location-container').classList.remove('hidden');
                document.getElementById('modal-mileage-container').classList.remove('col-span-2'); // é è¨­ä¸æ˜¯ä¸»è¦é …ç›®
                
                // çµæŸé‡Œç¨‹åœ¨åˆå§‹æ”¶è»Šéšæ®µè®Šç‚ºéå¿…å¡«
                document.getElementById('end-mileage').required = false; 
                
                // é è¨­æ—¥æœŸå’Œæ™‚é–“
                const today = new Date().toISOString().split('T')[0];
                const nowTime = new Date().toTimeString().split(' ')[0].substring(0, 5);
                document.getElementById('collection-date').value = record.collectionDate || today;
                document.getElementById('collection-time').value = record.collectionTime || nowTime;
            }

            // é¡¯ç¤ºæ¨¡æ…‹è¦–çª— (ä½¿ç”¨ Tailwind é¡åˆ¥å¯¦ç¾å‹•ç•«æ•ˆæœ)
            modal.classList.remove('hidden');
            setTimeout(() => {
                modalContent.classList.remove('scale-95', 'opacity-0');
                modalContent.classList.add('scale-100', 'opacity-100');
            }, 10);
        }

        function closeCollectionModal() {
            const modal = document.getElementById('collection-modal');
            const modalContent = document.getElementById('collection-modal-content');
            
            // éš±è—æ¨¡æ…‹è¦–çª—
            modalContent.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                modal.classList.add('hidden');
                document.getElementById('collection-form').reset();
            }, 300);
        }
        window.openCollectionModal = openCollectionModal;
        window.closeCollectionModal = closeCollectionModal;
        document.getElementById('collection-form').addEventListener('submit', submitCollectionUpdate);
        
        
        // --- è»Šè¼›é˜²å‘†é‚è¼¯ ---
        
        /** ç²å–ç›®å‰æ‰€æœ‰å°šæœªå®Œæˆçµç®— (endMileage === null) çš„è»Šç‰Œ */
        function getUnavailablePlates(records) {
            return records
                .filter(record => record.endMileage === null)
                .map(record => record.plate);
        }

        /** è¨­ç½®è»Šç‰Œå’Œ ETC å¡è™Ÿçš„å°æ‡‰é‚è¼¯ */
        function setupPlateEtcMapping(unavailablePlates = []) {
            plateSelect.innerHTML = '<option value="" disabled selected>è«‹é¸æ“‡è»Šç‰Œ (ETC å¡è™Ÿ)</option>'; 
            
            Object.keys(CAR_ETC_MAPPING).forEach(plateDescription => {
                const etcId = CAR_ETC_MAPPING[plateDescription];
                const option = document.createElement('option');
                option.value = plateDescription; 
                
                if (unavailablePlates.includes(plateDescription)) {
                    // è»Šè¼›å·²ç§Ÿå‡ºï¼Œç¦ç”¨é¸é …
                    option.textContent = `${plateDescription} (å·²ç§Ÿå‡º)`; 
                    option.disabled = true;
                } else {
                    // è»Šè¼›å¯é¸
                    option.textContent = `${plateDescription} (${etcId})`; 
                }
                
                plateSelect.appendChild(option);
            });
        }
        // --- END è»Šè¼›é˜²å‘†é‚è¼¯ ---


        /** è¨­ç½®äº¤è»Šåœ°é»é¸æ“‡å™¨ */
        function setupLocationMapping() {
            locationSelect.innerHTML = '<option value="" disabled selected>è«‹é¸æ“‡äº¤è»Šåœ°é»</option>'; 
            
            LOCATION_OPTIONS.forEach(location => {
                const option = document.createElement('option');
                option.value = location;
                option.textContent = location;
                locationSelect.appendChild(option);
            });
        }
        
        /** è¨­ç½®æ”¶è»Šåœ°é»é¸æ“‡å™¨ */
        function setupCollectionLocationMapping() {
            collectionLocationSelect.innerHTML = '<option value="" disabled selected>è«‹é¸æ“‡æ”¶è»Šåœ°é»</option>'; 
            
            LOCATION_OPTIONS.forEach(location => {
                const option = document.createElement('option');
                option.value = location;
                option.textContent = location;
                collectionLocationSelect.appendChild(option);
            });
        }
        
        /** é¡¯ç¤º/éš±è—è©³ç´°è³‡è¨Š */
        function toggleDetails(id) {
            const detailRow = document.getElementById(`detail-row-${id}`);
            const expandIcon = document.getElementById(`expand-icon-${id}`);
            if (detailRow) {
                const isHidden = detailRow.classList.toggle('hidden');
                if (expandIcon) {
                    expandIcon.textContent = isHidden ? 'â–¼' : 'â–²';
                }
            }
        }
        window.toggleDetails = toggleDetails;


        /** æ¸²æŸ“ç´€éŒ„åˆ—è¡¨ (é»æ“Šå±•é–‹æ¨¡å¼) */
        function renderRecords(records) {
            recordsTableBody.innerHTML = '';
            
            if (records.length === 0) {
                noRecordsMessage.classList.remove('hidden');
                return;
            }

            noRecordsMessage.classList.add('hidden');

            const sortedRecords = [...records].sort((a, b) => {
                const timeA = a.timestamp.toDate().getTime();
                const timeB = b.timestamp.toDate().getTime();
                
                if (sortDirection === 'desc') {
                    return timeB - timeA; // æ–°åˆ°èˆŠ
                } else {
                    return timeA - timeB; // èˆŠåˆ°æ–°
                }
            });

            // åŸ·è¡ŒæŸ¥è©¢éæ¿¾
            const searchTerm = document.getElementById('search-input').value.toLowerCase().trim();
            const filteredRecords = sortedRecords.filter(record => {
                if (!searchTerm) return true;
                return (
                    record.deliveryLocation.toLowerCase().includes(searchTerm) ||
                    (record.collectionLocation && record.collectionLocation.toLowerCase().includes(searchTerm)) ||
                    record.plate.toLowerCase().includes(searchTerm) ||
                    record.notes.toLowerCase().includes(searchTerm) ||
                    (record.customerName && record.customerName.toLowerCase().includes(searchTerm)) ||
                    (record.customerPhone && record.customerPhone.toLowerCase().includes(searchTerm)) ||
                    record.etcId.toLowerCase().includes(searchTerm)
                );
            });


            filteredRecords.forEach(record => {
                const recordId = record.id; 
                const isTimeLogged = record.collectionDate !== null;
                const isCompleted = record.endMileage !== null;
                
                let statusText, statusColor, actionButton, actionMode;

                if (isCompleted) {
                    statusText = 'å·²å®Œæˆ';
                    statusColor = 'bg-green-100 text-green-700';
                    actionButton = `<span class="ml-2 px-3 py-1 text-xs font-semibold text-green-700">å®Œæˆçµç®—</span>`;
                } else if (isTimeLogged) {
                    statusText = 'å¾…ç™»éŒ„é‡Œç¨‹';
                    statusColor = 'bg-orange-100 text-orange-700 font-bold';
                    actionMode = 'mileage';
                    actionButton = `<button onclick="window.openCollectionModal('${recordId}', '${actionMode}')" class="ml-2 px-3 py-1 text-xs font-semibold text-white bg-orange-600 rounded-lg hover:bg-orange-700 transition duration-150">ç™»éŒ„é‡Œç¨‹</button>`;
                } else {
                    statusText = 'å¾…æ”¶è»Š';
                    statusColor = 'bg-yellow-100 text-yellow-700 font-bold';
                    actionMode = 'full';
                    actionButton = `<button onclick="window.openCollectionModal('${recordId}', '${actionMode}')" class="ml-2 px-3 py-1 text-xs font-semibold text-white bg-blue-600 rounded-lg hover:bg-blue-700 transition duration-150">æ”¶è»Š</button>`;
                }

                // 1. æ‘˜è¦è¡Œ (Summary Row)
                const summaryRow = document.createElement('tr');
                summaryRow.className = "cursor-pointer hover:bg-gray-50 transition duration-100 border-b border-gray-200";
                summaryRow.onclick = (e) => {
                    if (!e.target.closest('.action-cell')) {
                         window.toggleDetails(recordId);
                    }
                };
                
                // æ¸²æŸ“ 4 å€‹æ‘˜è¦æ¬„ä½ + 1 å€‹æ“ä½œæ¬„ä½
                summaryRow.innerHTML = `
                    <td class="px-3 py-3 whitespace-nowrap text-sm font-semibold">
                        <span class="px-2 py-0.5 rounded-full text-xs ${statusColor}">${statusText}</span>
                    </td>
                    <td class="px-3 py-3 whitespace-nowrap text-sm text-gray-900">${record.deliveryDate} ${record.deliveryTime}</td>
                    <td class="px-3 py-3 text-sm text-gray-900">${record.deliveryLocation}</td>
                    
                    <!-- å±•é–‹/æ“ä½œæŒ‰éˆ• -->
                    <td class="px-3 py-3 whitespace-nowrap text-center action-cell">
                        <div class="flex items-center justify-center space-x-3">
                            <span id="expand-icon-${recordId}" class="text-xl text-indigo-500 cursor-pointer">â–¼</span>
                            
                            <!-- æ”¶è»ŠæŒ‰éˆ•æˆ–å®Œæˆæ¨™è¨˜ -->
                            ${actionButton}

                            <div class="delete-btn-container">
                                <button onclick="window.deleteLogRecord('${recordId}')" class="text-red-600 hover:text-red-900 transition duration-150">åˆªé™¤</button>
                            </div>
                        </div>
                    </td>
                `;
                recordsTableBody.appendChild(summaryRow);


                // 2. è©³ç´°è³‡è¨Šè¡Œ (Detail Row) - é è¨­éš±è—
                const detailRow = document.createElement('tr');
                detailRow.id = `detail-row-${recordId}`;
                detailRow.className = "hidden bg-gray-100 border-b border-gray-300"; 
                
                // è™•ç†å®¢æˆ¶è³‡è¨Šé¡¯ç¤º
                const customerInfo = (record.customerName || record.customerPhone || record.customerDob) ? `
                    <div class="space-y-1 sm:col-span-3 border-b pb-2 mb-2">
                        <p class="font-bold text-lg text-gray-800">å®¢æˆ¶è³‡è¨Š</p>
                        <p><span class="font-medium text-gray-500">å§“å:</span> ${record.customerName || 'â€”'}</p>
                        <p><span class="font-medium text-gray-500">é›»è©±:</span> ${record.customerPhone || 'â€”'}</p>
                        <p><span class="font-medium text-gray-500">ç”Ÿæ—¥:</span> ${record.customerDob || 'â€”'}</p>
                    </div>
                ` : `<div class="sm:col-span-3 border-b pb-2 mb-2"><p class="font-bold text-lg text-gray-800">å®¢æˆ¶è³‡è¨Š: ç„¡è¨˜éŒ„</p></div>`;


                // è©³ç´°è³‡è¨Šæ¬„ä½è·¨è¶Š 4 æ¬„ä½
                detailRow.innerHTML = `
                    <td colspan="4" class="p-4"> 
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 text-sm text-gray-700 p-3 border border-gray-300 rounded-lg shadow-inner bg-white">
                            
                            <!-- å®¢æˆ¶è³‡è¨Š -->
                            ${customerInfo}

                            <!-- ç§Ÿè³ƒé€±æœŸæ¦‚è¦ -->
                            <div class="space-y-1 sm:col-span-3 border-b pb-2 mb-2">
                                <p class="font-bold text-lg text-gray-800">è»Šè¼›: ${record.plate} (${record.etcId || 'â€”'})</p>
                            </div>

                            <!-- äº¤è»Šè³‡è¨Š -->
                            <div class="space-y-1 p-2 border rounded-lg bg-gray-50">
                                <p class="font-bold text-green-700">äº¤è»Š (Delivery)</p>
                                <p><span class="font-medium text-gray-500">æ™‚é–“/åœ°é»:</span> ${record.deliveryDate} ${record.deliveryTime} / ${record.deliveryLocation}</p>
                                <p><span class="font-medium text-gray-500">èµ·å§‹é‡Œç¨‹:</span> <span class="font-bold text-indigo-600">${record.startMileage ? record.startMileage.toLocaleString() : 'â€”'} Km</span></p>
                            </div>

                            <!-- æ”¶è»Šè³‡è¨Š -->
                            <div class="space-y-1 p-2 border rounded-lg ${isCompleted ? 'bg-teal-50' : isTimeLogged ? 'bg-orange-50' : 'bg-red-50 sm:col-span-2'}">
                                <p class="font-bold ${isCompleted ? 'text-teal-700' : isTimeLogged ? 'text-orange-600' : 'text-red-600'}">æ”¶è»Š (Collection)</p>
                                ${isTimeLogged ? 
                                    `<p><span class="font-medium text-gray-500">é è¨ˆ/å¯¦éš›æ™‚é–“:</span> ${record.collectionDate} ${record.collectionTime} / ${record.collectionLocation}</p>` :
                                    `<p class="text-red-600 font-semibold">å°šæœªè¨˜éŒ„æ”¶è»Šæ™‚é–“èˆ‡åœ°é»ã€‚</p>`
                                }
                                ${isCompleted ? 
                                     `<p><span class="font-medium text-gray-500">çµæŸé‡Œç¨‹:</span> <span class="font-bold text-indigo-600">${record.endMileage ? record.endMileage.toLocaleString() : 'â€”'} Km</span></p>
                                     <p><span class="font-medium text-gray-500">ç¸½é‡Œç¨‹å·®:</span> <span class="font-bold text-pink-600">${(record.endMileage && record.startMileage) ? (record.endMileage - record.startMileage).toLocaleString() : 'â€”'} Km</span></p>` : 
                                     (isTimeLogged ? 
                                        `<p class="text-orange-600 font-semibold">é‡Œç¨‹å¾…ç™»éŒ„ï¼Œé€±æœŸå°šæœªçµç®—ã€‚</p>` : ''
                                     )
                                }
                            </div>

                            <!-- å‚™è¨» -->
                            <div class="space-y-1 sm:col-span-3">
                                <p class="font-medium text-gray-500 border-t pt-2 mt-2">äº¤è»Šå‚™è¨»</p>
                                <p class="text-gray-900 whitespace-pre-wrap">${record.notes || 'ç„¡å‚™è¨»'}</p>
                            </div>
                        </div>
                    </td>
                `;
                recordsTableBody.appendChild(detailRow);
            });
        }

        /** å¾ Firestore ç›£è½ç´€éŒ„çš„å¯¦æ™‚æ›´æ–° */
        function fetchRecords() {
            if (!db || !userId) return;

            const collectionRef = collection(db, getCollectionPath());
            
            // ä½¿ç”¨ onSnapshot å¯¦æ™‚ç›£è½
            onSnapshot(collectionRef, (snapshot) => {
                const records = [];
                snapshot.forEach((doc) => {
                    records.push({ id: doc.id, ...doc.data() });
                });
                
                allRecords = records; // æ›´æ–°å…¨å±€ç´€éŒ„åˆ—è¡¨
                renderRecords(allRecords);
                
                // === é˜²å‘†æ©Ÿåˆ¶ï¼šéæ¿¾å·²ç§Ÿå‡ºçš„è»Šè¼› ===
                const unavailablePlates = getUnavailablePlates(allRecords);
                setupPlateEtcMapping(unavailablePlates);
                // ======================================
                
                console.log("è³‡æ–™å·²æ›´æ–°:", records.length, "ç­†ç´€éŒ„");
            }, (error) => {
                console.error("ç›£è½ç´€éŒ„æ™‚ç™¼ç”ŸéŒ¯èª¤:", error);
                displayMessage("è¼‰å…¥ç´€éŒ„å¤±æ•—ï¼Œè«‹æª¢æŸ¥æ¬Šé™ã€‚", 'error');
            });
        }
        
        // --- äº‹ä»¶ç›£è½å™¨ ---

        document.addEventListener('DOMContentLoaded', () => {
            initFirebase();
            
            // è¨­ç½®æ‰€æœ‰åœ°é»é¸æ“‡å™¨
            setupLocationMapping();
            setupPlateEtcMapping([]); // åˆå§‹è¼‰å…¥æ™‚æ²’æœ‰å·²ç§Ÿå‡ºè»Šè¼›
            
            document.getElementById('record-form').addEventListener('submit', addRecord);
            
            window.deleteLogRecord = deleteLogRecord; 
            
            document.getElementById('search-input').addEventListener('input', () => renderRecords(allRecords));

            // æ’åºæŒ‰éˆ•åˆ‡æ›
            sortButton.addEventListener('click', () => {
                sortDirection = sortDirection === 'desc' ? 'asc' : 'desc';
                sortIcon.textContent = sortDirection === 'desc' ? 'ğŸ“…' : 'ğŸ“†';
                sortButton.innerHTML = `<span id="sort-icon">${sortIcon.textContent}</span> æ’åº: ç”±${sortDirection === 'desc' ? 'æ–°åˆ°èˆŠ' : 'èˆŠåˆ°æ–°'}`;
                renderRecords(allRecords); // é‡æ–°æ¸²æŸ“ä»¥æ‡‰ç”¨æ–°çš„æ’åº
            });

            // åˆå§‹åŒ–æ—¥æœŸè¼¸å…¥æ¡†ç‚ºä»Šå¤©
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('record-date').value = today;
        });

    </script>
</body>
</html>
